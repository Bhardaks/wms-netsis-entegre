<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>SSH Servis Talep</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/auth-new.js"></script>
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS Yönetim Sistemi</h1>
    <span class="header-subtitle">SSH Servis Talep</span>
  </div>
  <div class="header-actions">
    <a href="/index.html" class="home-btn">
      <span class="home-icon">🏠</span>
      <span class="home-text">Ana Sayfa</span>
    </a>
  </div>
</header>

<main class="grid" style="max-width:800px;margin:auto;padding:16px">

  <!-- Servis Talep Formu -->
  <section class="card">
    <div class="form-header">
      <h2>🔧 Yeni Servis Talebi</h2>
      <p class="form-description">Kusurlu ürün için servis talebini sisteme kaydedin</p>
    </div>

    <form id="serviceRequestForm" class="service-form">
      <!-- Müşteri Bilgileri -->
      <div class="form-section">
        <h3>👤 Müşteri Bilgileri</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="customerName">Müşteri Adı</label>
            <input type="text" id="customerName" name="customerName" required>
          </div>
          <div class="form-group">
            <label for="customerPhone">Telefon</label>
            <input type="tel" id="customerPhone" name="customerPhone">
          </div>
          <div class="form-group">
            <label for="customerEmail">E-posta</label>
            <input type="email" id="customerEmail" name="customerEmail">
          </div>
          <div class="form-group">
            <label for="orderNumber">Sipariş No</label>
            <input type="text" id="orderNumber" name="orderNumber">
          </div>
        </div>
      </div>

      <!-- Ürün Bilgileri -->
      <div class="form-section">
        <h3>📦 Ürün Bilgileri</h3>
        <div class="form-grid">
          <div class="form-group">
            <label for="productSku">Ürün SKU</label>
            <input type="text" id="productSku" name="productSku" placeholder="Ürün SKU'sunu girin" required>
            <button type="button" id="searchSkuBtn" class="scan-btn">🔍 SKU Ara</button>
          </div>
          <div class="form-group">
            <label for="productName">Ürün Adı</label>
            <input type="text" id="productName" name="productName" readonly>
          </div>
        </div>
        
        <!-- Paket Seçim Alanı -->
        <div class="package-selection" id="packageSelection" style="display:none">
          <h4>📋 Paket Seçimi</h4>
          <p class="selection-description">Bu ürün için mevcut paketler:</p>
          <div class="package-grid" id="packageGrid">
            <!-- Paketler burada listelenecek -->
          </div>
          <div class="selected-package" id="selectedPackage" style="display:none">
            <h5>✅ Seçilen Paket:</h5>
            <div class="package-info" id="selectedPackageInfo">
              <!-- Seçilen paket bilgileri -->
            </div>
          </div>
        </div>
      </div>

      <!-- Sorun Detayları -->
      <div class="form-section">
        <h3>🚨 Sorun Detayları</h3>
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="issueDescription">Sorun Açıklaması</label>
            <textarea id="issueDescription" name="issueDescription" rows="3" 
                      placeholder="Kusurlu ürünün sorunu detaylı olarak açıklayın..." required></textarea>
          </div>
          <div class="form-group">
            <label for="requiredPart">Gerekli Parça</label>
            <input type="text" id="requiredPart" name="requiredPart" 
                   placeholder="Değiştirilecek parça adı" required>
          </div>
          
          <div class="form-group">
            <label for="requiredQuantity">Gerekli Miktar</label>
            <input type="number" id="requiredQuantity" name="requiredQuantity" 
                   placeholder="Kaç adet gerekli?" min="1" value="1" required>
          </div>
          <div class="form-group">
            <label for="priority">Öncelik</label>
            <select id="priority" name="priority" required>
              <option value="">Seçiniz</option>
              <option value="urgent">🔴 Acil</option>
              <option value="high">🟡 Yüksek</option>
              <option value="normal">🟢 Normal</option>
              <option value="low">🔵 Düşük</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          ✅ Servis Talebi Oluştur
        </button>
        <button type="reset" class="btn btn-secondary">
          🗑️ Temizle
        </button>
      </div>
    </form>
  </section>


</main>

<script>
// Form Elements
const serviceForm = document.getElementById('serviceRequestForm');
const productSkuInput = document.getElementById('productSku');
const searchSkuBtn = document.getElementById('searchSkuBtn');
const productNameInput = document.getElementById('productName');
const packageSelection = document.getElementById('packageSelection');
const packageGrid = document.getElementById('packageGrid');
const selectedPackage = document.getElementById('selectedPackage');
const selectedPackageInfo = document.getElementById('selectedPackageInfo');
const recentRequests = document.getElementById('recentRequests');

// Current state
let currentProduct = null;
let availablePackages = [];
let selectedPackageData = null;

// Page Load
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔧 SSH Servis Talep sayfası yüklendi');
    
    
    // Setup event listeners
    setupEventListeners();
    
    // Load recent requests
    loadRecentRequests();
    
    // Focus on customer name
    document.getElementById('customerName').focus();
});


function setupEventListeners() {
    // SKU search
    productSkuInput.addEventListener('keypress', handleSkuInput);
    searchSkuBtn.addEventListener('click', () => {
        const sku = productSkuInput.value.trim();
        if (sku) {
            searchProductBySku(sku);
        }
    });
    
    // Form submission
    serviceForm.addEventListener('submit', handleFormSubmit);
    
    // Form reset
    serviceForm.addEventListener('reset', handleFormReset);
}

// SKU Search Processing
async function handleSkuInput(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        const sku = e.target.value.trim();
        if (sku) {
            await searchProductBySku(sku);
        }
    }
}

async function searchProductBySku(sku) {
    try {
        console.log('🔍 SKU aranıyor:', sku);
        
        // Show loading state
        productNameInput.value = 'Aranıyor...';
        packageSelection.style.display = 'none';
        selectedPackage.style.display = 'none';
        
        // Fetch all products and search by SKU (temporary solution)
        const response = await fetch('/api/products');
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error('Ürünler yüklenemedi');
        }
        
        // Find product by SKU
        const foundProduct = data.find(product => product.sku === sku);
        
        if (!foundProduct) {
            throw new Error('Bu SKU ile ürün bulunamadı');
        }
        
        currentProduct = foundProduct;
        console.log('📦 Bulunan ürün:', currentProduct);
        
        // Fill product name
        productNameInput.value = currentProduct.name || '';
        
        // Use packages from product data
        availablePackages = currentProduct.packages || [];
        
        if (availablePackages.length === 0) {
            throw new Error('Bu ürün için paket bulunamadı');
        }
        
        // Show package selection
        displayPackageOptions();
        
        // Show success feedback
        productSkuInput.style.borderColor = '#4caf50';
        setTimeout(() => {
            productSkuInput.style.borderColor = '';
        }, 2000);
        
    } catch (error) {
        console.error('❌ SKU arama hatası:', error);
        
        // Clear fields and show error
        productNameInput.value = '';
        packageSelection.style.display = 'none';
        selectedPackage.style.display = 'none';
        
        // Show error feedback
        productSkuInput.style.borderColor = '#f44336';
        setTimeout(() => {
            productSkuInput.style.borderColor = '';
        }, 3000);
        
        alert(`SKU bulunamadı: ${error.message}`);
    }
}

async function loadPackagesForProduct(productId) {
    try {
        console.log('📋 Paketler yükleniyor, product_id:', productId);
        
        // Fetch packages for this product
        const response = await fetch(`/api/products/${productId}/packages`);
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Paketler yüklenemedi');
        }
        
        availablePackages = data.packages || [];
        console.log('📦 Bulunan paketler:', availablePackages);
        
        if (availablePackages.length === 0) {
            throw new Error('Bu ürün için paket bulunamadı');
        }
        
        // Show package selection
        displayPackageOptions();
        
    } catch (error) {
        console.error('❌ Paket yükleme hatası:', error);
        alert(`Paket bilgileri yüklenemedi: ${error.message}`);
    }
}

function displayPackageOptions() {
    packageGrid.innerHTML = availablePackages.map((pkg, index) => `
        <div class="package-option" data-package-index="${index}" onclick="selectPackage(${index})">
            <div class="package-header">
                <h5>${pkg.package_number}</h5>
                <span class="package-barcode">📋 ${pkg.barcode}</span>
            </div>
            <div class="package-details">
                <div class="package-meta">
                    <span class="package-size">📏 ${pkg.dimensions || 'Boyut belirtilmemiş'}</span>
                    <span class="package-weight">⚖️ ${pkg.weight || '-'} kg</span>
                    ${pkg.shelf_code ? `<span class="package-location">📍 ${pkg.shelf_code}</span>` : ''}
                </div>
                <div class="package-description">
                    <strong>İçerik:</strong> ${pkg.package_content || pkg.package_name || 'Açıklama yok'}
                </div>
            </div>
        </div>
    `).join('');
    
    packageSelection.style.display = 'block';
}

function selectPackage(packageIndex) {
    const selectedPkg = availablePackages[packageIndex];
    selectedPackageData = selectedPkg;
    
    console.log('✅ Paket seçildi:', selectedPkg);
    
    // Highlight selected package
    document.querySelectorAll('.package-option').forEach(opt => opt.classList.remove('selected'));
    document.querySelector(`[data-package-index="${packageIndex}"]`).classList.add('selected');
    
    // Show selected package info
    selectedPackageInfo.innerHTML = `
        <div class="selected-package-card">
            <h6>${selectedPkg.package_name}</h6>
            <div class="selected-package-details">
                <span><strong>Barkod:</strong> ${selectedPkg.barcode}</span>
                <span><strong>Boyut:</strong> ${selectedPkg.dimensions || '-'}</span>
                <span><strong>Ağırlık:</strong> ${selectedPkg.weight || '-'} kg</span>
                ${selectedPkg.shelf_code ? `<span><strong>Lokasyon:</strong> ${selectedPkg.shelf_code}</span>` : ''}
            </div>
            <div class="selected-package-description">
                <strong>İçerik:</strong> ${selectedPkg.package_content || selectedPkg.package_name || 'Açıklama yok'}
            </div>
        </div>
    `;
    
    selectedPackage.style.display = 'block';
}

// Make selectPackage globally accessible
window.selectPackage = selectPackage;

// Form Submission
async function handleFormSubmit(e) {
    e.preventDefault();
    
    // Validation
    if (!selectedPackageData) {
        alert('Lütfen önce bir paket seçin');
        return;
    }
    
    try {
        const formData = new FormData(serviceForm);
        const serviceRequest = {
            customer_name: formData.get('customerName'),
            customer_phone: formData.get('customerPhone'),
            customer_email: formData.get('customerEmail'),
            order_number: formData.get('orderNumber'),
            product_id: currentProduct.id,
            product_name: currentProduct.name,
            product_sku: currentProduct.sku,
            package_id: selectedPackageData.id,
            package_name: selectedPackageData.package_name,
            package_barcode: selectedPackageData.barcode,
            issue_description: formData.get('issueDescription'),
            required_part: formData.get('requiredPart'),
            required_quantity: parseInt(formData.get('requiredQuantity')) || 1,
            priority: formData.get('priority'),
            status: 'new',
            created_date: new Date().toISOString()
        };
        
        console.log('📝 Servis talebi oluşturuluyor:', serviceRequest);
        
        // Show loading state
        const submitBtn = serviceForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '⏳ Kaydediliyor...';
        submitBtn.disabled = true;
        
        // Send to API (simulated for now)
        const response = await fetch('/api/service-requests', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(serviceRequest)
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('✅ Servis talebi oluşturuldu:', result);
            
            // Show success message
            alert(`Servis talebi başarıyla oluşturuldu!\nTalep No: ${result.id || 'SSH-' + Date.now()}`);
            
            // Reset form
            serviceForm.reset();
            handleFormReset();
            
            // Reload recent requests
            loadRecentRequests();
            
        } else {
            throw new Error('Servis talebi oluşturulamadı');
        }
        
        // Restore button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
    } catch (error) {
        console.error('❌ Form gönderme hatası:', error);
        alert(`Hata: ${error.message}`);
        
        // Restore button
        const submitBtn = serviceForm.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '✅ Servis Talebi Oluştur';
        submitBtn.disabled = false;
    }
}

function handleFormReset() {
    // Clear readonly fields
    productNameInput.value = '';
    productSkuInput.value = '';
    
    // Reset styles
    const productBarcodeInput = document.getElementById('productBarcode');
    if (productBarcodeInput) {
        productBarcodeInput.style.borderColor = '';
    }
    
    // Focus on customer name
    setTimeout(() => {
        document.getElementById('customerName').focus();
    }, 100);
}

// Load Recent Requests
async function loadRecentRequests() {
    try {
        // For now, show static data - will be replaced with API call
        const staticRequests = [
            {
                id: 'SSH-001',
                customer_name: 'Ahmet Yılmaz',
                product_name: 'Ares Gardırop',
                required_part: 'Menteşe',
                priority: 'urgent',
                status: 'new',
                created_date: new Date().toLocaleDateString('tr-TR')
            }
        ];
        
        displayRecentRequests(staticRequests);
        
    } catch (error) {
        console.error('Son talepler yüklenemedi:', error);
        recentRequests.innerHTML = '<div class="request-item error">Son talepler yüklenemedi</div>';
    }
}

function displayRecentRequests(requests) {
    if (requests.length === 0) {
        recentRequests.innerHTML = '<div class="request-item"><em>Henüz servis talebi bulunmuyor...</em></div>';
        return;
    }
    
    recentRequests.innerHTML = requests.map(request => `
        <div class="request-item">
            <div class="request-header">
                <span class="request-id">Talep: ${request.id}</span>
                <span class="request-priority priority-${request.priority}">
                    ${getPriorityIcon(request.priority)} ${getPriorityText(request.priority)}
                </span>
            </div>
            <div class="request-details">
                <strong>${request.customer_name}</strong> - ${request.product_name}<br>
                <small>Gerekli Parça: ${request.required_part} • Durum: ${getStatusText(request.status)} • ${request.created_date}</small>
            </div>
        </div>
    `).join('');
}

function getPriorityIcon(priority) {
    const icons = {
        urgent: '🔴',
        high: '🟡', 
        normal: '🟢',
        low: '🔵'
    };
    return icons[priority] || '⚪';
}

function getPriorityText(priority) {
    const texts = {
        urgent: 'Acil',
        high: 'Yüksek',
        normal: 'Normal', 
        low: 'Düşük'
    };
    return texts[priority] || 'Belirsiz';
}

function getStatusText(status) {
    const texts = {
        new: 'Yeni',
        processing: 'İşlemde',
        waiting_parts: 'Parça Bekliyor',
        completed: 'Tamamlandı',
        cancelled: 'İptal'
    };
    return texts[status] || status;
}

</script>

<style>
.service-form {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.form-section {
    padding: 20px;
    background: rgba(31, 42, 68, 0.05);
    border-radius: 8px;
    border-left: 4px solid var(--accent);
}

.form-section h3 {
    margin-bottom: 16px;
    color: var(--accent);
    font-size: 1.1em;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    font-weight: 500;
    color: var(--accent);
    font-size: 0.9em;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px;
    border: 2px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--fg);
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    border-color: var(--accent);
    outline: none;
    box-shadow: 0 0 8px rgba(59, 130, 246, 0.2);
}

.form-group input[readonly] {
    background: rgba(31, 42, 68, 0.1);
    color: var(--muted);
}

.barcode-input {
    font-family: 'Courier New', monospace;
    text-align: center;
}

.scan-btn {
    margin-top: 8px;
    padding: 8px 12px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.scan-btn:hover {
    background: var(--accent-hover);
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

.request-item {
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 6px;
    margin-bottom: 8px;
    background: var(--card);
}

.request-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.request-id {
    font-weight: bold;
    color: var(--accent);
}

.request-priority {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
}

.priority-urgent {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.priority-high {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
}

.priority-normal {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
}

.priority-low {
    background: rgba(59, 130, 246, 0.2);
    color: #3b82f6;
}

.request-details {
    color: var(--fg);
    line-height: 1.4;
}

.request-details strong {
    color: var(--accent);
}

.request-details small {
    color: var(--muted);
}

.request-item.error {
    border-color: var(--danger);
    color: var(--danger);
}

/* Package Selection Styles */
.package-selection {
    margin-top: 20px;
    padding: 16px;
    background: rgba(31, 42, 68, 0.05);
    border-radius: 8px;
    border: 1px solid var(--border);
}

.package-selection h4 {
    margin-bottom: 8px;
    color: var(--accent);
}

.selection-description {
    margin-bottom: 16px;
    color: var(--muted);
    font-size: 0.9em;
}

.package-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}

.package-option {
    padding: 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--card);
    cursor: pointer;
    transition: all 0.2s ease;
}

.package-option:hover {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.05);
}

.package-option.selected {
    border-color: var(--accent);
    background: rgba(59, 130, 246, 0.1);
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
}

.package-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
}

.package-header h5 {
    margin: 0;
    color: var(--accent);
    font-size: 1.1em;
}

.package-barcode {
    font-family: 'Courier New', monospace;
    font-size: 0.8em;
    color: var(--muted);
    background: rgba(31, 42, 68, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
}

.package-details {
    color: var(--fg);
}

.package-meta {
    display: flex;
    gap: 16px;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.package-meta span {
    color: var(--muted);
}

.package-location {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e !important;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 500;
}


.package-description {
    font-size: 0.9em;
    color: var(--muted);
    font-style: italic;
}

.selected-package {
    margin-top: 16px;
    padding: 16px;
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--success);
    border-radius: 8px;
}

.selected-package h5 {
    margin-bottom: 12px;
    color: var(--success);
}

.selected-package-card {
    background: var(--card);
    padding: 12px;
    border-radius: 6px;
}

.selected-package-card h6 {
    margin-bottom: 8px;
    color: var(--accent);
}

.selected-package-details {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 8px;
    font-size: 0.9em;
}

.selected-package-details span {
    color: var(--fg);
}

.selected-package-description {
    font-size: 0.9em;
    color: var(--muted);
    font-style: italic;
}

@media (max-width: 600px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .request-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
}
</style>

</body>
</html>