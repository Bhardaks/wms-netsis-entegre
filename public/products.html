<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>√úr√ºn Y√∂netimi - WMS</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/zebra-terminal.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <!-- Core Scripts -->
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/products-core.js"></script>
    <script src="/assets/js/products-packages.js"></script>
    <script src="/assets/js/products-barcode.js"></script>
    <script src="/assets/js/products-ui.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Y√ºkleniyor...</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button onclick="location.href='/dashboard.html'" class="btn btn-secondary">
                ‚Üê Ana Sayfa
            </button>
            <h1>√úr√ºn Y√∂netimi</h1>
        </div>
        <div class="header-right">
            <button id="syncNetsisBtn" class="btn btn-success">
                <span class="btn-icon">üîÑ</span>
                <span class="btn-text">Netsis'ten √áek</span>
            </button>
            <button onclick="refresh()" class="btn btn-outline">
                <span class="btn-icon">‚Üª</span>
                <span class="btn-text">Yenile</span>
            </button>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="search-section">
        <div class="search-bar">
            <div class="search-input-wrapper">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="√úr√ºn adƒ±, SKU veya barkod ile ara..." class="search-input">
            </div>
        </div>
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label">Durum:</label>
                <select id="statusFilter" class="modern-select">
                    <option value="">T√ºm√º</option>
                    <option value="no-packages">Paketsiz</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Sƒ±ralama:</label>
                <select id="sortBy" class="modern-select">
                    <option value="name">Ada G√∂re</option>
                    <option value="sku">SKU'ya G√∂re</option>
                </select>
            </div>
            <button onclick="filterProducts()" class="btn btn-filter">
                <span class="btn-icon">‚ö°</span>
                <span class="btn-text">Filtrele</span>
            </button>
        </div>
    </div>


    <!-- Products Table -->
    <div class="table-container">
        <table id="productsTable" class="data-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll"></th>
                    <th>√úr√ºn Bilgileri</th>
                    <th>SKU</th>
                    <th>Paketler</th>
                    <th>ƒ∞≈ülemler</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="loading-message">√úr√ºnler y√ºkleniyor...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div id="paginationContainer" class="pagination-container">
        <!-- Pagination will be generated by JS -->
    </div>


    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>√úr√ºn D√ºzenle</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId">
                    <div class="form-group">
                        <label for="editSku">SKU *</label>
                        <input type="text" id="editSku" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="editMainProductName">Ana √úr√ºn Adƒ±</label>
                        <input type="text" id="editMainProductName" class="form-input" placeholder="√ñrnek: CC Yatak Odasƒ±">
                    </div>
                    <div class="form-group">
                        <label for="editMainProductNameEn">Ana √úr√ºn Adƒ± (ƒ∞ngilizce)</label>
                        <input type="text" id="editMainProductNameEn" class="form-input" placeholder="Example: CC Bedroom">
                    </div>
                    <div class="form-group">
                        <label for="editName">√úr√ºn Adƒ± *</label>
                        <input type="text" id="editName" class="form-input" required placeholder="√ñrnek: CC Gardrop (P.Siyah)">
                    </div>
                    <div class="form-group">
                        <label for="editPrice">Fiyat *</label>
                        <input type="number" id="editPrice" class="form-input" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="editBarcode">Ana Barkod</label>
                        <input type="text" id="editBarcode" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="editDescription">A√ßƒ±klama</label>
                        <textarea id="editDescription" class="form-input" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="closeEditModal()" class="btn btn-secondary">ƒ∞ptal</button>
                <button onclick="saveProduct()" class="btn btn-primary">G√ºncelle</button>
            </div>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content extra-large">
            <div class="modal-header">
                <h3 id="packageModalTitle">Paket Y√∂netimi</h3>
                <button class="modal-close" onclick="closePackageModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="packageModalContent">
                    <div class="loading-message">Paketler y√ºkleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Actions Modal -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Barkod ƒ∞≈ülemleri</h3>
                <button class="modal-close" onclick="closeBarcodeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="barcodeModalContent">
                    <div class="loading-message">Barkod se√ßenekleri y√ºkleniyor...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content small">
            <div class="modal-header">
                <h3>Onay</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Bu i≈ülemi ger√ßekle≈ütirmek istediƒüinizden emin misiniz?</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeConfirmModal()" class="btn btn-secondary">ƒ∞ptal</button>
                <button id="confirmButton" class="btn btn-danger">Onayla</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="messageContainer"></div>

    <script>
        // Global variables
        window.products = [];
        window.filteredProducts = [];
        window.currentPage = 1;
        window.itemsPerPage = 10;
        window.selectedProducts = [];

        // Initialize page when auth is complete
        window.onAuthCompleted = function() {
            initializePage();
        };

        // Main initialization function
        async function initializePage() {
            try {
                showLoading(true);
                await loadProducts();
                setupEventListeners();
                filterProducts(); // This renders the products table
                updateStats();
                showLoading(false);
            } catch (error) {
                console.error('Page initialization error:', error);
                showMessage('Sayfa y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = show ? 'flex' : 'none';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterProducts, 300));
            }

            // Filter selects
            const statusFilter = document.getElementById('statusFilter');
            const sortBy = document.getElementById('sortBy');
            if (statusFilter) statusFilter.addEventListener('change', filterProducts);
            if (sortBy) sortBy.addEventListener('change', filterProducts);

            // Select all checkbox
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                selectAll.addEventListener('change', toggleAllProducts);
            }

            // Modal click outside to close
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    closeAllModals();
                }
            });

            // Button event listeners
            const barcodeActionsBtn = document.getElementById('barcodeActionsBtn');
            if (barcodeActionsBtn) {
                barcodeActionsBtn.addEventListener('click', openBarcodeModal);
            }

            const syncNetsisBtn = document.getElementById('syncNetsisBtn');
            if (syncNetsisBtn) {
                syncNetsisBtn.addEventListener('click', syncFromNetsis);
            }
        }

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Show success/error messages
        function showMessage(message, type = 'success') {
            const container = document.getElementById('messageContainer');
            if (!container) return;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" class="message-close">&times;</button>
            `;

            container.appendChild(messageDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Close all modals
        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Sync products from Netsis
        async function syncFromNetsis() {
            if (!confirm('Netsis\'ten √ºr√ºnler √ßekilsin mi? Bu i≈ülem biraz zaman alabilir.')) {
                return;
            }

            try {
                showLoading(true);
                showMessage('Netsis\'ten √ºr√ºnler √ßekiliyor...', 'info');

                const response = await fetch('/api/netsis/sync/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Netsis sync ba≈üarƒ±sƒ±z');
                }

                showMessage(`‚úÖ ${result.imported || 0} √ºr√ºn Netsis'ten aktarƒ±ldƒ±`, 'success');
                
                // Reload products after sync
                await loadProducts();
                filterProducts();
                updateStats();
                showLoading(false);

            } catch (error) {
                console.error('‚ùå Netsis sync error:', error);
                showMessage('Netsis sync hatasƒ±: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Refresh page data
        async function refresh() {
            try {
                showLoading(true);
                await loadProducts();
                filterProducts();
                updateStats();
                showMessage('Veriler g√ºncellendi', 'success');
                showLoading(false);
            } catch (error) {
                console.error('Refresh error:', error);
                showMessage('Yenileme sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
                showLoading(false);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Check if auth is already complete
            if (window.isAuthComplete) {
                initializePage();
            }
        });
    </script>
</body>
</html>