<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Raf Barkod TarayÄ±cÄ± - WMS</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="/assets/css/styles.css">
    <link rel="stylesheet" href="/assets/css/zebra-terminal.css">
    
    <!-- Core Scripts -->
    <script src="/assets/js/auth.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">YÃ¼kleniyor...</div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <button onclick="location.href='/index.html'" class="btn btn-secondary">
                â† Ana Sayfa
            </button>
            <h1>Raf Barkod TarayÄ±cÄ±</h1>
        </div>
        <div class="header-right">
            <button onclick="clearScanner()" class="btn btn-outline">
                <span class="btn-icon">ğŸ—‘ï¸</span>
                <span class="btn-text">Temizle</span>
            </button>
        </div>
    </div>

<main class="grid" style="max-width:800px;margin:auto;padding:16px">

  <!-- Durum GÃ¶stergesi -->
  <section class="card">
    <div class="status-indicator" id="statusIndicator">
      <div class="status-icon">ğŸ“¦</div>
      <div class="status-text">
        <strong>AdÄ±m 1:</strong> ÃœrÃ¼n barkodunu okutun
      </div>
      <div class="progress-bar">
        <div class="progress" id="progressBar" style="width: 0%"></div>
      </div>
    </div>
  </section>

  <!-- Barkod Okuma AlanÄ± -->
  <section class="card">
    <h2>ğŸ” Barkod Okuyucu</h2>
    <div class="scanner-container">
      <input 
        type="text" 
        id="barcodeInput" 
        placeholder="ÃœrÃ¼n barkodunu okutun..."
        class="barcode-input"
        autocomplete="off"
      />
      <div class="scanner-status" id="scannerStatus">
        ÃœrÃ¼n barkodu bekleniyor...
      </div>
    </div>
  </section>

  <!-- ÃœrÃ¼n Bilgisi -->
  <section class="card" id="productInfo" style="display:none">
    <h3>ğŸ“¦ TaranmÄ±ÅŸ ÃœrÃ¼n</h3>
    <div class="info-grid" id="productDetails">
      <!-- ÃœrÃ¼n bilgileri burada gÃ¶sterilecek -->
    </div>
  </section>

  <!-- Ã–nerilen Raf -->
  <section class="card" id="suggestedShelf" style="display:none">
    <h3>ğŸ¯ Ã–nerilen Raf</h3>
    <div class="shelf-suggestion" id="shelfSuggestion">
      <!-- Ã–nerilen raf bilgisi -->
    </div>
    <div class="shelf-actions">
      <div class="info-message" id="suggestionMessage">
        Bu raf Ã¶nerilir Ã§Ã¼nkÃ¼ aynÄ± Ã¼rÃ¼n daha Ã¶nce bu rafta saklandÄ±.
      </div>
    </div>
  </section>

  <!-- Raf OnayÄ± -->
  <section class="card" id="shelfConfirmation" style="display:none">
    <h3>ğŸ“ Raf OnayÄ±</h3>
    <div class="confirmation-container">
      <div class="confirmation-message">
        Åimdi <strong id="targetShelfCode"></strong> rafÄ±na gidin ve raf barkodunu okutun:
      </div>
      <input 
        type="text" 
        id="shelfBarcodeInput" 
        placeholder="Raf barkodunu okutun..."
        class="barcode-input"
        autocomplete="off"
        style="display:none"
      />
      <div class="shelf-actions">
        <button id="shelfFullBtn" class="btn-warning" style="display:none">
          ğŸš« Raf Dolu
        </button>
      </div>
    </div>
  </section>

  <!-- Manuel Raf SeÃ§imi -->
  <section class="card" id="manualShelfSelection" style="display:none">
    <h3>ğŸ›ï¸ Manuel Raf SeÃ§imi</h3>
    <div class="manual-selection">
      <p>BoÅŸ raf bulunamadÄ±. LÃ¼tfen Ã¼rÃ¼nÃ¼n gireceÄŸi rafÄ± manuel olarak seÃ§in:</p>
      <div class="shelf-grid" id="availableShelvesGrid">
        <!-- Mevcut raflar burada listelenecek -->
      </div>
    </div>
  </section>

  <!-- Ä°ÅŸlem GeÃ§miÅŸi -->
  <section class="card">
    <h3>ğŸ“‹ Son Ä°ÅŸlemler</h3>
    <div class="history-list" id="operationHistory">
      <div class="history-item">
        <em>Ä°ÅŸlem geÃ§miÅŸi burada gÃ¶rÃ¼necek...</em>
      </div>
    </div>
  </section>


</main>

<script>
// Yeni Ä°ÅŸ AkÄ±ÅŸÄ± DeÄŸiÅŸkenleri
let currentProduct = null;
let suggestedShelf = null;
let targetShelf = null;
let workflowStep = 1; // 1=Ã¼rÃ¼n, 2=raf onayÄ±, 3=manuel seÃ§im
let allShelves = [];
let isProcessing = false; // Ã‡ift tÄ±klama Ã¶nleme

// DOM Elements
const barcodeInput = document.getElementById('barcodeInput');
const statusIndicator = document.getElementById('statusIndicator');
const scannerStatus = document.getElementById('scannerStatus');
const progressBar = document.getElementById('progressBar');
const productInfo = document.getElementById('productInfo');
const productDetails = document.getElementById('productDetails');
const suggestedShelfSection = document.getElementById('suggestedShelf');
const shelfSuggestion = document.getElementById('shelfSuggestion');
const suggestionMessage = document.getElementById('suggestionMessage');
const shelfConfirmation = document.getElementById('shelfConfirmation');
const shelfBarcodeInput = document.getElementById('shelfBarcodeInput');
const targetShelfCode = document.getElementById('targetShelfCode');
const shelfFullBtn = document.getElementById('shelfFullBtn');
const manualShelfSelection = document.getElementById('manualShelfSelection');
const availableShelvesGrid = document.getElementById('availableShelvesGrid');
const operationHistory = document.getElementById('operationHistory');

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', async () => {
  barcodeInput.focus();
  loadOperationHistory();
  await loadAllShelves();
  
  // Mobile nav
  const toggle = document.getElementById('mobileNavToggle');
  const menu = document.getElementById('mobileNavMenu');
  toggle?.addEventListener('click', () => {
    menu.classList.toggle('active');
  });
  
  // Event listeners
  setupEventListeners();
});

// Event Listeners Kurulumu
function setupEventListeners() {
  // Ana Ã¼rÃ¼n barkodu input
  barcodeInput.addEventListener('input', async (e) => {
    const barcode = e.target.value.trim();
    if (barcode && workflowStep === 1) {
      // Paket barkodunu kontrol et
      try {
        const response = await fetch(`/api/packages/barcode/${encodeURIComponent(barcode)}`);
        if (response.ok) {
          await processProductBarcode(barcode);
          e.target.value = '';
        }
      } catch (error) {
        // EÅŸleÅŸme yoksa devam et
      }
    }
  });
  
  // Raf barkodu input
  shelfBarcodeInput.addEventListener('input', async (e) => {
    const barcode = e.target.value.trim();
    if (barcode && workflowStep === 2 && targetShelf && barcode === targetShelf.shelf_code) {
      await processShelfConfirmation(barcode);
      e.target.value = '';
    }
  });
  
  // Raf dolu butonu
  shelfFullBtn.addEventListener('click', () => {
    handleShelfFull();
  });
  
}

// TÃ¼m raflarÄ± yÃ¼kle (atama bilgileri ile birlikte)
async function loadAllShelves() {
  try {
    const [shelvesResponse, assignmentsResponse] = await Promise.all([
      fetch('/api/shelves'),
      fetch('/api/shelf-assignments')
    ]);
    
    const shelvesData = await shelvesResponse.json();
    const assignmentsData = await assignmentsResponse.json();
    
    allShelves = shelvesData.shelves || [];
    const assignments = assignmentsData.assignments || [];
    
    // RaflarÄ± atama bilgileriyle zenginleÅŸtir
    enrichShelvesWithAssignments(assignments);
    
  } catch (error) {
    console.error('Raflar yÃ¼klenemedi:', error);
  }
}

// RaflarÄ± atama bilgileriyle zenginleÅŸtir
function enrichShelvesWithAssignments(assignments) {
  const shelfAssignments = {};
  
  assignments.forEach(assignment => {
    if (!shelfAssignments[assignment.shelf_id]) {
      shelfAssignments[assignment.shelf_id] = {
        totalQuantity: 0,
        productIds: new Set()
      };
    }
    
    shelfAssignments[assignment.shelf_id].totalQuantity += assignment.quantity || 0;
    shelfAssignments[assignment.shelf_id].productIds.add(assignment.product_id);
  });
  
  // RaflarÄ± gÃ¼ncelle
  allShelves.forEach(shelf => {
    const assignment = shelfAssignments[shelf.id];
    shelf.totalQuantity = assignment ? assignment.totalQuantity : 0;
    shelf.productIds = assignment ? Array.from(assignment.productIds) : [];
  });
}

// ============ YENÄ° Ä°Å AKIÅI FONKSÄ°YONLARI ============

// AdÄ±m 1: ÃœrÃ¼n barkodu iÅŸleme
async function processProductBarcode(barcode) {
  try {
    scannerStatus.textContent = 'ÃœrÃ¼n aranÄ±yor...';
    scannerStatus.className = 'scanner-status processing';
    
    // ÃœrÃ¼n bilgisini al
    const response = await fetch(`/api/packages/barcode/${encodeURIComponent(barcode)}`);
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'ÃœrÃ¼n bulunamadÄ±');
    }
    
    currentProduct = data.package;
    
    // ÃœrÃ¼n bilgisini gÃ¶ster
    showProductInfo(currentProduct);
    
    // Bu Ã¼rÃ¼n iÃ§in Ã¶nerilen rafÄ± bul
    await findSuggestedShelf(currentProduct);
    
    // Progress bar gÃ¼ncelle
    updateProgress(33);
    
  } catch (error) {
    showError(`ÃœrÃ¼n bulunamadÄ±: ${error.message}`);
  }
}

// ÃœrÃ¼n bilgisini gÃ¶ster
function showProductInfo(product) {
  productDetails.innerHTML = `
    <div class="info-item">
      <strong>ÃœrÃ¼n:</strong> ${product.product_name}
    </div>
    <div class="info-item">
      <strong>SKU:</strong> ${product.sku}
    </div>
    <div class="info-item">
      <strong>Paket:</strong> ${product.package_name}
    </div>
    <div class="info-item">
      <strong>Barkod:</strong> ${product.barcode}
    </div>
  `;
  productInfo.style.display = 'block';
}

// Bu Ã¼rÃ¼n iÃ§in Ã¶nerilen rafÄ± bul
async function findSuggestedShelf(product) {
  try {
    // Bu Ã¼rÃ¼nÃ¼n daha Ã¶nce hangi raflarda saklandÄ±ÄŸÄ±na bak
    const usedShelves = allShelves.filter(shelf => 
      shelf.productIds.includes(product.product_id) && hasCapacity(shelf) && !shelf.shelf_code.startsWith('SSH-')
    );
    
    if (usedShelves.length > 0) {
      // En az dolu olan rafÄ± seÃ§
      suggestedShelf = usedShelves.sort((a, b) => 
        (a.totalQuantity || 0) - (b.totalQuantity || 0)
      )[0];
      
      showSuggestedShelf(suggestedShelf, 'Bu raf Ã¶nerilir Ã§Ã¼nkÃ¼ aynÄ± Ã¼rÃ¼n daha Ã¶nce bu rafta saklandÄ±.');
      proceedToShelfConfirmation();
      return;
    }
    
    // Daha Ã¶nce kullanÄ±lmÄ±ÅŸ raf yoksa, boÅŸ raf Ã¶ner (SSH hariÃ§)
    const emptyShelves = allShelves.filter(shelf => 
      (!shelf.totalQuantity || shelf.totalQuantity === 0) && !shelf.shelf_code.startsWith('SSH-')
    );
    
    if (emptyShelves.length > 0) {
      // En yakÄ±n boÅŸ rafÄ± seÃ§ (zone/aisle/level sÄ±rasÄ± ile)
      suggestedShelf = emptyShelves.sort((a, b) => {
        if (a.zone !== b.zone) return a.zone.localeCompare(b.zone);
        if (a.aisle !== b.aisle) return a.aisle - b.aisle;
        return a.level - b.level;
      })[0];
      
      showSuggestedShelf(suggestedShelf, 'Bu raf Ã¶nerilir Ã§Ã¼nkÃ¼ boÅŸ ve eriÅŸilebilir konumda.');
      proceedToShelfConfirmation();
      return;
    }
    
    // HiÃ§ boÅŸ raf yoksa manuel seÃ§ime geÃ§
    showManualShelfSelection();
    
  } catch (error) {
    console.error('Raf Ã¶nerisi hatasÄ±:', error);
    showManualShelfSelection();
  }
}

// Ã–nerilen rafÄ± gÃ¶ster
function showSuggestedShelf(shelf, message) {
  shelfSuggestion.innerHTML = `
    <div class="shelf-card">
      <div class="shelf-card-icon">ğŸ“</div>
      <div class="shelf-card-info">
        <h4>${shelf.shelf_code} - ${shelf.shelf_name}</h4>
        <div class="shelf-card-details">
          ${shelf.zone} BÃ¶lgesi â€¢ Koridor ${shelf.aisle} â€¢ Seviye ${shelf.level}<br>
          Kapasite: ${shelf.totalQuantity || 0}/${shelf.capacity}
        </div>
      </div>
    </div>
  `;
  
  suggestionMessage.textContent = message;
  suggestedShelfSection.style.display = 'block';
}

// Raf onayÄ±na geÃ§
function proceedToShelfConfirmation() {
  workflowStep = 2;
  targetShelf = suggestedShelf;
  
  // UI gÃ¼ncelle
  statusIndicator.querySelector('.status-icon').textContent = 'ğŸ“';
  statusIndicator.querySelector('.status-text').innerHTML = '<strong>AdÄ±m 2:</strong> Raf barkodunu okutarak onaylayÄ±n';
  
  targetShelfCode.textContent = targetShelf.shelf_code;
  shelfConfirmation.style.display = 'block';
  
  // Ana input'u gizle, raf input'unu gÃ¶ster
  barcodeInput.style.display = 'none';
  shelfBarcodeInput.style.display = 'block';
  shelfFullBtn.style.display = 'inline-block';
  
  shelfBarcodeInput.focus();
  scannerStatus.textContent = `${targetShelf.shelf_code} rafÄ±na gidin ve raf barkodunu okutun...`;
  
  updateProgress(66);
}

// AdÄ±m 2: Raf onayÄ± iÅŸleme
async function processShelfConfirmation(barcode) {
  try {
    scannerStatus.textContent = 'Raf onaylanÄ±yor...';
    
    // TaranmÄ±ÅŸ raf kodu hedef raf ile eÅŸleÅŸiyor mu?
    if (barcode === targetShelf.shelf_code) {
      // Raf onaylandÄ±, Ã¼rÃ¼nÃ¼ yerleÅŸtir
      await assignProductToShelf(targetShelf);
    } else {
      // YanlÄ±ÅŸ raf tarandÄ±
      showError(`YanlÄ±ÅŸ raf! ${targetShelf.shelf_code} rafÄ±nÄ± tarayÄ±n.`);
    }
    
  } catch (error) {
    showError(`Raf onayÄ± hatasÄ±: ${error.message}`);
  }
}

// ÃœrÃ¼nÃ¼ rafa ata
async function assignProductToShelf(shelf) {
  try {
    const response = await fetch('/api/shelves/assign', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        shelf_code: shelf.shelf_code,
        package_barcode: currentProduct.barcode,
        quantity: 1, // VarsayÄ±lan 1 paket
        assigned_by: 'Raf TarayÄ±cÄ±'
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Atama baÅŸarÄ±sÄ±z');
    }
    
    // BaÅŸarÄ±!
    scannerStatus.textContent = 'ÃœrÃ¼n baÅŸarÄ±yla rafa yerleÅŸtirildi!';
    scannerStatus.className = 'scanner-status success';
    
    // Ä°ÅŸlem geÃ§miÅŸine ekle
    addToHistory({
      type: 'assign',
      shelf: shelf.shelf_name,
      product: currentProduct.product_name,
      package: currentProduct.package_name,
      quantity: 1,
      timestamp: new Date().toLocaleString('tr-TR')
    });
    
    updateProgress(100);
    
    // 3 saniye sonra sÄ±fÄ±rla
    setTimeout(() => {
      resetWorkflow();
    }, 3000);
    
  } catch (error) {
    showError(`Atama hatasÄ±: ${error.message}`);
  }
}

// Raf dolu durumu
function handleShelfFull() {
  scannerStatus.textContent = 'Raf dolu olarak iÅŸaretlendi. Manuel raf seÃ§imine geÃ§iliyor...';
  
  // Direkt manuel seÃ§ime geÃ§
  showManualShelfSelection();
}

// En yakÄ±n boÅŸ rafÄ± bul
function findNearestEmptyShelf(currentShelf) {
  const emptyShelves = allShelves.filter(shelf => 
    shelf.id !== currentShelf.id && hasCapacity(shelf) && !shelf.shelf_code.startsWith('SSH-')
  );
  
  if (emptyShelves.length === 0) return null;
  
  // AynÄ± bÃ¶lge/koridor Ã¶nceliÄŸi ile sÄ±rala
  return emptyShelves.sort((a, b) => {
    // AynÄ± bÃ¶lge Ã¶nce
    if (a.zone === currentShelf.zone && b.zone !== currentShelf.zone) return -1;
    if (a.zone !== currentShelf.zone && b.zone === currentShelf.zone) return 1;
    
    // AynÄ± koridor Ã¶nce
    if (a.aisle === currentShelf.aisle && b.aisle !== currentShelf.aisle) return -1;
    if (a.aisle !== currentShelf.aisle && b.aisle === currentShelf.aisle) return 1;
    
    // Seviye farkÄ± en az olan
    return Math.abs(a.level - currentShelf.level) - Math.abs(b.level - currentShelf.level);
  })[0];
}

// Manuel raf seÃ§imini gÃ¶ster
function showManualShelfSelection() {
  workflowStep = 3;
  
  // UI gÃ¼ncelle
  statusIndicator.querySelector('.status-icon').textContent = 'ğŸ›ï¸';
  statusIndicator.querySelector('.status-text').innerHTML = '<strong>AdÄ±m 3:</strong> Manuel raf seÃ§imi';
  
  manualShelfSelection.style.display = 'block';
  renderAvailableShelves();
  
  scannerStatus.textContent = 'BoÅŸ raf bulunamadÄ±. LÃ¼tfen manuel olarak raf seÃ§in.';
  updateProgress(80);
}

// Mevcut raflarÄ± listele
function renderAvailableShelves() {
  const availableShelves = allShelves.filter(shelf => 
    hasCapacity(shelf) && !shelf.shelf_code.startsWith('SSH-')
  );
  
  availableShelvesGrid.innerHTML = availableShelves.map(shelf => `
    <div class="shelf-option" onclick="selectManualShelf(${shelf.id})">
      <h5>${shelf.shelf_code}</h5>
      <div class="shelf-meta">
        ${shelf.shelf_name}<br>
        ${shelf.zone}-${shelf.aisle}-${shelf.level}<br>
        ${shelf.totalQuantity || 0}/${shelf.capacity}
      </div>
    </div>
  `).join('') || '<p>HiÃ§ uygun raf bulunamadÄ±.</p>';
}

// Manuel raf seÃ§imi
async function selectManualShelf(shelfId) {
  if (isProcessing) return; // Ã‡ift tÄ±klama Ã¶nleme
  
  const shelf = allShelves.find(s => s.id === shelfId);
  if (!shelf) return;
  
  isProcessing = true;
  
  // SeÃ§imi vurgula
  document.querySelectorAll('.shelf-option').forEach(opt => opt.classList.remove('selected'));
  event.target.closest('.shelf-option').classList.add('selected');
  
  // ÃœrÃ¼nÃ¼ seÃ§ilen rafa ata
  await assignProductToShelf(shelf);
}

// RafÄ±n kapasitesi var mÄ±?
function hasCapacity(shelf) {
  const currentQuantity = shelf.totalQuantity || 0;
  const capacity = shelf.capacity || 100;
  return currentQuantity < capacity;
}

// Progress bar gÃ¼ncelle
function updateProgress(percentage) {
  progressBar.style.width = percentage + '%';
}

// Ä°ÅŸ akÄ±ÅŸÄ±nÄ± sÄ±fÄ±rla
function resetWorkflow() {
  // DeÄŸiÅŸkenleri sÄ±fÄ±rla
  currentProduct = null;
  suggestedShelf = null;
  targetShelf = null;
  workflowStep = 1;
  isProcessing = false; // Ä°ÅŸlem durumunu sÄ±fÄ±rla
  
  // UI'yÄ± sÄ±fÄ±rla
  statusIndicator.querySelector('.status-icon').textContent = 'ğŸ“¦';
  statusIndicator.querySelector('.status-text').innerHTML = '<strong>AdÄ±m 1:</strong> ÃœrÃ¼n barkodunu okutun';
  
  productInfo.style.display = 'none';
  suggestedShelfSection.style.display = 'none';
  shelfConfirmation.style.display = 'none';
  manualShelfSelection.style.display = 'none';
  
  // Input'larÄ± sÄ±fÄ±rla
  barcodeInput.style.display = 'block';
  shelfBarcodeInput.style.display = 'none';
  shelfFullBtn.style.display = 'none';
  
  barcodeInput.focus();
  scannerStatus.textContent = 'ÃœrÃ¼n barkodu bekleniyor...';
  scannerStatus.className = 'scanner-status';
  
  updateProgress(0);
}


// Global olarak eriÅŸilebilir manuel raf seÃ§imi fonksiyonu
window.selectManualShelf = selectManualShelf;

// Ä°ÅŸlem geÃ§miÅŸi
function addToHistory(operation) {
  let history = JSON.parse(localStorage.getItem('shelfOperationHistory') || '[]');
  history.unshift(operation); // En yeniler en Ã¼stte
  history = history.slice(0, 20); // Son 20 iÅŸlem
  localStorage.setItem('shelfOperationHistory', JSON.stringify(history));
  displayHistory(history);
}

function loadOperationHistory() {
  const history = JSON.parse(localStorage.getItem('shelfOperationHistory') || '[]');
  displayHistory(history);
}

function displayHistory(history) {
  if (history.length === 0) {
    operationHistory.innerHTML = '<div class="history-item"><em>HenÃ¼z iÅŸlem yapÄ±lmadÄ±...</em></div>';
    return;
  }
  
  operationHistory.innerHTML = history.map(op => `
    <div class="history-item ${op.type}">
      <div class="history-icon">${op.type === 'assign' ? 'âœ…' : 'â–'}</div>
      <div class="history-details">
        <strong>${op.product}</strong> (${op.package})<br>
        <small>${op.shelf} â€¢ ${op.quantity} adet â€¢ ${op.timestamp}</small>
      </div>
    </div>
  `).join('');
}

// YardÄ±mcÄ± fonksiyonlar
function showError(message) {
  scannerStatus.textContent = message;
  scannerStatus.className = 'scanner-status error';
  setTimeout(() => {
    if (workflowStep === 1) {
      scannerStatus.textContent = 'ÃœrÃ¼n barkodu bekleniyor...';
    } else if (workflowStep === 2) {
      scannerStatus.textContent = `${targetShelf.shelf_code} rafÄ±na gidin ve raf barkodunu okutun...`;
    }
    scannerStatus.className = 'scanner-status';
  }, 3000);
}

function showSuccess(message) {
  scannerStatus.textContent = message;
  scannerStatus.className = 'scanner-status success';
}

// Focus yÃ¶netimi
document.addEventListener('click', (e) => {
  // EÄŸer tÄ±klanan element input veya button deÄŸilse ve aÃ§Ä±k input varsa onu focus et
  if (!e.target.matches('input, button, .shelf-option')) {
    if (workflowStep === 1 && barcodeInput.style.display !== 'none') {
      barcodeInput.focus();
    } else if (workflowStep === 2 && shelfBarcodeInput.style.display !== 'none') {
      shelfBarcodeInput.focus();
    }
  }
});

</script>

<style>
.status-indicator {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 20px;
  border-radius: 12px;
  font-size: 16px;
  background: var(--card);
  border: 2px solid var(--accent);
  color: var(--fg);
}

.status-indicator.step-1 {
  background: var(--card);
  border-color: var(--warning);
  color: var(--fg);
}

.status-indicator.step-2 {
  background: var(--card);
  border-color: var(--success);
  color: var(--fg);
}

.status-icon {
  font-size: 32px;
  flex-shrink: 0;
}

.scanner-container {
  text-align: center;
}

.barcode-input {
  width: 100%;
  padding: 15px;
  font-size: 18px;
  border: 3px solid #ddd;
  border-radius: 8px;
  text-align: center;
  font-family: 'Courier New', monospace;
  margin-bottom: 10px;
}

.barcode-input:focus {
  border-color: #4caf50;
  outline: none;
  box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
}

.scanner-status {
  padding: 10px;
  border-radius: 6px;
  font-weight: bold;
}

.scanner-status.processing {
  background-color: rgba(251,191,36,0.2);
  color: var(--warning);
}

.scanner-status.success {
  background-color: rgba(34,197,94,0.2);
  color: var(--success);
}

.scanner-status.error {
  background-color: rgba(239,68,68,0.2);
  color: var(--danger);
}

.info-grid {
  display: grid;
  gap: 12px;
}

.info-item {
  padding: 8px;
  background: rgba(31,42,68,0.2);
  border-radius: 4px;
  color: var(--fg);
}

.info-item strong {
  color: var(--accent);
}

.quantity-section {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid var(--border);
  color: var(--fg);
}

.quantity-section input {
  width: 80px;
  padding: 8px;
  text-align: center;
}

.quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
}

.history-list {
  max-height: 300px;
  overflow-y: auto;
}

.history-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px;
  border-bottom: 1px solid var(--border);
  background: rgba(31,42,68,0.1);
  margin-bottom: 4px;
  border-radius: 6px;
  color: var(--fg);
}

.history-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.history-item.assign .history-icon {
  color: var(--success);
}

.history-item.remove .history-icon {
  color: var(--danger);
}

.history-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.history-details {
  flex: 1;
  font-size: 14px;
  color: var(--fg);
}

.history-details strong {
  color: var(--accent);
}

.history-details small {
  color: var(--muted);
}

@media (max-width: 600px) {
  .info-grid {
    gap: 8px;
  }
  
  .quantity-section {
    flex-direction: column;
    align-items: stretch;
  }
  
  .quick-actions {
    grid-template-columns: 1fr;
  }
}
</style>

</body>
</html>