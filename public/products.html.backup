
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>ÃœrÃ¼nler</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/auth.js"></script>
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS YÃ¶netim Sistemi</h1>
    <span class="header-subtitle">ÃœrÃ¼n YÃ¶netimi</span>
  </div>
  <div class="header-actions">
    <a href="/index.html" class="home-btn">
      <span class="home-icon">ğŸ </span>
      <span class="home-text">Ana Sayfa</span>
    </a>
  </div>
</header>

<main class="grid" style="max-width:1100px;margin:auto;padding:16px">

  <!-- Filtreler ve Arama -->
  <section class="card">
    <h2>Arama ve Filtreler</h2>
    <div class="filters-grid">
      <input id="searchInput" placeholder="SKU, ad veya barkod ile ara..." />
      <select id="statusFilter">
        <option value="">TÃ¼m Durumlar</option>
        <option value="stocked">Stokta Var</option>
        <option value="out-of-stock">Stok Yok</option>
        <option value="no-packages">Paket TanÄ±mlÄ± DeÄŸil</option>
        <option value="no-location">Konum TanÄ±mlÄ± DeÄŸil</option>
      </select>
      <select id="sortBy">
        <option value="name">Ada GÃ¶re</option>
        <option value="sku">SKU'ya GÃ¶re</option>
        <option value="price">Fiyata GÃ¶re</option>
        <option value="created">Eklenme Tarihine GÃ¶re</option>
      </select>
      <button id="clearFilters">Filtreleri Temizle</button>
    </div>
  </section>

  <!-- Toplu Ä°ÅŸlemler -->
  <section class="card">
    <h2>Toplu Ä°ÅŸlemler</h2>
    <div class="bulk-actions">
      <button id="addNewProduct" class="action-btn" style="background: var(--success); color: white;">
        <span class="btn-icon">â•</span>
        <span class="btn-text">Yeni ÃœrÃ¼n Ekle</span>
      </button>
      <button id="syncWix" class="action-btn">
        <span class="btn-icon">ğŸ”„</span>
        <span class="btn-text">Wix'ten ÃœrÃ¼n Ã‡ek</span>
      </button>
      <button id="syncNetsis" class="action-btn" style="background: var(--primary); color: white;">
        <span class="btn-icon">ğŸ“¦</span>
        <span class="btn-text">Netsis Stok KartlarÄ±</span>
      </button>
      <button id="exportProducts" class="action-btn">
        <span class="btn-icon">ğŸ“¤</span>
        <span class="btn-text">CSV Ä°ndir</span>
      </button>
      <button id="bulkLocationAssign" class="action-btn">
        <span class="btn-icon">ğŸ“</span>
        <span class="btn-text">Toplu Konum Ata</span>
      </button>
      <button id="bulkBarcodeActions" class="action-btn" style="background: var(--warning); color: white;">
        <span class="btn-icon">ğŸ·ï¸</span>
        <span class="btn-text">Barkod Ä°ÅŸlemleri</span>
      </button>
      <span class="badge" id="syncOut"></span>
    </div>
  </section>

  <!-- ÃœrÃ¼n Listesi -->
  <section class="card">
    <h2>ÃœrÃ¼n Listesi 
      <span class="list-count">(<span id="productCount">0</span> Ã¼rÃ¼n)</span>
    </h2>
    <div class="table-container">
      <table id="prodTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>GÃ¶rsel</th>
            <th>SKU</th>
            <th>Ad</th>
            <th>Fiyat</th>
            <th>Stok</th>
            <th>Renk</th>
            <th>Konum</th>
            <th>Paketler</th>
            <th>Son GÃ¼ncelleme</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </section>
</main>

<div class="modal" id="pkgModal">
  <div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;"><span id="pkgModalTitle">Paket YÃ¶netimi</span>: <span id="pkgProdName" style="color: var(--accent);"></span></h3>
      <button onclick="document.getElementById('pkgModal').classList.remove('show')" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">Ã—</button>
    </div>
    
    <!-- Dil Sekmeleri -->
    <div class="card" style="margin-bottom: 20px; background: var(--hover);">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <button id="turkishTab" class="language-tab active" onclick="switchLanguageTab('turkish')" style="background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</button>
        <button id="englishTab" class="language-tab" onclick="switchLanguageTab('english')" style="background: var(--muted); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">ğŸ‡ºğŸ‡¸ English</button>
      </div>
    </div>
    
    <!-- PK Paket Arama ve Otomatik EÅŸleÅŸtirme -->
    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #e8f5e8, #f0f8f0);">
      <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0; color: var(--success);">ğŸ” PK Paket Arama ve EÅŸleÅŸtirme</h4>
        <button id="autoMatchPkBtn" class="btn-sm" style="background: var(--warning); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
          ğŸ¤– Otomatik EÅŸleÅŸtir
        </button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <div style="flex: 1;">
          <input id="pkSearchInput" placeholder="PK kodu ara (Ã¶rn: PK-ZAR-RO-S...)" style="width: 100%; padding: 10px; border: 2px solid var(--success); border-radius: 6px;" />
        </div>
        <button id="searchPkBtn" style="background: var(--success); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;">
          ğŸ” Ara
        </button>
      </div>
      
      <div id="pkSearchResults" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; background: white;">
        <!-- PK arama sonuÃ§larÄ± buraya gelecek -->
      </div>
      
      <p style="margin: 10px 0 0 0; font-size: 0.85em; color: var(--muted);">
        ğŸ’¡ <strong>Ä°pucu:</strong> PK kodu ile baÅŸlayan Ã¼rÃ¼nleri arayabilir ve bu ana Ã¼rÃ¼ne alt paket olarak ekleyebilirsiniz. 
        "Otomatik EÅŸleÅŸtir" butonuyla bu ana Ã¼rÃ¼ne ait tÃ¼m PK Ã¼rÃ¼nler otomatik bulunur.
      </p>
    </div>

    <!-- Manuel Paket Ekleme Formu -->
    <div class="card" style="margin-bottom: 20px;">
      <div id="turkishForm" class="language-form">
        <h4 style="margin: 0 0 15px 0;">ğŸ“ Manuel Paket Ekle</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Paket AdÄ± *</label>
            <input id="pkgNumber" placeholder="Ã–rn: Ana ParÃ§a Seti" required style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Paket No</label>
            <input id="pkgNo" placeholder="Ã–rn: PKG-001" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Barkod *</label>
            <input id="pkgBarcode" placeholder="Barkod seÃ§imi yapÄ±lacak..." readonly style="width: 100%; background: #f5f5f5;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Paket Ä°Ã§eriÄŸi</label>
            <textarea id="pkgContent" rows="3" style="width: 100%; resize: vertical;" placeholder="Her satÄ±rda bir madde yazabilirsiniz..."></textarea>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Renk</label>
            <input id="pkgColor" placeholder="Ã–rn: Siyah, Beyaz" style="width: 100%;" list="colorOptionsTr" />
            <datalist id="colorOptionsTr">
              <option value="BEYAZ">
              <option value="SÄ°YAH">
              <option value="KAHVE">
              <option value="GRÄ°">
              <option value="ANTRASÄ°T">
              <option value="KREM">
              <option value="LACÄ°VERT">
              <option value="BORDO">
              <option value="YEÅÄ°L">
              <option value="MAVÄ°">
              <option value="MOR">
              <option value="PEMBE">
              <option value="TURUNCU">
              <option value="SARI">
            </datalist>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">SKU</label>
            <input id="pkgSku" placeholder="Paket SKU" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Adet</label>
            <input id="pkgQty" type="number" value="1" min="1" placeholder="1" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">En (cm)</label>
            <input id="pkgLength" type="number" step="0.1" placeholder="0.0" style="width: 100%;" onchange="calculateVolume()" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Boy (cm)</label>
            <input id="pkgWidth" type="number" step="0.1" placeholder="0.0" style="width: 100%;" onchange="calculateVolume()" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">YÃ¼kseklik (cm)</label>
            <input id="pkgHeight" type="number" step="0.1" placeholder="0.0" style="width: 100%;" onchange="calculateVolume()" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">AÄŸÄ±rlÄ±k (kg)</label>
            <input id="pkgWeight" type="number" step="0.01" placeholder="0.00" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Hacim (mÂ³)</label>
            <input id="pkgVolume" type="number" step="0.001" placeholder="0.000" readonly style="width: 100%; background: #f5f5f5;" />
          </div>
        </div>
      </div>
      
      <!-- English Form -->
      <div id="englishForm" class="language-form" style="display: none;">
        <h4 style="margin: 0 0 15px 0;">ğŸ“ Add Package Manually</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Package Name *</label>
            <input id="pkgNumberEn" placeholder="Ex: Main Part Set" required style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Package No</label>
            <input id="pkgNoEn" placeholder="Ex: PKG-001" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Barcode *</label>
            <input id="pkgBarcodeEn" placeholder="Barcode selection will be made..." readonly style="width: 100%; background: #f5f5f5;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Package Content</label>
            <textarea id="pkgContentEn" rows="3" style="width: 100%; resize: vertical;" placeholder="You can write one item per line..."></textarea>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Color</label>
            <input id="pkgColorEn" placeholder="Ex: Black, White" style="width: 100%;" list="colorOptionsEn" />
            <datalist id="colorOptionsEn">
              <option value="WHITE">
              <option value="BLACK">
              <option value="BROWN">
              <option value="GREY">
              <option value="ANTHRACITE">
              <option value="CREAM">
              <option value="NAVY">
              <option value="BURGUNDY">
              <option value="GREEN">
              <option value="BLUE">
              <option value="PURPLE">
              <option value="PINK">
              <option value="ORANGE">
              <option value="YELLOW">
            </datalist>
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">SKU</label>
            <input id="pkgSkuEn" placeholder="Package SKU" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Quantity</label>
            <input id="pkgQtyEn" type="number" value="1" min="1" placeholder="1" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Length (cm)</label>
            <input id="pkgLengthEn" type="number" step="0.1" placeholder="0.0" style="width: 100%;" onchange="calculateVolumeEn()" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Width (cm)</label>
            <input id="pkgWidthEn" type="number" step="0.1" placeholder="0.0" style="width: 100%;" onchange="calculateVolumeEn()" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Height (cm)</label>
            <input id="pkgHeightEn" type="number" step="0.1" placeholder="0.0" style="width: 100%;" onchange="calculateVolumeEn()" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Weight (kg)</label>
            <input id="pkgWeightEn" type="number" step="0.01" placeholder="0.00" style="width: 100%;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Volume (mÂ³)</label>
            <input id="pkgVolumeEn" type="number" step="0.001" placeholder="0.000" readonly style="width: 100%; background: #f5f5f5;" />
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="addPkgBtn" class="btn-primary" style="flex: 1;">
          <span id="addPkgBtnText">ğŸ“¦ Paket Ekle</span>
        </button>
        <button id="cancelPkgBtn" style="display:none; background: var(--muted);" onclick="cancelPackageEdit()">
          <span id="cancelBtnText">Ä°ptal</span>
        </button>
      </div>
    </div>
    
    <!-- Paket Listesi -->
    <div class="card">
      <div id="packageListTurkish" class="package-list-lang">
        <h4 style="margin: 0 0 15px 0;">Mevcut Paketler</h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--hover);">
                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border);">Paket No</th>
                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border);">Paket Bilgileri (TR)</th>
                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border);">Barkod</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">Adet</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">AÄŸÄ±rlÄ±k</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">Hacim</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="pkgList"></tbody>
          </table>
        </div>
      </div>
      
      <div id="packageListEnglish" class="package-list-lang" style="display: none;">
        <h4 style="margin: 0 0 15px 0;">Current Packages</h4>
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: var(--hover);">
                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border);">Package No</th>
                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border);">Package Info (EN)</th>
                <th style="padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border);">Barcode</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">Quantity</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">Weight</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">Volume</th>
                <th style="padding: 12px 8px; text-align: center; border-bottom: 1px solid var(--border);">Actions</th>
              </tr>
            </thead>
            <tbody id="pkgListEn"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Barkod SeÃ§imi Modal -->
<div class="modal" id="barcodeSelectionModal">
  <div class="panel" style="max-width: 400px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">ğŸ“¦ Barkod SeÃ§imi</h3>
      <button onclick="closeBarcodeSelectionModal()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">Ã—</button>
    </div>
    
    <div style="margin-bottom: 20px;">
      <p style="color: var(--muted); margin-bottom: 15px;">Paket barkodu nasÄ±l atanacaÄŸÄ±nÄ± seÃ§in:</p>
      
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <button id="autoGenerateBarcodeBtn" onclick="selectBarcodeOption('auto')" style="background: var(--accent); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 20px;">ğŸ”„</span>
          <div style="text-align: left;">
            <div style="font-weight: bold;">Otomatik OluÅŸtur</div>
            <div style="font-size: 0.9em; opacity: 0.9;">Sistem benzersiz barkod Ã¼retir</div>
          </div>
        </button>
        
        <button id="manualBarcodeBtn" onclick="selectBarcodeOption('manual')" style="background: var(--warning); color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 20px;">âœï¸</span>
          <div style="text-align: left;">
            <div style="font-weight: bold;">Manuel GiriÅŸ</div>
            <div style="font-size: 0.9em; opacity: 0.9;">Kendi barkodunu gir</div>
          </div>
        </button>
      </div>
    </div>
    
    <!-- Manuel barkod input (baÅŸlangÄ±Ã§ta gizli) -->
    <div id="manualBarcodeInput" style="display: none; margin-top: 15px;">
      <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--muted);">Manuel Barkod:</label>
      <input id="customBarcode" placeholder="Barkod girin..." style="width: 100%; margin-bottom: 10px;" />
      <div style="display: flex; gap: 10px;">
        <button onclick="confirmManualBarcode()" style="background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 6px; flex: 1;">âœ… Onayla</button>
        <button onclick="cancelManualBarcode()" style="background: var(--muted); color: white; border: none; padding: 8px 15px; border-radius: 6px;">âŒ Ä°ptal</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="locModal">
  <div class="panel">
    <h3>Konum Ata: <span id="locProdName"></span></h3>
    <div class="grid" style="grid-template-columns: 1fr 1fr 100px;">
      <input id="locCode" placeholder="Raf/Adres Kodu (Ã¶rn. A-01-03)" />
      <input id="locQty" type="number" value="0" placeholder="Stok (opsiyonel)" />
      <button id="assignLocBtn">Kaydet</button>
    </div>
    <table style="margin-top:10px">
      <thead><tr><th>Konum</th><th>Stok</th></tr></thead>
      <tbody id="locList"></tbody>
    </table>
    <div class="flex" style="justify-content:flex-end;margin-top:10px">
      <button onclick="document.getElementById('locModal').classList.remove('show')">Kapat</button>
    </div>
  </div>
</div>

<!-- Yeni ÃœrÃ¼n Ekleme Modal -->
<div class="modal" id="newProductModal">
  <div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0; color: var(--success);">ğŸ†• Yeni ÃœrÃ¼n Ekle</h3>
      <button onclick="closeNewProductModal()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">Ã—</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">SKU * <small style="color: var(--muted);">(Benzersiz kod)</small></label>
        <input id="newSku" required style="width: 100%;" placeholder="Ã–rn: PRD-001" />
        <small style="color: var(--muted); font-size: 11px;">Bu SKU daha Ã¶nce kullanÄ±lmamalÄ±</small>
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fiyat (â‚º)</label>
        <input id="newPrice" type="number" step="0.01" min="0" style="width: 100%;" placeholder="0.00" />
      </div>
      <div style="grid-column: 1 / -1;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">ÃœrÃ¼n AdÄ± *</label>
        <input id="newName" required style="width: 100%;" placeholder="ÃœrÃ¼n adÄ±nÄ± girin" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Ana Barkod <small style="color: var(--muted);">(Opsiyonel)</small></label>
        <input id="newBarcode" style="width: 100%;" placeholder="1234567890123" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Renk</label>
        <div style="position: relative;">
          <input 
            id="newColor" 
            list="newColorOptions" 
            placeholder="Renk yazÄ±n veya listeden seÃ§in" 
            style="width: 100%;"
          />
          <datalist id="newColorOptions">
            <option value="BEYAZ">
            <option value="SÄ°YAH">
            <option value="KAHVE">
            <option value="GRÄ°">
            <option value="ANTRASIT">
            <option value="KREM">
            <option value="LACÄ°VERT">
            <option value="BORDO">
            <option value="YEÅÄ°L">
            <option value="MAVÄ°">
            <option value="MOR">
            <option value="PEMBE">
            <option value="TURUNCU">
            <option value="SARI">
          </datalist>
        </div>
      </div>
      <div style="grid-column: 1 / -1;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">AÃ§Ä±klama</label>
        <textarea id="newDesc" rows="3" style="width: 100%; resize: vertical;" placeholder="ÃœrÃ¼n hakkÄ±nda detay bilgileri..."></textarea>
      </div>
    </div>
    
    <div class="card" style="background: var(--hover); margin-bottom: 20px; padding: 15px;">
      <h4 style="margin: 0 0 10px 0; color: var(--success);">ğŸ’¡ ÃœrÃ¼n Ekleme Ä°puÃ§larÄ±</h4>
      <ul style="margin: 0; padding-left: 20px; font-size: 0.9em; color: var(--muted);">
        <li>SKU benzersiz olmalÄ± (otomatik kontrol edilecek)</li>
        <li>ÃœrÃ¼n ekledikten sonra paketler ve konumlar ekleyebilirsiniz</li>
        <li>Renk seÃ§imi mÃ¼ÅŸteri deneyimini artÄ±rÄ±r</li>
        <li>Fiyat boÅŸ bÄ±rakÄ±labilir, daha sonra gÃ¼ncellenebilir</li>
        <li>Netsis entegrasyonu aktif olduÄŸunda otomatik senkronizasyon</li>
      </ul>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeNewProductModal()" style="background: var(--muted); color: var(--fg);">âŒ Ä°ptal</button>
      <button id="saveNewProductBtn" onclick="saveNewProduct()" class="btn-primary" style="background: var(--success);">
        âœ… ÃœrÃ¼nÃ¼ Ekle
      </button>
    </div>
  </div>
</div>

<div class="modal" id="editProductModal">
  <div class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="margin: 0;">ÃœrÃ¼n DÃ¼zenle: <span id="editProdName" style="color: var(--accent);"></span></h3>
      <button onclick="closeEditModal()" style="background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer;">Ã—</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">SKU *</label>
        <input id="editSku" required style="width: 100%;" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Fiyat</label>
        <input id="editPrice" type="number" step="0.01" style="width: 100%;" />
      </div>
      <div style="grid-column: 1 / -1;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">ÃœrÃ¼n AdÄ± *</label>
        <input id="editName" required style="width: 100%;" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Ana Barkod</label>
        <input id="editBarcode" style="width: 100%;" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Renk</label>
        <div style="position: relative;">
          <input 
            id="editColor" 
            list="colorOptions" 
            placeholder="Renk yazÄ±n veya listeden seÃ§in" 
            style="width: 100%;"
          />
          <datalist id="colorOptions">
            <option value="BEYAZ">
            <option value="SÄ°YAH">
            <option value="KAHVE">
            <option value="GRÄ°">
            <option value="ANTRASIT">
            <option value="KREM">
            <option value="LACÄ°VERT">
            <option value="BORDO">
            <option value="YEÅÄ°L">
            <option value="MAVÄ°">
            <option value="MOR">
            <option value="PEMBE">
            <option value="TURUNCU">
            <option value="SARI">
          </datalist>
        </div>
        <small style="color: var(--muted); font-size: 11px;">Ã–nerilen renkler: BEYAZ, SÄ°YAH, KAHVE, GRÄ°, ANTRASIT</small>
      </div>
      <div style="grid-column: 1 / -1;">
        <label style="display: block; margin-bottom: 5px; font-weight: 500;">AÃ§Ä±klama</label>
        <textarea id="editDesc" rows="3" style="width: 100%; resize: vertical;"></textarea>
      </div>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="closeEditModal()" style="background: var(--muted); color: var(--fg);">Ä°ptal</button>
      <button id="saveProductBtn" onclick="saveProduct()" class="btn-primary">Kaydet</button>
    </div>
  </div>
</div>


<script>
console.log('Script baÅŸlÄ±yor...');
const $ = (s)=>document.querySelector(s);
console.log('$ fonksiyonu tanÄ±mlandÄ±');
const API = {
  async listProducts(){ return fetch('/api/products').then(r=>r.json()) },
  async addProduct(p){ 
    const response = await fetch('/api/products',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'ÃœrÃ¼n eklenirken hata oluÅŸtu');
    return result;
  },
  async listPackages(id){ return fetch('/api/products/'+id+'/packages').then(r=>r.json()) },
  async addPackage(id,p){ 
    const response = await fetch('/api/products/'+id+'/packages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'Paket eklenirken hata oluÅŸtu');
    return result;
  },
  async updatePackage(id,p){ 
    const response = await fetch('/api/packages/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'Paket gÃ¼ncellenirken hata oluÅŸtu');
    return result;
  },
  async delPackage(id){ return fetch('/api/packages/'+id,{method:'DELETE'}).then(r=>r.json()) },
  async updateProduct(id,p){ return fetch('/api/products/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)}).then(r=>r.json()) },
  async deleteProduct(id){ return fetch('/api/products/'+id,{method:'DELETE'}).then(r=>r.json()) },
  async syncWix(){ return fetch('/api/sync/wix/products',{method:'POST'}).then(r=>r.json()) },
  async syncNetsis(){ return fetch('/api/sync/netsis/stockcards',{method:'POST'}).then(r=>r.json()) },
  async listLocations(){ return fetch('/api/locations').then(r=>r.json()) },
  async assignLocation(id, payload){ return fetch('/api/products/'+id+'/assign-location',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(r=>r.json()) },
  
  // PK Package Management API
  async searchPkProducts(query, mainProductId = null) {
    const params = new URLSearchParams();
    if (query) params.set('q', query);
    if (mainProductId) params.set('mainProductId', mainProductId);
    
    const response = await fetch(`/api/packages/search-pk-products?${params}`);
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'PK Ã¼rÃ¼n arama hatasÄ±');
    return result;
  },
  
  async autoMatchPkProducts(mainProductId = null) {
    const response = await fetch('/api/packages/auto-match', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ mainProductId })
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'Otomatik eÅŸleÅŸtirme hatasÄ±');
    return result;
  },
  
  async addPackageFromPk(mainProductId, packageSku, packageName, quantity = 1) {
    const response = await fetch('/api/packages/add', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ mainProductId, packageSku, packageName, quantity })
    });
    const result = await response.json();
    if (!response.ok) throw new Error(result.error || 'PK paket ekleme hatasÄ±');
    return result;
  }
};
console.log('API nesnesi tanÄ±mlandÄ±');

let products=[], filteredProducts=[], currentPage = 1, itemsPerPage = 20;
console.log('Global deÄŸiÅŸkenler tanÄ±mlandÄ±');

// Package editing state
let editingPackageId = null;
let currentProductId = null;
let currentEditingProduct = null;

// Renk iÃ§in background color belirleme
function getColorBg(color) {
  if (!color) return '#f8f9fa';
  const c = color.toUpperCase();
  if (c.includes('BEYAZ') || c.includes('WHITE')) return '#f8f9fa';
  if (c.includes('SÄ°YAH') || c.includes('BLACK')) return '#212529';
  if (c.includes('KAHVE') || c.includes('BROWN')) return '#8B4513';
  if (c.includes('GRÄ°') || c.includes('GRAY')) return '#6c757d';
  if (c.includes('ANTRASIT') || c.includes('ANTHRACITE')) return '#343a40';
  return '#17a2b8'; // default
}

// Renk iÃ§in text color belirleme
function getColorText(color) {
  if (!color) return '#000';
  const c = color.toUpperCase();
  if (c.includes('BEYAZ') || c.includes('WHITE')) return '#000';
  return '#fff'; // dark backgrounds iÃ§in white text
}

// Clear package form
function clearPackageForm() {
  // Turkish form
  $('#pkgNumber').value = '';
  $('#pkgNo').value = '';
  $('#pkgContent').value = '';
  $('#pkgColor').value = '';
  $('#pkgSku').value = '';
  $('#pkgBarcode').value = '';
  $('#pkgQty').value = 1;
  $('#pkgLength').value = '';
  $('#pkgWidth').value = '';
  $('#pkgHeight').value = '';
  $('#pkgWeight').value = '';
  $('#pkgVolume').value = '';
  
  // English form
  $('#pkgNumberEn').value = '';
  $('#pkgNoEn').value = '';
  $('#pkgContentEn').value = '';
  $('#pkgColorEn').value = '';
  $('#pkgSkuEn').value = '';
  $('#pkgBarcodeEn').value = '';
  $('#pkgQtyEn').value = 1;
  $('#pkgLengthEn').value = '';
  $('#pkgWidthEn').value = '';
  $('#pkgHeightEn').value = '';
  $('#pkgWeightEn').value = '';
  $('#pkgVolumeEn').value = '';
  
  editingPackageId = null;
  window.pendingPkPackage = null;
  const activeForm = getCurrentLanguage();
  $('#addPkgBtnText').textContent = activeForm === 'english' ? 'ğŸ“¦ Add Package' : 'ğŸ“¦ Paket Ekle';
  $('#cancelPkgBtn').style.display = 'none';
}

// Calculate volume automatically from dimensions
function calculateVolume() {
  const length = parseFloat($('#pkgLength').value) || 0;
  const width = parseFloat($('#pkgWidth').value) || 0;
  const height = parseFloat($('#pkgHeight').value) || 0;
  
  if (length > 0 && width > 0 && height > 0) {
    // Convert cmÂ³ to mÂ³ (divide by 1,000,000)
    const volumeM3 = (length * width * height) / 1000000;
    $('#pkgVolume').value = volumeM3.toFixed(3);
  } else {
    $('#pkgVolume').value = '';
  }
}

// Calculate volume for English form
function calculateVolumeEn() {
  const length = parseFloat($('#pkgLengthEn').value) || 0;
  const width = parseFloat($('#pkgWidthEn').value) || 0;
  const height = parseFloat($('#pkgHeightEn').value) || 0;
  
  if (length > 0 && width > 0 && height > 0) {
    // Convert cmÂ³ to mÂ³ (divide by 1,000,000)
    const volumeM3 = (length * width * height) / 1000000;
    $('#pkgVolumeEn').value = volumeM3.toFixed(3);
  } else {
    $('#pkgVolumeEn').value = '';
  }
}

// Cancel package editing
function cancelPackageEdit() {
  clearPackageForm();
}

// Generate barcode - only numbers
function generateBarcode() {
  const timestamp = Date.now().toString().slice(-8);
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  const barcode = `${timestamp}${random}`;
  const activeForm = getCurrentLanguage();
  if (activeForm === 'english') {
    $('#pkgBarcodeEn').value = barcode;
  } else {
    $('#pkgBarcode').value = barcode;
  }
}

// Open barcode selection modal
function openBarcodeSelectionModal() {
  // Reset modal state
  $('#manualBarcodeInput').style.display = 'none';
  $('#customBarcode').value = '';
  document.getElementById('barcodeSelectionModal').classList.add('show');
}

// Close barcode selection modal
function closeBarcodeSelectionModal() {
  document.getElementById('barcodeSelectionModal').classList.remove('show');
  $('#manualBarcodeInput').style.display = 'none';
  $('#customBarcode').value = '';
}

// Select barcode option
function selectBarcodeOption(option) {
  if (option === 'auto') {
    // Generate automatic barcode
    generateBarcode();
    closeBarcodeSelectionModal();
    proceedWithPackageAdd();
  } else if (option === 'manual') {
    // Show manual input
    $('#manualBarcodeInput').style.display = 'block';
    $('#customBarcode').focus();
  }
}

// Confirm manual barcode
function confirmManualBarcode() {
  const customBarcode = $('#customBarcode').value?.trim();
  if (!customBarcode) {
    alert('LÃ¼tfen barkod girin!');
    return;
  }
  
  // Set barcode for active form
  const activeForm = getCurrentLanguage();
  if (activeForm === 'english') {
    $('#pkgBarcodeEn').value = customBarcode;
  } else {
    $('#pkgBarcode').value = customBarcode;
  }
  
  closeBarcodeSelectionModal();
  proceedWithPackageAdd();
}

// Cancel manual barcode
function cancelManualBarcode() {
  $('#manualBarcodeInput').style.display = 'none';
  $('#customBarcode').value = '';
}

// Proceed with package add after barcode selection
async function proceedWithPackageAdd() {
  const activeForm = getCurrentLanguage();
  
  // Get form values based on active language
  let packageNumber, packageNo, barcode, packageContent, packageColor, packageSku, quantity, length, width, height, weight, volume;
  
  if (activeForm === 'english') {
    packageNumber = $('#pkgNumberEn').value?.trim();
    packageNo = $('#pkgNoEn').value?.trim();
    barcode = $('#pkgBarcodeEn').value?.trim();
    packageContent = $('#pkgContentEn').value?.trim();
    packageColor = $('#pkgColorEn').value?.trim();
    packageSku = $('#pkgSkuEn').value?.trim();
    quantity = parseInt($('#pkgQtyEn').value||1,10);
    length = parseFloat($('#pkgLengthEn').value) || null;
    width = parseFloat($('#pkgWidthEn').value) || null;
    height = parseFloat($('#pkgHeightEn').value) || null;
    weight = parseFloat($('#pkgWeightEn').value) || null;
    volume = parseFloat($('#pkgVolumeEn').value) || null;
  } else {
    packageNumber = $('#pkgNumber').value?.trim();
    packageNo = $('#pkgNo').value?.trim();
    barcode = $('#pkgBarcode').value?.trim();
    packageContent = $('#pkgContent').value?.trim();
    packageColor = $('#pkgColor').value?.trim();
    packageSku = $('#pkgSku').value?.trim();
    quantity = parseInt($('#pkgQty').value||1,10);
    length = parseFloat($('#pkgLength').value) || null;
    width = parseFloat($('#pkgWidth').value) || null;
    height = parseFloat($('#pkgHeight').value) || null;
    weight = parseFloat($('#pkgWeight').value) || null;
    volume = parseFloat($('#pkgVolume').value) || null;
  }
  
  if (!barcode) {
    alert(activeForm === 'english' ? 'Barcode is required!' : 'Barkod zorunludur!');
    openBarcodeSelectionModal();
    return;
  }
  
  const p = { 
    package_number: packageNumber || null,
    package_no: packageNo || null,
    package_content: packageContent || null,
    // Store current form data in appropriate language field
    package_name_tr: activeForm === 'turkish' ? packageNumber : ($('#pkgNumber').value?.trim() || null),
    package_name_en: activeForm === 'english' ? packageNumber : ($('#pkgNumberEn').value?.trim() || null),
    package_content_tr: activeForm === 'turkish' ? packageContent : ($('#pkgContent').value?.trim() || null),
    package_content_en: activeForm === 'english' ? packageContent : ($('#pkgContentEn').value?.trim() || null),
    color_tr: activeForm === 'turkish' ? packageColor : ($('#pkgColor').value?.trim() || null),
    color_en: activeForm === 'english' ? packageColor : ($('#pkgColorEn').value?.trim() || null),
    sku: packageSku || null,
    barcode: barcode, 
    quantity: quantity,
    length_cm: length,
    width_cm: width,
    height_cm: height,
    weight_kg: weight,
    volume_m3: volume
  };
  
  console.log('Package data being sent:', p);
  
  try {
    if (editingPackageId) {
      // Update existing package
      await API.updatePackage(editingPackageId, p);
    } else if (window.pendingPkPackage) {
      // Add PK package with all form data instead of using simplified API
      p.package_name = packageNumber; // Use packageNumber as package_name for compatibility
      await API.addPackage(currentProductId, p);
      // Clear pending PK package
      window.pendingPkPackage = null;
    } else {
      // Add new package
      await API.addPackage(currentProductId, p);
    }
  } catch (error) {
    alert(error.message || 'Bir hata oluÅŸtu');
    return;
  }
  
  await refresh();
  await refreshPackageList();
  clearPackageForm();
}

// Display PK search results
function displayPkSearchResults(packages) {
  const resultsContainer = $('#pkSearchResults');
  
  if (!packages || packages.length === 0) {
    resultsContainer.innerHTML = '<div style="padding: 15px; text-align: center; color: var(--muted);">PK Ã¼rÃ¼n bulunamadÄ±</div>';
    resultsContainer.style.display = 'block';
    return;
  }
  
  const resultsHtml = packages.map(pkg => `
    <div style="padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
      <div style="flex: 1;">
        <div style="font-weight: 600; color: var(--primary);">${pkg.sku}</div>
        <div style="font-size: 0.9em; color: var(--muted); margin-top: 2px;">${pkg.name}</div>
        ${pkg.description ? `<div style="font-size: 0.85em; color: var(--muted); margin-top: 2px;">${pkg.description}</div>` : ''}
      </div>
      <button class="btn-sm" onclick="addPkPackage('${pkg.sku}', '${pkg.name.replace(/'/g, '\\\'')}')" 
              style="background: var(--success); color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
        â• Ekle
      </button>
    </div>
  `).join('');
  
  resultsContainer.innerHTML = resultsHtml;
  resultsContainer.style.display = 'block';
}

// Get current active language
function getCurrentLanguage() {
  return document.getElementById('englishForm').style.display === 'none' ? 'turkish' : 'english';
}

// Switch language tab
function switchLanguageTab(language) {
  const turkishTab = $('#turkishTab');
  const englishTab = $('#englishTab');
  const turkishForm = $('#turkishForm');
  const englishForm = $('#englishForm');
  const packageListTurkish = $('#packageListTurkish');
  const packageListEnglish = $('#packageListEnglish');
  
  if (language === 'turkish') {
    turkishTab.classList.add('active');
    englishTab.classList.remove('active');
    turkishTab.style.background = 'var(--primary)';
    englishTab.style.background = 'var(--muted)';
    turkishForm.style.display = 'block';
    englishForm.style.display = 'none';
    packageListTurkish.style.display = 'block';
    packageListEnglish.style.display = 'none';
    $('#addPkgBtnText').textContent = editingPackageId ? 'âœï¸ Paketi GÃ¼ncelle' : 'ğŸ“¦ Paket Ekle';
    $('#cancelBtnText').textContent = 'Ä°ptal';
  } else {
    englishTab.classList.add('active');
    turkishTab.classList.remove('active');
    englishTab.style.background = 'var(--primary)';
    turkishTab.style.background = 'var(--muted)';
    turkishForm.style.display = 'none';
    englishForm.style.display = 'block';
    packageListTurkish.style.display = 'none';
    packageListEnglish.style.display = 'block';
    $('#addPkgBtnText').textContent = editingPackageId ? 'âœï¸ Update Package' : 'ğŸ“¦ Add Package';
    $('#cancelBtnText').textContent = 'Cancel';
  }
  
  // Refresh package list to show in correct language
  refreshPackageList();
}

// Add PK package to main product
async function addPkPackage(packageSku, packageName) {
  if (!currentProductId) {
    alert('Ana Ã¼rÃ¼n seÃ§ili deÄŸil');
    return;
  }
  
  // Store PK info and fill form with PK data
  window.pendingPkPackage = { packageSku, packageName };
  
  // Get main product name for default package name
  const mainProduct = products.find(p => p.id == currentProductId);
  const mainProductName = mainProduct ? mainProduct.name : '';
  
  const activeForm = getCurrentLanguage();
  
  // Fill common fields (shared)
  $('#pkgSku').value = packageSku;
  $('#pkgSkuEn').value = packageSku;
  $('#pkgBarcode').value = '';
  $('#pkgBarcodeEn').value = '';
  
  // Fill ONLY the active language-specific fields (DO NOT fill both)
  if (activeForm === 'english') {
    $('#pkgNumberEn').value = mainProductName;
    $('#pkgContentEn').value = '';
    $('#pkgColorEn').value = '';
    // DO NOT fill Turkish fields
  } else {
    $('#pkgNumber').value = mainProductName;
    $('#pkgContent').value = '';
    $('#pkgColor').value = '';
    // DO NOT fill English fields
  }
  
  // Clear search results
  $('#pkSearchResults').style.display = 'none';
  $('#pkSearchInput').value = '';
}

// Refresh package list
async function refreshPackageList() {
  if (!currentProductId) return;
  
  try {
    const list = await API.listPackages(currentProductId);
    const activeLanguage = getCurrentLanguage();
    
    // Turkish table
    const tbTurkish = $('#pkgList');
    tbTurkish.innerHTML = list.length ? list.map(pp=>`
      <tr>
        <td><strong>${pp.package_no || '-'}</strong></td>
        <td>
          <div><strong>Ad:</strong> ${pp.package_name_tr || pp.package_number || '-'}</div>
          <div><strong>Ä°Ã§erik:</strong> ${pp.package_content_tr || pp.package_content || '-'}</div>
          ${pp.color_tr ? `<div><strong>Renk:</strong> <span style="background: var(--hover); padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${pp.color_tr}</span></div>` : ''}
        </td>
        <td><code style="background: var(--hover); padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${pp.barcode}</code></td>
        <td style="text-align: center;"><span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">${pp.quantity}</span></td>
        <td style="text-align: center;">${pp.weight_kg ? pp.weight_kg + ' kg' : '-'}</td>
        <td style="text-align: center;">${pp.volume_m3 ? pp.volume_m3 + ' mÂ³' : '-'}</td>
        <td style="text-align: center;">
          <button data-pkedit="${pp.id}" style="background: var(--warning); color: white; border: none; border-radius: 4px; margin-right: 5px; padding: 6px 10px; font-size: 0.85em;">âœï¸ DÃ¼zenle</button>
          <button data-pkdel="${pp.id}" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 6px 10px; font-size: 0.85em;">ğŸ—‘ï¸ Sil</button>
        </td>
      </tr>
    `).join('') : '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--muted);"><em>HenÃ¼z paket tanÄ±mlanmamÄ±ÅŸ</em></td></tr>';
    
    // English table
    const tbEnglish = $('#pkgListEn');
    tbEnglish.innerHTML = list.length ? list.map(pp=>`
      <tr>
        <td><strong>${pp.package_no || '-'}</strong></td>
        <td>
          <div><strong>Name:</strong> ${pp.package_name_en || pp.package_number || '-'}</div>
          <div><strong>Content:</strong> ${pp.package_content_en || pp.package_content || '-'}</div>
          ${pp.color_en ? `<div><strong>Color:</strong> <span style="background: var(--hover); padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${pp.color_en}</span></div>` : ''}
        </td>
        <td><code style="background: var(--hover); padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${pp.barcode}</code></td>
        <td style="text-align: center;"><span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">${pp.quantity}</span></td>
        <td style="text-align: center;">${pp.weight_kg ? pp.weight_kg + ' kg' : '-'}</td>
        <td style="text-align: center;">${pp.volume_m3 ? pp.volume_m3 + ' mÂ³' : '-'}</td>
        <td style="text-align: center;">
          <button data-pkedit="${pp.id}" style="background: var(--warning); color: white; border: none; border-radius: 4px; margin-right: 5px; padding: 6px 10px; font-size: 0.85em;">âœï¸ Edit</button>
          <button data-pkdel="${pp.id}" style="background: var(--danger); color: white; border: none; border-radius: 4px; padding: 6px 10px; font-size: 0.85em;">ğŸ—‘ï¸ Delete</button>
        </td>
      </tr>
    `).join('') : '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--muted);"><em>No packages defined yet</em></td></tr>';
    
    // Also refresh main products list to show updated package count
    await refresh();
  } catch (error) {
    console.error('Package list refresh error:', error);
  }
}

// Edit product modal functions
function openEditModal(product) {
  currentEditingProduct = product;
  $('#editProdName').textContent = `${product.name} (${product.sku})`;
  $('#editSku').value = product.sku || '';
  $('#editName').value = product.name || '';
  $('#editPrice').value = product.price || '';
  $('#editBarcode').value = product.main_barcode || '';
  $('#editColor').value = product.color || '';
  $('#editDesc').value = product.description || '';
  
  document.getElementById('editProductModal').classList.add('show');
}

function closeEditModal() {
  currentEditingProduct = null;
  document.getElementById('editProductModal').classList.remove('show');
}

// New product modal functions
function openNewProductModal() {
  // Form temizle
  clearNewProductForm();
  document.getElementById('newProductModal').classList.add('show');
}

function closeNewProductModal() {
  clearNewProductForm();
  document.getElementById('newProductModal').classList.remove('show');
}

function clearNewProductForm() {
  $('#newSku').value = '';
  $('#newName').value = '';
  $('#newPrice').value = '';
  $('#newBarcode').value = '';
  $('#newColor').value = '';
  $('#newDesc').value = '';
  
  // Validation mesajlarÄ±nÄ± temizle
  document.querySelectorAll('#newProductModal .validation-error').forEach(el => el.remove());
  document.querySelectorAll('#newProductModal input, #newProductModal textarea').forEach(el => {
    el.style.borderColor = '';
  });
}

// SKU benzersizlik kontrolÃ¼
async function validateSKU(sku) {
  if (!sku) return { valid: false, message: 'SKU zorunludur' };
  
  // Format kontrolÃ¼ (en az 3 karakter, harf-rakam-tire)
  if (!/^[A-Z0-9\-]{3,}$/i.test(sku)) {
    return { valid: false, message: 'SKU en az 3 karakter olmalÄ± ve sadece harf, rakam, tire iÃ§ermeli' };
  }
  
  // Benzersizlik kontrolÃ¼
  const existingProduct = products.find(p => p.sku.toLowerCase() === sku.toLowerCase());
  if (existingProduct) {
    return { valid: false, message: 'Bu SKU zaten kullanÄ±lÄ±yor' };
  }
  
  return { valid: true };
}

// Form validation
function validateNewProductForm() {
  const sku = $('#newSku').value.trim().toUpperCase();
  const name = $('#newName').value.trim();
  const price = $('#newPrice').value;
  
  // Ã–nceki hata mesajlarÄ±nÄ± temizle
  document.querySelectorAll('#newProductModal .validation-error').forEach(el => el.remove());
  document.querySelectorAll('#newProductModal input, #newProductModal textarea').forEach(el => {
    el.style.borderColor = '';
  });
  
  let hasErrors = false;
  
  // SKU kontrolÃ¼
  if (!sku) {
    showValidationError('newSku', 'SKU zorunludur');
    hasErrors = true;
  }
  
  // Ä°sim kontrolÃ¼
  if (!name || name.length < 2) {
    showValidationError('newName', 'ÃœrÃ¼n adÄ± en az 2 karakter olmalÄ±');
    hasErrors = true;
  }
  
  // Fiyat kontrolÃ¼ (opsiyonel ama pozitif olmalÄ±)
  if (price && (isNaN(price) || parseFloat(price) < 0)) {
    showValidationError('newPrice', 'Fiyat pozitif bir sayÄ± olmalÄ±');
    hasErrors = true;
  }
  
  return !hasErrors;
}

function showValidationError(inputId, message) {
  const input = document.getElementById(inputId);
  input.style.borderColor = 'var(--danger)';
  
  const error = document.createElement('div');
  error.className = 'validation-error';
  error.style.cssText = 'color: var(--danger); font-size: 0.8em; margin-top: 5px;';
  error.textContent = message;
  
  input.parentNode.appendChild(error);
}

async function saveNewProduct() {
  // Form validation
  if (!validateNewProductForm()) {
    return;
  }
  
  const sku = $('#newSku').value.trim().toUpperCase();
  const name = $('#newName').value.trim();
  
  // SKU benzersizlik kontrolÃ¼
  const skuValidation = await validateSKU(sku);
  if (!skuValidation.valid) {
    showValidationError('newSku', skuValidation.message);
    return;
  }
  
  const saveBtn = $('#saveNewProductBtn');
  const originalText = saveBtn.innerHTML;
  saveBtn.innerHTML = 'â³ Kaydediliyor...';
  saveBtn.disabled = true;
  
  try {
    const productData = {
      sku: sku,
      name: name,
      price: parseFloat($('#newPrice').value) || 0,
      main_barcode: $('#newBarcode').value.trim() || null,
      color: $('#newColor').value.trim() || null,
      description: $('#newDesc').value.trim() || null
    };
    
    const newProduct = await API.addProduct(productData);
    
    // BaÅŸarÄ± mesajÄ±
    alert(`âœ… ÃœrÃ¼n baÅŸarÄ±yla eklendi!\n\nSKU: ${newProduct.sku}\nAd: ${newProduct.name}\n\nArtÄ±k paket ve konum ekleyebilirsiniz.`);
    
    await refresh();
    closeNewProductModal();
    
    // Yeni eklenen Ã¼rÃ¼nÃ¼ vurgula (opsiyonel)
    setTimeout(() => {
      const newRow = document.querySelector(`[data-edit="${newProduct.id}"]`)?.closest('tr');
      if (newRow) {
        newRow.style.background = 'var(--success)';
        newRow.style.color = 'white';
        setTimeout(() => {
          newRow.style.background = '';
          newRow.style.color = '';
        }, 2000);
      }
    }, 100);
    
  } catch (error) {
    alert('âŒ ÃœrÃ¼n ekleme hatasÄ±:\n' + error.message);
  } finally {
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

// Global scope iÃ§in window'a ekle
window.closeEditModal = closeEditModal;
window.openEditModal = openEditModal;
window.openNewProductModal = openNewProductModal;
window.closeNewProductModal = closeNewProductModal;
window.saveNewProduct = saveNewProduct;

async function saveProduct() {
  if (!currentEditingProduct) return;
  
  const sku = $('#editSku').value.trim();
  const name = $('#editName').value.trim();
  
  if (!sku || !name) {
    alert('SKU ve ÃœrÃ¼n AdÄ± zorunludur!');
    return;
  }
  
  const saveBtn = $('#saveProductBtn');
  const originalText = saveBtn.textContent;
  saveBtn.textContent = 'Kaydediliyor...';
  saveBtn.disabled = true;
  
  try {
    const updatedData = {
      sku: sku,
      name: name,
      price: parseFloat($('#editPrice').value) || 0,
      main_barcode: $('#editBarcode').value.trim() || null,
      color: $('#editColor').value || null,
      description: $('#editDesc').value.trim() || null
    };
    
    await API.updateProduct(currentEditingProduct.id, updatedData);
    await refresh();
    closeEditModal();
  } catch (error) {
    alert('GÃ¼ncelleme hatasÄ±: ' + error.message);
  } finally {
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  }
}

// saveProduct'Ä± da global scope'a ekle
window.saveProduct = saveProduct;

// PK package management functions
window.addPkPackage = addPkPackage;
window.refreshPackageList = refreshPackageList;
window.displayPkSearchResults = displayPkSearchResults;
// Barcode selection functions
window.generateBarcode = generateBarcode;
window.openBarcodeSelectionModal = openBarcodeSelectionModal;
window.closeBarcodeSelectionModal = closeBarcodeSelectionModal;
window.selectBarcodeOption = selectBarcodeOption;
window.confirmManualBarcode = confirmManualBarcode;
window.cancelManualBarcode = cancelManualBarcode;
// Volume calculation
window.calculateVolume = calculateVolume;
window.calculateVolumeEn = calculateVolumeEn;
// Language switching
window.switchLanguageTab = switchLanguageTab;
window.getCurrentLanguage = getCurrentLanguage;

// Load package data for editing
function loadPackageForEdit(pkg) {
  const activeForm = getCurrentLanguage();
  
  // Common fields (shared between languages)
  $('#pkgNo').value = pkg.package_no || '';
  $('#pkgNoEn').value = pkg.package_no || '';
  $('#pkgSku').value = pkg.sku || '';
  $('#pkgSkuEn').value = pkg.sku || '';
  $('#pkgBarcode').value = pkg.barcode || '';
  $('#pkgBarcodeEn').value = pkg.barcode || '';
  $('#pkgQty').value = pkg.quantity || 1;
  $('#pkgQtyEn').value = pkg.quantity || 1;
  $('#pkgLength').value = pkg.length_cm || '';
  $('#pkgLengthEn').value = pkg.length_cm || '';
  $('#pkgWidth').value = pkg.width_cm || '';
  $('#pkgWidthEn').value = pkg.width_cm || '';
  $('#pkgHeight').value = pkg.height_cm || '';
  $('#pkgHeightEn').value = pkg.height_cm || '';
  $('#pkgWeight').value = pkg.weight_kg || '';
  $('#pkgWeightEn').value = pkg.weight_kg || '';
  $('#pkgVolume').value = pkg.volume_m3 || '';
  $('#pkgVolumeEn').value = pkg.volume_m3 || '';
  
  // Language-specific fields
  $('#pkgNumber').value = pkg.package_name_tr || pkg.package_number || '';
  $('#pkgContent').value = pkg.package_content_tr || pkg.package_content || '';
  $('#pkgColor').value = pkg.color_tr || '';
  $('#pkgNumberEn').value = pkg.package_name_en || pkg.package_number || '';
  $('#pkgContentEn').value = pkg.package_content_en || pkg.package_content || '';
  $('#pkgColorEn').value = pkg.color_en || '';
  
  editingPackageId = pkg.id;
  $('#addPkgBtnText').textContent = activeForm === 'english' ? 'âœï¸ Update Package' : 'âœï¸ Paketi GÃ¼ncelle';
  $('#cancelPkgBtn').style.display = 'inline-block';
}

// Filtreleme ve arama fonksiyonu
function filterProducts() {
  const searchTerm = $('#searchInput').value.toLowerCase();
  const statusFilter = $('#statusFilter').value;
  const sortBy = $('#sortBy').value;

  // Arama filtresi
  filteredProducts = products.filter(p => {
    const matchesSearch = !searchTerm || 
      p.sku.toLowerCase().includes(searchTerm) ||
      p.name.toLowerCase().includes(searchTerm) ||
      (p.main_barcode && p.main_barcode.toLowerCase().includes(searchTerm));
    
    // Durum filtresi
    let matchesStatus = true;
    if (statusFilter === 'no-packages') {
      matchesStatus = !p.packages || p.packages.length === 0;
    } else if (statusFilter === 'no-location') {
      matchesStatus = !p.location_codes || p.location_codes.length === 0;
    } else if (statusFilter === 'stocked') {
      matchesStatus = p.location_codes && p.location_codes.length > 0;
    } else if (statusFilter === 'out-of-stock') {
      matchesStatus = !p.location_codes || p.location_codes.length === 0;
    }
    
    return matchesSearch && matchesStatus;
  });

  // SÄ±ralama
  filteredProducts.sort((a, b) => {
    switch(sortBy) {
      case 'sku': return a.sku.localeCompare(b.sku);
      case 'price': return (a.price || 0) - (b.price || 0);
      case 'created': return new Date(b.created_at) - new Date(a.created_at);
      default: return a.name.localeCompare(b.name);
    }
  });

  currentPage = 1;
  currentFilteredProducts = filteredProducts; // Global deÄŸiÅŸken gÃ¼ncelle
  renderProducts();
}

// ÃœrÃ¼nleri render et
function renderProducts() {
  console.log('ğŸ“‹ Render baÅŸlatÄ±lÄ±yor. FiltrelenmiÅŸ Ã¼rÃ¼n sayÄ±sÄ±:', filteredProducts.length);
  const startIdx = (currentPage - 1) * itemsPerPage;
  const endIdx = startIdx + itemsPerPage;
  const pageProducts = filteredProducts.slice(startIdx, endIdx);
  console.log('ğŸ“„ Sayfada gÃ¶sterilecek Ã¼rÃ¼nler:', pageProducts.length);
  
  const tb = $('#prodTable tbody');
  tb.innerHTML = pageProducts.map(p => {
    // Wix stok miktarÄ±na gÃ¶re durumu belirle
    const wixStock = p.inventory_quantity || 0;
    const stockInfo = wixStock > 0 ? `âœ… Stok: ${wixStock}` : 'âŒ Stok Yok';
    const stockClass = wixStock > 0 ? 'in-stock' : 'out-of-stock';
    
    return `<tr>
      <td><input type="checkbox" class="product-select" value="${p.id}"></td>
      <td>
        <div class="product-image">ğŸ“¦</div>
      </td>
      <td>
        <code class="proper-sku">${p.sku}</code>
      </td>
      <td>
        <div class="product-name">${p.name}</div>
        ${p.description ? `<small>${p.description}</small>` : ''}
      </td>
      <td><strong>â‚º${(p.price||0).toFixed(2)}</strong></td>
      <td>
        <span class="stock-status ${stockClass}">
          ${stockInfo}
        </span>
      </td>
      <td>
        ${p.color ? `<span style="background: ${getColorBg(p.color)}; color: ${getColorText(p.color)}; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">${p.color}</span>` : '<span class="no-color">-</span>'}
      </td>
      <td>
        <div class="locations">
          ${(p.location_codes||[]).map(loc => `<span class="location-tag">${loc}</span>`).join('') || '<span class="no-location">Konum Yok</span>'}
        </div>
      </td>
      <td>
        <span class="badge package-count">${(p.packages||[]).length} paket</span>
      </td>
      <td>
        <small>${new Date(p.updated_at || p.created_at).toLocaleDateString('tr-TR')}</small>
      </td>
      <td class="actions">
        <button class="btn-sm" data-pkg="${p.id}" title="Paketleri YÃ¶net">ğŸ“¦</button>
        <button class="btn-sm" data-loc="${p.id}" title="Konum Ata">ğŸ“</button>
        <button class="btn-sm" data-edit="${p.id}" title="DÃ¼zenle">âœï¸</button>
        <button class="btn-sm btn-danger" data-del="${p.id}" title="Sil">ğŸ—‘ï¸</button>
      </td>
    </tr>`;
  }).join('');

  // Sayfa bilgisini gÃ¼ncelle
  $('#productCount').textContent = filteredProducts.length;
  
  // Pagination render et
  renderPagination();
}

// Pagination
function renderPagination() {
  const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
  const pagination = $('#pagination');
  
  if (totalPages <= 1) {
    pagination.innerHTML = '';
    return;
  }
  
  let paginationHtml = '';
  
  // Ã–nceki sayfa
  if (currentPage > 1) {
    paginationHtml += `<button class="page-btn" onclick="changePage(${currentPage - 1})">&laquo; Ã–nceki</button>`;
  }
  
  // Sayfa numaralarÄ±
  for (let i = 1; i <= totalPages; i++) {
    if (i === currentPage) {
      paginationHtml += `<button class="page-btn active">${i}</button>`;
    } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 2) {
      paginationHtml += `<button class="page-btn" onclick="changePage(${i})">${i}</button>`;
    } else if (i === currentPage - 3 || i === currentPage + 3) {
      paginationHtml += `<span class="page-dots">...</span>`;
    }
  }
  
  // Sonraki sayfa
  if (currentPage < totalPages) {
    paginationHtml += `<button class="page-btn" onclick="changePage(${currentPage + 1})">Sonraki &raquo;</button>`;
  }
  
  pagination.innerHTML = paginationHtml;
}

// Sayfa deÄŸiÅŸtirme (global scope'ta tanÄ±mlanmalÄ±)
window.changePage = function(page) {
  currentPage = page;
  renderProducts();
}

// Ana refresh fonksiyonu
async function refresh(){
  try {
    console.log('ğŸ”„ ÃœrÃ¼nler yÃ¼kleniyor...');
    products = await API.listProducts();
    console.log('âœ… ÃœrÃ¼nler yÃ¼klendi:', products.length, 'Ã¼rÃ¼n');
    filteredProducts = [...products];
    currentFilteredProducts = filteredProducts; // Global deÄŸiÅŸken gÃ¼ncelle
    renderProducts();
  } catch (error) {
    console.error('âŒ ÃœrÃ¼nler yÃ¼klenirken hata:', error);
    alert('ÃœrÃ¼nler yÃ¼klenirken hata oluÅŸtu: ' + error.message);
  }
}


// Event listeners
document.addEventListener('DOMContentLoaded', () => {
  // Yeni Ã¼rÃ¼n ekleme butonu
  $('#addNewProduct').addEventListener('click', openNewProductModal);
  
  // Arama ve filtreler
  $('#searchInput').addEventListener('input', filterProducts);
  $('#statusFilter').addEventListener('change', filterProducts);
  $('#sortBy').addEventListener('change', filterProducts);
  
  // Filtreleri temizle
  $('#clearFilters').addEventListener('click', () => {
    $('#searchInput').value = '';
    $('#statusFilter').value = '';
    $('#sortBy').value = 'name';
    filterProducts();
  });
  
  // TÃ¼mÃ¼nÃ¼ seÃ§/kaldÄ±r
  $('#selectAll').addEventListener('change', (e) => {
    const checkboxes = document.querySelectorAll('.product-select');
    checkboxes.forEach(cb => cb.checked = e.target.checked);
  });
  
  // CSV export
  $('#exportProducts').addEventListener('click', () => {
    const selected = getSelectedProducts();
    const dataToExport = selected.length > 0 ? selected : filteredProducts;
    exportToCSV(dataToExport);
  });
  
  // Package form cancel button
  $('#cancelPkgBtn').addEventListener('click', () => {
    clearPackageForm();
  });
  
  // PK Search functionality
  $('#searchPkBtn').addEventListener('click', async () => {
    const query = $('#pkSearchInput').value.trim();
    if (!query) {
      alert('Arama iÃ§in PK kodu girin');
      return;
    }
    
    try {
      $('#searchPkBtn').textContent = 'â³ AranÄ±yor...';
      const result = await API.searchPkProducts(query, currentProductId);
      displayPkSearchResults(result.packages);
    } catch (error) {
      alert(`Arama hatasÄ±: ${error.message}`);
    } finally {
      $('#searchPkBtn').textContent = 'ğŸ” Ara';
    }
  });
  
  // Auto-match PK products
  $('#autoMatchPkBtn').addEventListener('click', async () => {
    if (!currentProductId) {
      alert('Bir ana Ã¼rÃ¼n seÃ§ili deÄŸil');
      return;
    }
    
    const confirmed = confirm('Bu ana Ã¼rÃ¼ne ait tÃ¼m PK Ã¼rÃ¼nleri otomatik olarak eÅŸleÅŸtirilecek. Devam edilsin mi?');
    if (!confirmed) return;
    
    try {
      $('#autoMatchPkBtn').textContent = 'â³ EÅŸleÅŸtiriliyor...';
      const result = await API.autoMatchPkProducts(currentProductId);
      
      alert(`âœ… ${result.matchCount} paket otomatik olarak eÅŸleÅŸtirildi!`);
      
      // Refresh package list
      await refreshPackageList();
    } catch (error) {
      alert(`Otomatik eÅŸleÅŸtirme hatasÄ±: ${error.message}`);
    } finally {
      $('#autoMatchPkBtn').textContent = 'ğŸ¤– Otomatik EÅŸleÅŸtir';
    }
  });
  
  // PK search input - Enter key support
  $('#pkSearchInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      $('#searchPkBtn').click();
    }
  });
  
  // Real-time SKU validation
  $('#newSku').addEventListener('input', async (e) => {
    const sku = e.target.value.trim().toUpperCase();
    e.target.value = sku; // Auto uppercase
    
    if (sku.length >= 3) {
      const validation = await validateSKU(sku);
      
      // Ã–nceki mesajlarÄ± temizle
      const existingError = e.target.parentNode.querySelector('.validation-error');
      if (existingError) existingError.remove();
      
      if (!validation.valid) {
        showValidationError('newSku', validation.message);
      } else {
        e.target.style.borderColor = 'var(--success)';
      }
    }
  });
  
  // Sync common fields between Turkish and English forms
  function syncCommonFields() {
    // Package No sync
    $('#pkgNo').addEventListener('input', (e) => {
      $('#pkgNoEn').value = e.target.value;
    });
    $('#pkgNoEn').addEventListener('input', (e) => {
      $('#pkgNo').value = e.target.value;
    });
    
    // SKU sync
    $('#pkgSku').addEventListener('input', (e) => {
      $('#pkgSkuEn').value = e.target.value;
    });
    $('#pkgSkuEn').addEventListener('input', (e) => {
      $('#pkgSku').value = e.target.value;
    });
    
    // Barcode sync
    $('#pkgBarcode').addEventListener('input', (e) => {
      $('#pkgBarcodeEn').value = e.target.value;
    });
    $('#pkgBarcodeEn').addEventListener('input', (e) => {
      $('#pkgBarcode').value = e.target.value;
    });
    
    // Quantity sync
    $('#pkgQty').addEventListener('input', (e) => {
      $('#pkgQtyEn').value = e.target.value;
    });
    $('#pkgQtyEn').addEventListener('input', (e) => {
      $('#pkgQty').value = e.target.value;
    });
    
    // Length sync
    $('#pkgLength').addEventListener('input', (e) => {
      $('#pkgLengthEn').value = e.target.value;
      calculateVolume();
      calculateVolumeEn();
    });
    $('#pkgLengthEn').addEventListener('input', (e) => {
      $('#pkgLength').value = e.target.value;
      calculateVolume();
      calculateVolumeEn();
    });
    
    // Width sync
    $('#pkgWidth').addEventListener('input', (e) => {
      $('#pkgWidthEn').value = e.target.value;
      calculateVolume();
      calculateVolumeEn();
    });
    $('#pkgWidthEn').addEventListener('input', (e) => {
      $('#pkgWidth').value = e.target.value;
      calculateVolume();
      calculateVolumeEn();
    });
    
    // Height sync
    $('#pkgHeight').addEventListener('input', (e) => {
      $('#pkgHeightEn').value = e.target.value;
      calculateVolume();
      calculateVolumeEn();
    });
    $('#pkgHeightEn').addEventListener('input', (e) => {
      $('#pkgHeight').value = e.target.value;
      calculateVolume();
      calculateVolumeEn();
    });
    
    // Weight sync
    $('#pkgWeight').addEventListener('input', (e) => {
      $('#pkgWeightEn').value = e.target.value;
    });
    $('#pkgWeightEn').addEventListener('input', (e) => {
      $('#pkgWeight').value = e.target.value;
    });
    
    // Volume sync (readonly, but sync anyway)
    $('#pkgVolume').addEventListener('input', (e) => {
      $('#pkgVolumeEn').value = e.target.value;
    });
    $('#pkgVolumeEn').addEventListener('input', (e) => {
      $('#pkgVolume').value = e.target.value;
    });
  }
  
  // Initialize common field sync
  syncCommonFields();
  
});


// CSV export fonksiyonu
function exportToCSV(products) {
  const headers = [
    'SKU', 
    'Ad', 
    'Fiyat', 
    'Stok', 
    'Konum', 
    'Paket SayÄ±sÄ±',
    'Paket DetaylarÄ±',
    'Son GÃ¼ncelleme'
  ];
  
  const csvContent = [
    headers.join(','),
    ...products.map(p => {
      // Paket detaylarÄ±nÄ± formatted string olarak hazÄ±rla
      const packageDetails = (p.packages || []).map(pkg => {
        const parts = [];
        if (pkg.package_name) parts.push(`Ad:${pkg.package_name}`);
        if (pkg.barcode) parts.push(`Barkod:${pkg.barcode}`);
        if (pkg.quantity) parts.push(`Adet:${pkg.quantity}`);
        if (pkg.package_number) parts.push(`No:${pkg.package_number}`);
        if (pkg.package_content) parts.push(`Ä°Ã§erik:${pkg.package_content}`);
        if (pkg.weight_kg) parts.push(`AÄŸÄ±rlÄ±k:${pkg.weight_kg}kg`);
        if (pkg.volume_m3) parts.push(`Hacim:${pkg.volume_m3}mÂ³`);
        return parts.join('|');
      }).join('; ');
      
      return [
        p.sku,
        `"${p.name}"`,
        p.price || 0,
        p.inventory_quantity || 0,
        (p.location_codes || []).join(';'),
        (p.packages || []).length,
        `"${packageDetails}"`,
        p.updated_at || p.created_at
      ].join(',');
    })
  ].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `urunler_detayli_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
}


document.body.addEventListener('click', async (e)=>{
  const pkgId = e.target.getAttribute('data-pkg');
  const delId = e.target.getAttribute('data-del');
  const editId = e.target.getAttribute('data-edit');
  
  if(e.target.id==='syncWix'){ 
    const btn = e.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="btn-icon">â³</span><span class="btn-text">Senkronize Ediliyor...</span>';
    btn.disabled = true;
    
    try {
      const r = await API.syncWix(); 
      document.getElementById('syncOut').textContent = r.ok ? ('+'+r.imported+' Ã¼rÃ¼n') : (r.error || 'Hata'); 
      await refresh();
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }
  
  if(e.target.id==='syncNetsis'){ 
    const btn = e.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="btn-icon">â³</span><span class="btn-text">Netsis Senkronize Ediliyor...</span>';
    btn.disabled = true;
    
    try {
      const r = await API.syncNetsis(); 
      document.getElementById('syncOut').textContent = r.ok ? ('+'+r.imported+' stok kartÄ±') : (r.error || 'Hata'); 
      await refresh();
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }
  if(pkgId){
    currentProductId = pkgId;
    const prod = products.find(x=>x.id==pkgId);
    $('#pkgProdName').textContent = `${prod.name} (${prod.sku})`;
    const list = await API.listPackages(pkgId);
    const tb = $('#pkgList');
    
    // Clear form first
    clearPackageForm();
    
    // Set product name as default package name ONLY for active language
    const currentLang = getCurrentLanguage();
    if (currentLang === 'english') {
      $('#pkgNumberEn').value = prod.name;
      $('#pkgContentEn').value = '';
      $('#pkgColorEn').value = '';
      // Do NOT fill Turkish fields
    } else {
      $('#pkgNumber').value = prod.name;
      $('#pkgContent').value = '';
      $('#pkgColor').value = '';
      // Do NOT fill English fields
    }
    
    tb.innerHTML = list.length ? list.map(pp=>`
      <tr>
        <td><strong>${pp.package_number || '-'}</strong></td>
        <td>${pp.package_content || pp.package_name || '-'}</td>
        <td><code style="background: var(--hover); padding: 2px 6px; border-radius: 4px; font-size: 0.9em;">${pp.barcode}</code></td>
        <td style="text-align: center;"><span style="background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em;">${pp.quantity}</span></td>
        <td style="text-align: center;">${pp.weight_kg ? pp.weight_kg + ' kg' : '-'}</td>
        <td style="text-align: center;">${pp.volume_m3 ? pp.volume_m3 + ' mÂ³' : '-'}</td>
        <td style="text-align: center;">
          <button data-pkedit="${pp.id}" style="background: var(--warning); color: white; border: none; border-radius: 4px; margin-right: 5px;">âœï¸ DÃ¼zenle</button>
          <button data-pkdel="${pp.id}" style="background: var(--danger); color: white; border: none; border-radius: 4px;">ğŸ—‘ï¸ Sil</button>
        </td>
      </tr>
    `).join('') : '<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--muted);"><em>HenÃ¼z paket tanÄ±mlanmamÄ±ÅŸ</em></td></tr>';
    $('#pkgModal').classList.add('show');
    
    $('#addPkgBtn').onclick = async ()=>{
      // No required fields check for package number anymore
      
      // Check if barcode is set for active form
      const activeForm = getCurrentLanguage();
      const barcode = activeForm === 'english' ? 
        $('#pkgBarcodeEn').value?.trim() : 
        $('#pkgBarcode').value?.trim();
      
      if (!barcode || barcode === 'Barkod seÃ§imi yapÄ±lacak...' || barcode === 'Barcode selection will be made...') {
        // Open barcode selection modal
        openBarcodeSelectionModal();
        return;
      }
      
      // If barcode is set, proceed directly
      await proceedWithPackageAdd();
    };
  }
  if(delId){ await API.deleteProduct(delId); await refresh(); }
  const locId = e.target.getAttribute('data-loc');
  if(locId){
    const prodObj = products.find(x=>x.id==locId);
    document.getElementById('locProdName').textContent = `${prodObj.name} (${prodObj.sku})`;
    const list = await fetch('/api/products/'+locId+'/locations').then(r=>r.json());
    document.getElementById('locList').innerHTML = list.map(l=>`<tr><td>${l.code}</td><td>${l.on_hand}</td></tr>`).join('');
    document.getElementById('locModal').classList.add('show');
    document.getElementById('assignLocBtn').onclick = async ()=>{
      const code = document.getElementById('locCode').value.trim();
      const qty = parseInt(document.getElementById('locQty').value||'0',10);
      if(!code) return alert('Kod lazÄ±m');
      await API.assignLocation(locId, { code, on_hand: qty });
      const list2 = await fetch('/api/products/'+locId+'/locations').then(r=>r.json());
      document.getElementById('locList').innerHTML = list2.map(l=>`<tr><td>${l.code}</td><td>${l.on_hand}</td></tr>`).join('');
      document.getElementById('locCode').value=''; document.getElementById('locQty').value=0;
      await refresh();
    };
  }
  if(editId){
    const p = products.find(x=>x.id==editId);
    openEditModal(p);
  }
  const pkedit = e.target.getAttribute('data-pkedit');
  if(pkedit){
    // Find the package data and load for editing
    const list = await API.listPackages(currentProductId);
    const pkg = list.find(p => p.id == pkedit);
    if(pkg) {
      loadPackageForEdit(pkg);
    }
  }
  const pkdel = e.target.getAttribute('data-pkdel');
  if(pkdel){ await API.delPackage(pkdel); await refresh(); }
  
  // Barkod Ä°ÅŸlemleri buton event listener
  if(e.target.id === 'bulkBarcodeActions') {
    updateBarcodeActionCounts();
    openBarcodeActionsModal();
  }
});

// Barkod Ä°ÅŸlemleri FonksiyonlarÄ±
function openBarcodeActionsModal() {
  $('#barcodeActionsModal').style.display = 'block';
  
  // Ana Ã¼rÃ¼nden alt paket seÃ§imi iÃ§in gerekli alanlarÄ± hazÄ±rla
  setupPackageSelection();
  
  updateBarcodePreview();
  updateTemplatePreview();
}

// Alt paket seÃ§imi iÃ§in setup fonksiyonu
async function setupPackageSelection() {
  const selectedProducts = getSelectedProducts();
  
  if (selectedProducts.length === 1) {
    const mainProduct = selectedProducts[0];
    await loadProductPackages(mainProduct.id);
  } else {
    // Ã‡oklu seÃ§im veya seÃ§im yok ise paket seÃ§im alanÄ±nÄ± gizle
    hidePackageSelection();
  }
}

// Ana Ã¼rÃ¼nÃ¼n alt paketlerini yÃ¼kle
async function loadProductPackages(productId) {
  try {
    const response = await fetch(`/api/products/${productId}/packages`);
    const packages = await response.json();
    
    if (packages.length > 0) {
      showPackageSelection(packages);
    } else {
      hidePackageSelection();
    }
  } catch (error) {
    console.error('Alt paketler yÃ¼klenemedi:', error);
    hidePackageSelection();
  }
}

// Alt paket seÃ§im arayÃ¼zÃ¼nÃ¼ gÃ¶ster
function showPackageSelection(packages) {
  const printTab = document.getElementById('printTab');
  let packageSelectionArea = document.getElementById('packageSelectionArea');
  
  if (!packageSelectionArea) {
    // Alt paket seÃ§im alanÄ±nÄ± oluÅŸtur
    packageSelectionArea = document.createElement('div');
    packageSelectionArea.id = 'packageSelectionArea';
    packageSelectionArea.style.cssText = `
      background: var(--section);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    `;
    
    // Print seÃ§eneklerinden Ã¶nce ekle
    const printOptionsDiv = printTab.querySelector('.print-options');
    printTab.insertBefore(packageSelectionArea, printOptionsDiv);
  }
  
  packageSelectionArea.innerHTML = `
    <h4 style="color: var(--accent); margin-bottom: 1rem; display: flex; align-items: center;">
      ğŸ“¦ Alt Paket SeÃ§imi
      <span style="font-size: 0.8rem; color: var(--muted); margin-left: 1rem;">Bu ana Ã¼rÃ¼ne ait ${packages.length} paket bulundu</span>
    </h4>
    
    <div style="margin-bottom: 1rem;">
      <label style="display: flex; align-items: center; margin-bottom: 0.5rem;">
        <input type="checkbox" id="selectAllPackages" onchange="toggleAllPackages()" style="margin-right: 0.5rem;">
        <span style="color: var(--accent);">TÃ¼m Paketleri SeÃ§</span>
      </label>
    </div>
    
    <div class="packages-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; max-height: 200px; overflow-y: auto;">
      ${packages.map(pkg => `
        <label class="package-item" style="
          display: flex;
          align-items: center;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 6px;
          padding: 0.75rem;
          cursor: pointer;
          transition: all 0.2s ease;
        " onmouseover="this.style.background='var(--hover)'" onmouseout="this.style.background='var(--card)'">
          <input type="checkbox" class="package-checkbox" value="${pkg.id}" style="margin-right: 0.75rem;" data-package='${JSON.stringify(pkg)}'>
          <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--fg); margin-bottom: 0.25rem;">
              ${pkg.package_name || 'Ä°simsiz Paket'}
            </div>
            <div style="font-size: 0.9rem; color: var(--muted); margin-bottom: 0.25rem;">
              Barkod: <code style="background: var(--section); padding: 2px 4px; border-radius: 3px;">${pkg.barcode}</code>
            </div>
            <div style="font-size: 0.85rem; color: var(--muted);">
              Adet: ${pkg.quantity || 1} | SKU: ${pkg.sku || 'N/A'}
            </div>
          </div>
        </label>
      `).join('')}
    </div>
  `;
  
  packageSelectionArea.style.display = 'block';
}

// Alt paket seÃ§im arayÃ¼zÃ¼nÃ¼ gizle
function hidePackageSelection() {
  const packageSelectionArea = document.getElementById('packageSelectionArea');
  if (packageSelectionArea) {
    packageSelectionArea.style.display = 'none';
  }
}

// TÃ¼m paketleri seÃ§/seÃ§me
function toggleAllPackages() {
  const selectAll = document.getElementById('selectAllPackages').checked;
  const checkboxes = document.querySelectorAll('.package-checkbox');
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll;
  });
}

// SeÃ§ili alt paketleri al
function getSelectedPackages() {
  const checkboxes = document.querySelectorAll('.package-checkbox:checked');
  return Array.from(checkboxes).map(cb => {
    return JSON.parse(cb.dataset.package);
  });
}

// SeÃ§ili paketlerden Ã¶rnek verileri gÃ¼ncelle
function updateSampleDataFromSelectedPackages() {
  const selectedPackages = getSelectedPackages();
  
  if (selectedPackages.length > 0) {
    const firstPackage = selectedPackages[0];
    
    // Ã–rnek veri alanlarÄ±nÄ± seÃ§ili paket verisiyle doldur
    if($('#samplePackageSKU')) $('#samplePackageSKU').value = firstPackage.sku || firstPackage.barcode;
    if($('#samplePackageName')) $('#samplePackageName').value = firstPackage.package_name || 'Paket';
    if($('#samplePackageBarcode')) $('#samplePackageBarcode').value = firstPackage.barcode;
    if($('#samplePackageQuantity')) $('#samplePackageQuantity').value = (firstPackage.quantity || 1) + ' adet';
    if($('#samplePackageContent')) $('#samplePackageContent').value = firstPackage.package_content || firstPackage.package_name || 'Paket iÃ§eriÄŸi';
    
    // Boyut bilgileri varsa kullan
    let dimensions = '';
    if (firstPackage.length_cm && firstPackage.width_cm && firstPackage.height_cm) {
      dimensions = `${firstPackage.length_cm}x${firstPackage.width_cm}x${firstPackage.height_cm}cm`;
    } else {
      dimensions = 'Boyut bilgisi yok';
    }
    if($('#samplePackageDimensions')) $('#samplePackageDimensions').value = dimensions;
    
    // AÄŸÄ±rlÄ±k bilgisi varsa kullan
    const weight = firstPackage.weight_kg ? firstPackage.weight_kg + 'kg' : 'AÄŸÄ±rlÄ±k bilgisi yok';
    if($('#samplePackageWeight')) $('#samplePackageWeight').value = weight;
    
    // Ana Ã¼rÃ¼n bilgisini Ã§ek (bu bilgi ayrÄ±ca API'den alÄ±nabilir)
    loadMainProductInfo(firstPackage.product_id);
  }
}

// Ana Ã¼rÃ¼n bilgisini yÃ¼kle
async function loadMainProductInfo(productId) {
  try {
    const response = await fetch(`/api/products?id=${productId}`);
    const products = await response.json();
    
    if (products && products.length > 0) {
      const mainProduct = products[0];
      if($('#sampleMainProduct')) $('#sampleMainProduct').value = mainProduct.name || 'Ana ÃœrÃ¼n';
    }
  } catch (error) {
    console.log('Ana Ã¼rÃ¼n bilgisi yÃ¼klenemedi:', error);
  }
}

window.closeBarcodeActionsModal = function() {
  $('#barcodeActionsModal').style.display = 'none';
}

window.showBarcodeTab = function(tabName) {
  // Tab butonlarÄ±nÄ± gÃ¼ncelle
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`[onclick="showBarcodeTab('${tabName}')"]`).classList.add('active');
  
  // Tab iÃ§eriklerini gÃ¼ncelle
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
  
  // Template editÃ¶r tab'Ä±na geÃ§ildiÄŸinde Ã¶rnek verileri gÃ¼ncelle
  if (tabName === 'template') {
    updateSampleDataFromSelectedPackages();
    if(window.updateTemplatePreview) {
      updateTemplatePreview();
    }
  }
}

function updateBarcodeActionCounts() {
  const selectedProducts = getSelectedProducts();
  const filteredProducts = getFilteredProducts();
  
  $('#selectedCount').textContent = selectedProducts.length;
  $('#filteredCount').textContent = filteredProducts.length;
  $('#totalCount').textContent = products.length;
}

function getSelectedProducts() {
  const checkboxes = document.querySelectorAll('#prodTable tbody input[type="checkbox"]:checked');
  return Array.from(checkboxes).map(cb => {
    const productId = cb.value;
    return products.find(p => p.id == productId);
  }).filter(p => p);
}

function getFilteredProducts() {
  // Mevcut filtreleme mantÄ±ÄŸÄ±nÄ± kullan
  return currentFilteredProducts || products;
}

function updateBarcodePreview() {
  const template = $('#templateSelect').value;
  const includePrices = $('#includePrices').checked;
  const includeStock = $('#includeStock').checked;
  const includeLocation = $('#includeLocation').checked;
  const copyCount = parseInt($('#copyCount').value) || 1;
  
  // Alt paket seÃ§imi varsa paketleri kullan, yoksa ana Ã¼rÃ¼nleri kullan
  const selectedPackages = getSelectedPackages();
  
  if (selectedPackages.length > 0) {
    // Alt paket seÃ§imi varsa paket bazÄ±nda yazdÄ±rma
    updatePackageBasedPreview(selectedPackages, template, { includePrices, includeStock, includeLocation, copyCount });
  } else {
    // Normal ana Ã¼rÃ¼n yazdÄ±rma
    updateProductBasedPreview(template, { includePrices, includeStock, includeLocation, copyCount });
  }
}

// Alt paket bazÄ±nda Ã¶nizleme
function updatePackageBasedPreview(packages, template, options) {
  if(packages.length === 0) {
    $('#barcodePreview').innerHTML = '<div style="color: var(--muted);">YazdÄ±rÄ±lacak paket seÃ§in</div>';
    return;
  }
  
  const { copyCount } = options;
  const samplePackage = packages[0];
  
  // Alt paket iÃ§in Ã¶zel HTML oluÅŸtur
  const previewHtml = generatePackageBarcodeHTML(samplePackage, template, options);
  
  $('#barcodePreview').innerHTML = `
    <div style="text-align: center;">
      <div style="margin-bottom: 1rem; color: var(--accent); font-weight: 600;">
        ğŸ“¦ Alt Paket Etiketi Ã–nizlemesi
      </div>
      <div style="margin-bottom: 1rem; color: var(--muted);">
        Toplam ${packages.length} paket x ${copyCount} kopya = ${packages.length * copyCount} etiket
      </div>
      <div style="border: 1px solid var(--border); padding: 1rem; background: var(--card); display: inline-block; border-radius: 6px;">
        ${previewHtml}
      </div>
      <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--muted);">
        Ã–rnek: ${samplePackage.package_name || 'Ä°simsiz Paket'} (${samplePackage.barcode})
      </div>
    </div>
  `;
}

// Ana Ã¼rÃ¼n bazÄ±nda Ã¶nizleme (eski sistem)
function updateProductBasedPreview(template, options) {
  const printOption = document.querySelector('input[name="printOption"]:checked').value;
  let selectedProducts = [];
  
  switch(printOption) {
    case 'selected':
      selectedProducts = getSelectedProducts();
      break;
    case 'filtered':
      selectedProducts = getFilteredProducts();
      break;
    case 'all':
      selectedProducts = products;
      break;
  }
  
  if(selectedProducts.length === 0) {
    $('#barcodePreview').innerHTML = '<div style="color: var(--muted);">YazdÄ±rÄ±lacak Ã¼rÃ¼n bulunamadÄ±</div>';
    return;
  }
  
  const { includePrices, includeStock, includeLocation, copyCount } = options;
  
  // Ä°lk Ã¼rÃ¼nle Ã¶nizleme oluÅŸtur
  const sampleProduct = selectedProducts[0];
  const previewHtml = generateBarcodeHTML(sampleProduct, template, {
    includePrices,
    includeStock,
    includeLocation,
    copyCount
  });
  
  $('#barcodePreview').innerHTML = `
    <div style="text-align: center;">
      <div style="margin-bottom: 1rem; color: var(--muted);">
        Toplam ${selectedProducts.length} Ã¼rÃ¼n x ${copyCount} kopya = ${selectedProducts.length * copyCount} etiket
      </div>
      <div style="border: 1px solid var(--border); padding: 1rem; background: var(--card); display: inline-block; border-radius: 6px;">
        ${previewHtml}
      </div>
      <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--muted);">
        Ã–rnek: ${sampleProduct.name} (${sampleProduct.sku})
      </div>
    </div>
  `;
}

function generateBarcodeHTML(product, template, options) {
  const { includePrices, includeStock, includeLocation, copyCount = 1 } = options;
  
  let html = '';
  for(let i = 0; i < copyCount; i++) {
    switch(template) {
      case 'compact':
        html += `
          <div style="border: 1px solid #000; padding: 0.25rem; margin: 0.25rem; width: 40mm; font-size: 8pt; text-align: center;">
            <div style="font-weight: bold;">${product.sku}</div>
            <div style="font-family: 'Courier New', monospace; font-size: 6pt;">|||||||||||||||</div>
            <div style="font-size: 6pt;">${product.name.substring(0, 20)}${product.name.length > 20 ? '...' : ''}</div>
            ${includePrices ? `<div style="font-size: 6pt;">â‚º${product.price || '0.00'}</div>` : ''}
          </div>
        `;
        break;
        
      case 'detailed':
        html += `
          <div style="border: 1px solid #000; padding: 0.5rem; margin: 0.25rem; width: 60mm; font-size: 10pt;">
            <div style="text-align: center; font-weight: bold; margin-bottom: 0.25rem;">${product.name}</div>
            <div style="text-align: center; font-family: 'Courier New', monospace; font-size: 8pt; margin: 0.25rem 0;">|||||||||||||||</div>
            <div style="display: flex; justify-content: space-between; font-size: 8pt;">
              <span>SKU: ${product.sku}</span>
              ${includePrices ? `<span>â‚º${product.price || '0.00'}</span>` : ''}
            </div>
            ${includeStock ? `<div style="font-size: 8pt;">Stok: ${product.stock || 0} adet</div>` : ''}
            ${includeLocation ? `<div style="font-size: 8pt;">Konum: ${product.location || 'TanÄ±mlÄ± deÄŸil'}</div>` : ''}
            <div style="font-size: 6pt; text-align: right; margin-top: 0.25rem;">${new Date().toLocaleDateString('tr-TR')}</div>
          </div>
        `;
        break;
        
      default: // 'default'
        html += `
          <div style="border: 1px solid #000; padding: 0.5rem; margin: 0.25rem; width: 50mm; font-size: 10pt; text-align: center;">
            <div style="font-weight: bold; margin-bottom: 0.25rem;">${product.sku}</div>
            <div style="font-family: 'Courier New', monospace; font-size: 8pt; margin: 0.5rem 0;">|||||||||||||||</div>
            <div style="font-size: 9pt;">${product.name.substring(0, 25)}${product.name.length > 25 ? '...' : ''}</div>
            ${includePrices ? `<div style="font-size: 8pt; margin-top: 0.25rem;">â‚º${product.price || '0.00'}</div>` : ''}
            ${includeLocation ? `<div style="font-size: 7pt; margin-top: 0.25rem;">${product.location || ''}</div>` : ''}
          </div>
        `;
        break;
    }
  }
  
  return html;
}

// Ana yazdÄ±rma fonksiyonu
window.printBarcodes = function() {
  const template = $('#templateSelect').value;
  const copyCount = parseInt($('#copyCount').value) || 1;
  const includePrices = $('#includePrices').checked;
  const includeStock = $('#includeStock').checked;
  const includeLocation = $('#includeLocation').checked;
  
  // Ã–nce alt paket seÃ§imi varsa paketleri kontrol et
  const selectedPackages = getSelectedPackages();
  
  console.log('ğŸ–¨ï¸ YazdÄ±rma baÅŸlatÄ±lÄ±yor...');
  console.log('SeÃ§ili paket sayÄ±sÄ±:', selectedPackages.length);
  
  if (selectedPackages.length > 0) {
    // Alt paket bazlÄ± yazdÄ±rma
    console.log('ğŸ“¦ Alt paket yazdÄ±rma modu');
    printPackageBarcodes(selectedPackages, template, { includePrices, includeStock, includeLocation, copyCount });
  } else {
    // Ana Ã¼rÃ¼n yazdÄ±rma (eski sistem)
    console.log('ğŸ“ Ana Ã¼rÃ¼n yazdÄ±rma modu');
    const printOption = document.querySelector('input[name="printOption"]:checked').value;
    let productsToPrint = [];
    
    switch(printOption) {
      case 'selected':
        productsToPrint = getSelectedProducts();
        break;
      case 'filtered':
        productsToPrint = getFilteredProducts();
        break;
      case 'all':
        productsToPrint = products;
        break;
    }
    
    if(productsToPrint.length === 0) {
      alert('YazdÄ±rÄ±lacak Ã¼rÃ¼n bulunamadÄ±!');
      return;
    }
    
    // Ana Ã¼rÃ¼n yazdÄ±rma iÅŸlemi
    let printHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Ana ÃœrÃ¼n Barkod Etiketleri</title>
        <style>
          body { margin: 0; padding: 1rem; font-family: Arial, sans-serif; }
          .barcode-sheet { display: flex; flex-wrap: wrap; gap: 0.25rem; }
          @media print {
            body { margin: 0; padding: 0; }
            .no-print { display: none; }
          }
        </style>
      </head>
      <body>
        <div class="no-print" style="margin-bottom: 1rem; text-align: center;">
          <h2>Ana ÃœrÃ¼n Barkod YazdÄ±rma Ã–nizleme</h2>
          <p>Toplam ${productsToPrint.length} Ã¼rÃ¼n x ${copyCount} kopya = ${productsToPrint.length * copyCount} etiket</p>
          <button onclick="window.print()" style="padding: 0.5rem 1rem; font-size: 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ–¨ï¸ YazdÄ±r</button>
          <button onclick="window.close()" style="padding: 0.5rem 1rem; font-size: 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Kapat</button>
        </div>
        <div class="barcode-sheet">
          ${productsToPrint.map(product => 
            generateBarcodeHTML(product, template, { includePrices, includeStock, includeLocation, copyCount })
          ).join('')}
        </div>
      </body>
      </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printHTML);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  }
}

// Alt paket iÃ§in Ã¶zel barkod HTML oluÅŸturma
function generatePackageBarcodeHTML(packageItem, template, options) {
  const { includePrices, includeStock, includeLocation, copyCount = 1 } = options;
  
  let html = '';
  for(let i = 0; i < copyCount; i++) {
    switch(template) {
      case 'compact':
        html += `
          <div style="border: 1px solid #000; padding: 0.25rem; margin: 0.25rem; width: 40mm; font-size: 8pt; text-align: center;">
            <div style="font-weight: bold;">${packageItem.barcode}</div>
            <div style="font-family: 'Courier New', monospace; font-size: 6pt;">|||||||||||||||</div>
            <div style="font-size: 6pt;">${(packageItem.package_name || 'Ä°simsiz Paket').substring(0, 20)}</div>
            <div style="font-size: 6pt;">Adet: ${packageItem.quantity || 1}</div>
          </div>
        `;
        break;
        
      case 'detailed':
        html += `
          <div style="border: 1px solid #000; padding: 0.5rem; margin: 0.25rem; width: 60mm; font-size: 10pt;">
            <div style="text-align: center; font-weight: bold; margin-bottom: 0.25rem;">${packageItem.package_name || 'Ä°simsiz Paket'}</div>
            <div style="text-align: center; font-family: 'Courier New', monospace; font-size: 8pt; margin: 0.25rem 0;">${packageItem.barcode}</div>
            <div style="display: flex; justify-content: space-between; font-size: 8pt;">
              <span>Adet: ${packageItem.quantity || 1}</span>
              ${packageItem.sku ? `<span>SKU: ${packageItem.sku}</span>` : ''}
            </div>
            ${packageItem.package_content ? `<div style="font-size: 8pt;">Ä°Ã§erik: ${packageItem.package_content}</div>` : ''}
            ${packageItem.weight_kg ? `<div style="font-size: 8pt;">AÄŸÄ±rlÄ±k: ${packageItem.weight_kg}kg</div>` : ''}
            <div style="font-size: 6pt; text-align: right; margin-top: 0.25rem;">${new Date().toLocaleDateString('tr-TR')}</div>
          </div>
        `;
        break;
        
      default: // 'default'
        html += `
          <div style="border: 1px solid #000; padding: 0.5rem; margin: 0.25rem; width: 50mm; font-size: 10pt; text-align: center;">
            <div style="font-weight: bold; margin-bottom: 0.25rem;">${packageItem.barcode}</div>
            <div style="font-family: 'Courier New', monospace; font-size: 8pt; margin: 0.5rem 0;">|||||||||||||||</div>
            <div style="font-size: 9pt;">${(packageItem.package_name || 'Ä°simsiz Paket').substring(0, 25)}</div>
            <div style="font-size: 8pt; margin-top: 0.25rem;">Adet: ${packageItem.quantity || 1}</div>
            ${packageItem.sku ? `<div style="font-size: 7pt; margin-top: 0.25rem;">${packageItem.sku}</div>` : ''}
          </div>
        `;
        break;
    }
  }
  
  return html;
}

// Alt paket barkodlarÄ±nÄ± yazdÄ±r
function printPackageBarcodes(packages, template, options) {
  if (packages.length === 0) {
    alert('YazdÄ±rÄ±lacak paket seÃ§in!');
    return;
  }
  
  console.log('ğŸ“¦ Alt paket yazdÄ±rma baÅŸlatÄ±lÄ±yor:', packages.length, 'paket');
  
  const { copyCount } = options;
  
  let printHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Alt Paket Barkod Etiketleri</title>
      <style>
        body { margin: 0; padding: 1rem; font-family: Arial, sans-serif; }
        .barcode-sheet { display: flex; flex-wrap: wrap; gap: 0.25rem; }
        @media print {
          body { margin: 0; padding: 0; }
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="no-print" style="margin-bottom: 1rem; text-align: center;">
        <h2>ğŸ“¦ Alt Paket Barkod YazdÄ±rma</h2>
        <p><strong>SeÃ§ili Paketler:</strong> ${packages.length} paket x ${copyCount} kopya = ${packages.length * copyCount} etiket</p>
        <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
          <h4 style="margin-top: 0; color: #0d6efd;">YazdÄ±rÄ±lacak Paketler:</h4>
          <ul style="margin: 0; padding-left: 1.5rem;">
            ${packages.map((pkg, index) => `
              <li><strong>${index + 1}.</strong> ${pkg.package_name || 'Ä°simsiz Paket'} - <code>${pkg.barcode}</code></li>
            `).join('')}
          </ul>
        </div>
        <button onclick="window.print()" style="padding: 0.75rem 1.5rem; font-size: 1rem; background: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 0.5rem;">ğŸ–¨ï¸ YazdÄ±r</button>
        <button onclick="window.close()" style="padding: 0.75rem 1.5rem; font-size: 1rem; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">Kapat</button>
      </div>
      <div class="barcode-sheet">
  `;
  
  // Her paketi sÄ±rayla ekle
  packages.forEach((pkg, index) => {
    console.log(`ğŸ·ï¸ Paket ${index + 1} iÅŸleniyor:`, pkg.package_name, pkg.barcode);
    for (let copyIndex = 0; copyIndex < copyCount; copyIndex++) {
      printHTML += generatePackageBarcodeHTML(pkg, template, {...options, copyCount: 1}); // Her kopya tek tek
    }
  });
  
  printHTML += `
      </div>
    </body>
    </html>
  `;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printHTML);
  printWindow.document.close();
  printWindow.focus();
  setTimeout(() => printWindow.print(), 500); // KÄ±sa gecikme ekle
}

window.printBarcodes = function() {
  const template = $('#templateSelect').value;
  const copyCount = parseInt($('#copyCount').value) || 1;
  const includePrices = $('#includePrices').checked;
  const includeStock = $('#includeStock').checked;
  const includeLocation = $('#includeLocation').checked;
  
  // Ã–nce alt paket seÃ§imi varsa paketleri kontrol et
  const selectedPackages = getSelectedPackages();
  
  console.log('ğŸ–¨ï¸ YazdÄ±rma baÅŸlatÄ±lÄ±yor...');
  console.log('SeÃ§ili paket sayÄ±sÄ±:', selectedPackages.length);
  
  if (selectedPackages.length > 0) {
    // Alt paket bazlÄ± yazdÄ±rma
    console.log('ğŸ“¦ Alt paket yazdÄ±rma modu');
    printPackageBarcodes(selectedPackages, template, { includePrices, includeStock, includeLocation, copyCount });
  } else {
    // Ana Ã¼rÃ¼n yazdÄ±rma (eski sistem)
    console.log('ğŸ“ Ana Ã¼rÃ¼n yazdÄ±rma modu');
    const printOption = document.querySelector('input[name="printOption"]:checked').value;
    let productsToPrint = [];
    
    switch(printOption) {
      case 'selected':
        productsToPrint = getSelectedProducts();
        break;
      case 'filtered':
        productsToPrint = getFilteredProducts();
        break;
      case 'all':
        productsToPrint = products;
        break;
    }
  
  if(productsToPrint.length === 0) {
    alert('YazdÄ±rÄ±lacak Ã¼rÃ¼n bulunamadÄ±!');
    return;
  }
  
  // YazdÄ±rma penceresi oluÅŸtur
  const printWindow = window.open('', '_blank');
  const printHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Barkod YazdÄ±rma</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; }
        .barcode-sheet { display: flex; flex-wrap: wrap; gap: 0.25rem; }
        @media print {
          body { margin: 0; padding: 0; }
          .no-print { display: none; }
        }
      </style>
    </head>
    <body>
      <div class="no-print" style="margin-bottom: 1rem; text-align: center;">
        <h2>Barkod YazdÄ±rma Ã–nizleme</h2>
        <p>Toplam ${productsToPrint.length} Ã¼rÃ¼n x ${copyCount} kopya = ${productsToPrint.length * copyCount} etiket</p>
        <button onclick="window.print()" style="padding: 0.5rem 1rem; font-size: 1rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ–¨ï¸ YazdÄ±r</button>
        <button onclick="window.close()" style="padding: 0.5rem 1rem; font-size: 1rem; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Kapat</button>
      </div>
      <div class="barcode-sheet">
        ${productsToPrint.map(product => 
          generateBarcodeHTML(product, template, { includePrices, includeStock, includeLocation, copyCount })
        ).join('')}
      </div>
    </body>
    </html>
  `;
  
  printWindow.document.write(printHTML);
  printWindow.document.close();
}

window.exportBarcodesPDF = function() {
  alert('PDF export Ã¶zelliÄŸi geliÅŸtirilme aÅŸamasÄ±nda...\nÅimdilik yazdÄ±rma Ã¶zelliÄŸini kullanarak PDF\'e kaydetme yapabilirsiniz.');
}

// Global window fonksiyonlarÄ±nÄ± ekle
window.toggleAllPackages = toggleAllPackages;
window.getSelectedPackages = getSelectedPackages;
window.updateSampleDataFromSelectedPackages = updateSampleDataFromSelectedPackages;

// Template EditÃ¶r FonksiyonlarÄ±
window.updateTemplatePreview = function() {
  // Alt paket seÃ§imi varsa Ã¶rnek verileri gÃ¼ncelle
  updateSampleDataFromSelectedPackages();
  
  const width = $('#templateWidth').value;
  const height = $('#templateHeight').value;
  const fontSize = $('#fontSize').value;
  const barcodeHeight = $('#barcodeHeight').value;
  
  const showSKU = $('#showSKU')?.checked || false;
  const showName = $('#showName')?.checked || false;
  const showBarcode = $('#showBarcode')?.checked || false;
  const showPrice = $('#showPrice')?.checked || false;
  const showStock = $('#showStock')?.checked || false;
  const showLocation = $('#showLocation')?.checked || false;
  const showDate = $('#showDate')?.checked || false;
  
  const layout = document.querySelector('input[name="layout"]:checked')?.value || 'vertical';
  
  // Ã–rnek veriler
  const sampleSKU = $('#sampleSKU')?.value || 'SAMPLE-001';
  const sampleName = $('#sampleName')?.value || 'Ã–rnek ÃœrÃ¼n';
  const sampleBarcode = $('#sampleBarcode')?.value || '1234567890123';
  const samplePrice = $('#samplePrice')?.value || 'â‚º99.99';
  const sampleStock = $('#sampleStock')?.value || '25 adet';
  const sampleLocation = $('#sampleLocation')?.value || 'A1-01-359';
  
  let previewHTML = '';
  
  if(layout === 'horizontal') {
    previewHTML = `
      <div style="
        width: ${width}mm; 
        height: ${height}mm; 
        border: 1px solid #000; 
        padding: 0.25rem; 
        font-size: ${fontSize}pt;
        display: flex;
        align-items: center;
        gap: 0.25rem;
      ">
        <div style="flex: 1;">
          ${showSKU ? `<div style="font-weight: bold;">${sampleSKU}</div>` : ''}
          ${showName ? `<div style="font-size: ${fontSize-1}pt;">${sampleName}</div>` : ''}
          ${showPrice ? `<div>${samplePrice}</div>` : ''}
          ${showStock ? `<div style="font-size: ${fontSize-1}pt;">${sampleStock}</div>` : ''}
          ${showLocation ? `<div style="font-size: ${fontSize-1}pt;">${sampleLocation}</div>` : ''}
          ${showDate ? `<div style="font-size: ${fontSize-2}pt;">${new Date().toLocaleDateString('tr-TR')}</div>` : ''}
        </div>
        ${showBarcode ? `<div style="text-align: center;">
          <div style="font-family: 'Courier New', monospace; height: ${barcodeHeight}mm; line-height: ${barcodeHeight}mm; font-size: 6pt;">|||||||||||||||</div>
          <div style="font-size: 6pt;">${sampleBarcode}</div>
        </div>` : ''}
      </div>
    `;
  } else if(layout === 'compact') {
    previewHTML = `
      <div style="
        width: ${width}mm; 
        height: ${height}mm; 
        border: 1px solid #000; 
        padding: 0.125rem; 
        font-size: ${fontSize-2}pt;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
      ">
        ${showSKU ? `<div style="font-weight: bold;">${sampleSKU}</div>` : ''}
        ${showBarcode ? `<div style="font-family: 'Courier New', monospace; height: ${Math.min(barcodeHeight, height/3)}mm; line-height: ${Math.min(barcodeHeight, height/3)}mm;">|||||||||||||||</div>` : ''}
        ${showName ? `<div>${sampleName.substring(0, 15)}${sampleName.length > 15 ? '...' : ''}</div>` : ''}
        ${showPrice ? `<div>${samplePrice}</div>` : ''}
      </div>
    `;
  } else { // vertical
    previewHTML = `
      <div style="
        width: ${width}mm; 
        height: ${height}mm; 
        border: 1px solid #000; 
        padding: 0.25rem; 
        font-size: ${fontSize}pt;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 0.125rem;
      ">
        ${showSKU ? `<div style="font-weight: bold;">${sampleSKU}</div>` : ''}
        ${showName ? `<div style="font-size: ${fontSize-1}pt;">${sampleName.length > 20 ? sampleName.substring(0, 20) + '...' : sampleName}</div>` : ''}
        ${showBarcode ? `<div>
          <div style="font-family: 'Courier New', monospace; height: ${barcodeHeight}mm; line-height: ${barcodeHeight}mm; font-size: 6pt;">|||||||||||||||</div>
          <div style="font-size: 6pt;">${sampleBarcode}</div>
        </div>` : ''}
        ${showPrice ? `<div>${samplePrice}</div>` : ''}
        ${showStock ? `<div style="font-size: ${fontSize-1}pt;">${sampleStock}</div>` : ''}
        ${showLocation ? `<div style="font-size: ${fontSize-1}pt;">${sampleLocation}</div>` : ''}
        ${showDate ? `<div style="font-size: ${fontSize-2}pt;">${new Date().toLocaleDateString('tr-TR')}</div>` : ''}
      </div>
    `;
  }
  
  const previewContainer = $('#templatePreview');
  if(previewContainer) {
    previewContainer.innerHTML = previewHTML;
  }
}

window.saveTemplate = function() {
  const templateData = {
    width: $('#templateWidth')?.value || '50',
    height: $('#templateHeight')?.value || '30',
    droppedElements: droppedElements || [],
    sampleData: {
      packageSKU: $('#samplePackageSKU')?.value || 'PK-SAMPLE-001',
      packageName: $('#samplePackageName')?.value || 'Ã–rnek Paket',
      packageBarcode: $('#samplePackageBarcode')?.value || '1234567890123',
      mainProduct: $('#sampleMainProduct')?.value || 'Ã–rnek Ana ÃœrÃ¼n',
      packageQuantity: $('#samplePackageQuantity')?.value || '5 adet',
      packageContent: $('#samplePackageContent')?.value || 'Standart paket',
      packageDimensions: $('#samplePackageDimensions')?.value || '50x30x20cm',
      packageWeight: $('#samplePackageWeight')?.value || '2.5kg',
      shelfLocation: $('#sampleShelfLocation')?.value || 'A1-01-359'
    }
  };
  
  const templateName = prompt('Template adÄ±:', 'Ã–zel Template ' + new Date().toLocaleDateString('tr-TR'));
  if(templateName) {
    localStorage.setItem('barcodeTemplate_' + templateName, JSON.stringify(templateData));
    alert('Template kaydedildi: ' + templateName);
    
    // Template select'e ekle
    const option = document.createElement('option');
    option.value = 'custom_' + templateName;
    option.textContent = templateName;
    $('#templateSelect').appendChild(option);
  }
}

window.loadTemplate = function() {
  const keys = Object.keys(localStorage).filter(key => key.startsWith('barcodeTemplate_'));
  if(keys.length === 0) {
    alert('KayÄ±tlÄ± template bulunamadÄ±!');
    return;
  }
  
  const templateNames = keys.map(key => key.replace('barcodeTemplate_', ''));
  const selectedTemplate = prompt('YÃ¼klenecek template:\n' + templateNames.map((name, i) => `${i+1}. ${name}`).join('\n') + '\n\nTemplate numarasÄ±nÄ± girin:');
  
  const templateIndex = parseInt(selectedTemplate) - 1;
  if(templateIndex >= 0 && templateIndex < templateNames.length) {
    const templateName = templateNames[templateIndex];
    const templateData = JSON.parse(localStorage.getItem('barcodeTemplate_' + templateName));
    
    // Template boyutlarÄ±nÄ± doldur
    if($('#templateWidth')) $('#templateWidth').value = templateData.width || '50';
    if($('#templateHeight')) $('#templateHeight').value = templateData.height || '30';
    
    // Dropped elementleri yÃ¼kle
    if(templateData.droppedElements) {
      // Ã–nce mevcut elementleri temizle
      droppedElements = [];
      document.querySelectorAll('.dropped-element').forEach(el => el.remove());
      
      // Yeni elementleri yÃ¼kle
      templateData.droppedElements.forEach(element => {
        droppedElements.push(element);
        createDroppedElement(element);
      });
    }
    
    // Sample verileri yÃ¼kle
    if(templateData.sampleData) {
      const data = templateData.sampleData;
      if($('#samplePackageSKU')) $('#samplePackageSKU').value = data.packageSKU || '';
      if($('#samplePackageName')) $('#samplePackageName').value = data.packageName || '';
      if($('#samplePackageBarcode')) $('#samplePackageBarcode').value = data.packageBarcode || '';
      if($('#sampleMainProduct')) $('#sampleMainProduct').value = data.mainProduct || '';
      if($('#samplePackageQuantity')) $('#samplePackageQuantity').value = data.packageQuantity || '';
      if($('#samplePackageContent')) $('#samplePackageContent').value = data.packageContent || '';
      if($('#samplePackageDimensions')) $('#samplePackageDimensions').value = data.packageDimensions || '';
      if($('#samplePackageWeight')) $('#samplePackageWeight').value = data.packageWeight || '';
      if($('#sampleShelfLocation')) $('#sampleShelfLocation').value = data.shelfLocation || '';
    }
    
    // Ã–nizlemeyi gÃ¼ncelle
    if(window.updateTemplatePreview) {
      updateTemplatePreview();
    }
    
    alert('Template yÃ¼klendi: ' + templateName);
  }
}

window.resetTemplate = function() {
  // Template boyutlarÄ±nÄ± sÄ±fÄ±rla
  if($('#templateWidth')) $('#templateWidth').value = '50';
  if($('#templateHeight')) $('#templateHeight').value = '30';
  
  // Dropped elementleri temizle
  droppedElements = [];
  document.querySelectorAll('.dropped-element').forEach(el => el.remove());
  
  // Sample verileri sÄ±fÄ±rla
  if($('#samplePackageSKU')) $('#samplePackageSKU').value = 'PK-SAMPLE-001';
  if($('#samplePackageName')) $('#samplePackageName').value = 'Ã–rnek Paket';
  if($('#samplePackageBarcode')) $('#samplePackageBarcode').value = '1234567890123';
  if($('#sampleMainProduct')) $('#sampleMainProduct').value = 'Ã–rnek Ana ÃœrÃ¼n';
  if($('#samplePackageQuantity')) $('#samplePackageQuantity').value = '5 adet';
  if($('#samplePackageContent')) $('#samplePackageContent').value = 'Standart paket';
  if($('#samplePackageDimensions')) $('#samplePackageDimensions').value = '50x30x20cm';
  if($('#samplePackageWeight')) $('#samplePackageWeight').value = '2.5kg';
  if($('#sampleShelfLocation')) $('#sampleShelfLocation').value = 'A1-01-359';
  
  // YÃ¼klenen resimleri temizle
  const imageContainer = document.getElementById('uploadedImages');
  if(imageContainer) imageContainer.innerHTML = '';
  const imageElement = document.querySelector('.image-element');
  if(imageElement) {
    imageElement.style.display = 'none';
    imageElement.removeAttribute('data-image-data');
    imageElement.textContent = 'ğŸ–¼ï¸ Ã–zel Resim';
  }
  
  // Ã–nizlemeyi gÃ¼ncelle
  if(window.updateTemplatePreview) {
    updateTemplatePreview();
  }
  
  alert('Template sÄ±fÄ±rlandÄ±!');
}

// Modal dÄ±ÅŸÄ±na tÄ±klandÄ±ÄŸÄ±nda kapat
window.onclick = function(event) {
  const modal = $('#barcodeActionsModal');
  if (event.target === modal) {
    closeBarcodeActionsModal();
  }
}

// Form change event listeners
document.addEventListener('change', function(e) {
  if(e.target.matches('#templateSelect, #copyCount, #includePrices, #includeStock, #includeLocation, input[name="printOption"]')) {
    updateBarcodePreview();
  }
});

// Eksik fonksiyonlar
function updateBarcodePreview() {
  console.log('updateBarcodePreview Ã§aÄŸÄ±rÄ±ldÄ±');
}

window.printBarcodes = function() {
  console.log('printBarcodes Ã§aÄŸÄ±rÄ±ldÄ±');
  alert('Barkod yazdÄ±rma fonksiyonu henÃ¼z tamamlanmadÄ±');
};

let currentFilteredProducts = null; // Global deÄŸiÅŸken
console.log('Birinci script tamamlandÄ±!');
</script>

<!-- Barkod Ä°ÅŸlemleri Modal -->
<div id="barcodeActionsModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2>Barkod Ä°ÅŸlemleri</h2>
      <span class="close" onclick="closeBarcodeActionsModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="tabs">
        <button class="tab-btn active" onclick="showBarcodeTab('print')">Barkod YazdÄ±r</button>
        <button class="tab-btn" onclick="showBarcodeTab('template')">Template EditÃ¶r</button>
      </div>

      <!-- Barkod YazdÄ±rma Tab -->
      <div id="printTab" class="tab-content active">
        <div class="card">
          <h3>YazdÄ±rma SeÃ§enekleri</h3>
          <div class="form-row">
            <label>
              <input type="radio" name="printOption" value="selected" checked>
              SeÃ§ili Ã¼rÃ¼nleri yazdÄ±r (<span id="selectedCount">0</span> Ã¼rÃ¼n)
            </label>
            <label>
              <input type="radio" name="printOption" value="filtered">
              FiltrelenmiÅŸ Ã¼rÃ¼nleri yazdÄ±r (<span id="filteredCount">0</span> Ã¼rÃ¼n)
            </label>
            <label>
              <input type="radio" name="printOption" value="all">
              TÃ¼m Ã¼rÃ¼nleri yazdÄ±r (<span id="totalCount">0</span> Ã¼rÃ¼n)
            </label>
          </div>
          
          <div class="form-row">
            <div>
              <label>Template:</label>
              <select id="templateSelect">
                <option value="default">VarsayÄ±lan Template</option>
                <option value="compact">Kompakt Template</option>
                <option value="detailed">DetaylÄ± Template</option>
                <option value="custom">Ã–zel Template</option>
              </select>
            </div>
            <div>
              <label>Kopya SayÄ±sÄ±:</label>
              <input type="number" id="copyCount" min="1" max="10" value="1">
            </div>
          </div>

          <div class="form-row">
            <label>
              <input type="checkbox" id="includePrices">
              Fiyat bilgilerini dahil et
            </label>
            <label>
              <input type="checkbox" id="includeStock">
              Stok miktarÄ±nÄ± dahil et  
            </label>
            <label>
              <input type="checkbox" id="includeLocation">
              Konum bilgisini dahil et
            </label>
          </div>

          <div class="preview-section">
            <h4>Ã–nizleme</h4>
            <div id="barcodePreview" class="barcode-preview">
              <!-- Ã–nizleme iÃ§eriÄŸi buraya gelecek -->
            </div>
          </div>

          <div class="form-actions">
            <button class="btn btn-success" onclick="printBarcodes()">
              ğŸ–¨ï¸ YazdÄ±r
            </button>
            <button class="btn" onclick="exportBarcodesPDF()">
              ğŸ“„ PDF Ä°ndir
            </button>
            <button class="btn" onclick="closeBarcodeActionsModal()">
              Ä°ptal
            </button>
          </div>
        </div>
      </div>

      <!-- Template EditÃ¶r Tab -->
      <div id="templateTab" class="tab-content">
        <div class="template-editor">
          <div class="editor-left">
            <h3>Template TasarÄ±mÄ± (SÃ¼rÃ¼kle & BÄ±rak)</h3>
            
            <!-- Template BoyutlarÄ± -->
            <div class="form-row">
              <div>
                <label>GeniÅŸlik (mm):</label>
                <input type="number" id="templateWidth" value="50" min="20" max="500" onchange="updateTemplatePreview()">
              </div>
              <div>
                <label>YÃ¼kseklik (mm):</label>
                <input type="number" id="templateHeight" value="30" min="15" max="600" onchange="updateTemplatePreview()">
              </div>
            </div>

            <!-- SÃ¼rÃ¼klenebilir Elementler -->
            <div class="form-group">
              <label>Paket Bilgi Elementleri:</label>
              <div class="template-elements">
                <div class="draggable-element" draggable="true" data-type="package_sku">ğŸ“‹ Paket SKU</div>
                <div class="draggable-element" draggable="true" data-type="package_name">ğŸ·ï¸ Paket AdÄ±</div>
                <div class="draggable-element" draggable="true" data-type="package_barcode">ğŸ“Š Paket Barkod</div>
                <div class="draggable-element" draggable="true" data-type="main_product">ğŸ¯ Ana ÃœrÃ¼n</div>
                <div class="draggable-element" draggable="true" data-type="package_quantity">ğŸ“¦ Paket Adedi</div>
                <div class="draggable-element" draggable="true" data-type="package_content">ğŸ“„ Paket Ä°Ã§eriÄŸi</div>
                <div class="draggable-element" draggable="true" data-type="package_dimensions">ğŸ“ Boyutlar</div>
                <div class="draggable-element" draggable="true" data-type="package_weight">âš–ï¸ AÄŸÄ±rlÄ±k</div>
                <div class="draggable-element" draggable="true" data-type="shelf_location">ğŸ“ Raf Konumu</div>
                <div class="draggable-element" draggable="true" data-type="date">ğŸ“… Tarih</div>
              </div>
            </div>

            <!-- Resim YÃ¼kleme -->
            <div class="form-group">
              <label>Resim YÃ¼kle:</label>
              <div class="image-upload-area">
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button type="button" class="btn" onclick="document.getElementById('imageUpload').click()">
                  ğŸ“· Resim SeÃ§
                </button>
                <div class="draggable-element image-element" draggable="true" data-type="custom_image" style="display: none;">
                  ğŸ–¼ï¸ Ã–zel Resim
                </div>
              </div>
              <div id="uploadedImages" class="uploaded-images"></div>
            </div>

            <!-- TasarÄ±m AlanÄ± -->
            <div class="form-group">
              <label>Template TasarÄ±m AlanÄ±:</label>
              <div id="dragDropArea" class="drag-drop-area">
                <p>Elementleri buraya sÃ¼rÃ¼kleyip bÄ±rakÄ±n</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem;">Elementleri konumlandÄ±rmak iÃ§in sÃ¼rÃ¼kleyin</p>
              </div>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary" onclick="saveTemplate()">
                ğŸ’¾ Template Kaydet
              </button>
              <button class="btn" onclick="loadTemplate()">
                ğŸ“ Template YÃ¼kle
              </button>
              <button class="btn" onclick="resetTemplate()">
                ğŸ”„ SÄ±fÄ±rla
              </button>
            </div>
          </div>

          <div class="editor-right">
            <h3>CanlÄ± Ã–nizleme</h3>
            <div id="templatePreview" class="template-preview">
              <!-- Template Ã¶nizlemesi buraya gelecek -->
            </div>
            
            <div class="sample-data">
              <h4>Ã–rnek Paket Verisi</h4>
              <div class="form-row">
                <div>
                  <label>Paket SKU:</label>
                  <input type="text" id="samplePackageSKU" value="PK-SAMPLE-001" onchange="updateTemplatePreview()">
                </div>
                <div>
                  <label>Paket AdÄ±:</label>
                  <input type="text" id="samplePackageName" value="Ã–rnek Paket" onchange="updateTemplatePreview()">
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Paket Barkod:</label>
                  <input type="text" id="samplePackageBarcode" value="1234567890123" onchange="updateTemplatePreview()">
                </div>
                <div>
                  <label>Ana ÃœrÃ¼n:</label>
                  <input type="text" id="sampleMainProduct" value="Ã–rnek Ana ÃœrÃ¼n" onchange="updateTemplatePreview()">
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Paket Adedi:</label>
                  <input type="text" id="samplePackageQuantity" value="5 adet" onchange="updateTemplatePreview()">
                </div>
                <div>
                  <label>Ä°Ã§erik:</label>
                  <input type="text" id="samplePackageContent" value="Standart paket" onchange="updateTemplatePreview()">
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Boyutlar:</label>
                  <input type="text" id="samplePackageDimensions" value="50x30x20cm" onchange="updateTemplatePreview()">
                </div>
                <div>
                  <label>AÄŸÄ±rlÄ±k:</label>
                  <input type="text" id="samplePackageWeight" value="2.5kg" onchange="updateTemplatePreview()">
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label>Raf Konumu:</label>
                  <input type="text" id="sampleShelfLocation" value="A1-01-359" onchange="updateTemplatePreview()">
                </div>
                <div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(11, 18, 32, 0.8);
  backdrop-filter: blur(4px);
}

.modal-content {
  background: var(--card);
  margin: 2% auto;
  padding: 0;
  border: 1px solid var(--border);
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  border-radius: 8px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  color: var(--fg);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.modal-header {
  background: linear-gradient(135deg, var(--accent), var(--accent));
  color: white;
  padding: 1rem;
  border-radius: 8px 8px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.modal-body {
  padding: 1.5rem;
  background: var(--card);
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}

/* Custom Scrollbar Styles */
.modal-body::-webkit-scrollbar {
  width: 8px;
}

.modal-body::-webkit-scrollbar-track {
  background: var(--bg);
  border-radius: 4px;
}

.modal-body::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
  transition: background 0.3s;
}

.modal-body::-webkit-scrollbar-thumb:hover {
  background: #3d8bff;
}

/* Firefox Scrollbar */
.modal-body {
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--bg);
}

.close {
  color: white;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: opacity 0.3s;
}

.close:hover {
  opacity: 0.7;
}

.tabs {
  display: flex;
  border-bottom: 2px solid var(--border);
  margin-bottom: 1.5rem;
  background: var(--bg);
  border-radius: 6px;
  padding: 4px;
}

.tab-btn {
  background: none;
  border: none;
  padding: 0.75rem 1.5rem;
  cursor: pointer;
  font-size: 1rem;
  border-radius: 4px;
  transition: all 0.3s;
  color: var(--muted);
  flex: 1;
  text-align: center;
}

.tab-btn.active {
  background: var(--accent);
  color: white;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(77, 163, 255, 0.3);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.form-row {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  align-items: center;
}

.form-row > div {
  flex: 1;
}

.form-row label {
  color: var(--fg);
  font-weight: 500;
  margin-bottom: 0.5rem;
  display: block;
}

.form-row input, .form-row select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg);
  color: var(--fg);
  font-size: 0.9rem;
}

.form-row input:focus, .form-row select:focus {
  border-color: var(--accent);
  outline: none;
  box-shadow: 0 0 0 2px rgba(77, 163, 255, 0.2);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  color: var(--fg);
  font-weight: 500;
  margin-bottom: 0.75rem;
  display: block;
}

.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem 1rem;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  color: var(--fg);
  font-weight: normal;
  cursor: pointer;
}

.checkbox-group input[type="checkbox"] {
  width: auto;
  margin: 0;
}

.layout-options {
  display: flex;
  gap: 1rem;
}

.layout-options label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--fg);
  cursor: pointer;
}

.barcode-preview {
  border: 2px dashed var(--border);
  padding: 1rem;
  min-height: 150px;
  background: var(--bg);
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 1rem 0;
  border-radius: 6px;
  color: var(--muted);
}

.template-editor {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  overflow: hidden;
  height: 100%;
}

@media (max-width: 1200px) {
  .template-editor {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
}

.editor-left, .editor-right {
  background: var(--bg);
  padding: 1rem;
  border-radius: 8px;
  border: 1px solid var(--border);
  min-width: 0; /* Grid overflow fix */
  overflow-y: auto;
  min-height: 0;
}

/* Scrollbar for editor panels */
.editor-left::-webkit-scrollbar,
.editor-right::-webkit-scrollbar {
  width: 6px;
}

.editor-left::-webkit-scrollbar-track,
.editor-right::-webkit-scrollbar-track {
  background: var(--card);
  border-radius: 3px;
}

.editor-left::-webkit-scrollbar-thumb,
.editor-right::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.editor-left::-webkit-scrollbar-thumb:hover,
.editor-right::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

@media (min-width: 1200px) {
  .editor-left, .editor-right {
    padding: 1.5rem;
  }
}

.editor-left h3, .editor-right h3 {
  color: var(--fg);
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 1.1rem;
}

.template-preview {
  border: 2px solid var(--border);
  background: var(--card);
  padding: 1rem;
  min-height: 200px;
  max-height: 400px;
  width: 100%;
  max-width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 1rem;
  border-radius: 6px;
  color: var(--muted);
  overflow: hidden;
  position: relative;
  box-sizing: border-box;
}

.template-preview .template-container {
  transform-origin: center;
  transition: transform 0.3s ease;
  max-width: 100%;
  max-height: 100%;
}

.template-preview.scaled .template-container {
  transform: scale(var(--preview-scale, 1));
}

.sample-data {
  background: var(--card);
  padding: 1rem;
  border-radius: 6px;
  border: 1px solid var(--border);
}

.sample-data h4 {
  color: var(--fg);
  margin-top: 0;
  margin-bottom: 1rem;
}

/* Drag & Drop Template Editor */
.drag-drop-area {
  border: 2px dashed var(--border);
  border-radius: 6px;
  padding: 2rem;
  text-align: center;
  background: var(--bg);
  margin-bottom: 1rem;
  transition: all 0.3s;
  min-height: 300px;
  max-height: 400px;
  position: relative;
  overflow: auto;
}

/* Scrollbar for drag-drop area */
.drag-drop-area::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.drag-drop-area::-webkit-scrollbar-track {
  background: var(--card);
  border-radius: 3px;
}

.drag-drop-area::-webkit-scrollbar-thumb {
  background: var(--border);
  border-radius: 3px;
}

.drag-drop-area::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

.drag-drop-area.dragover {
  border-color: var(--accent);
  background: rgba(77, 163, 255, 0.1);
}

.drag-drop-area p {
  color: var(--muted);
  margin: 0;
  font-size: 0.9rem;
}

.template-elements {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 1rem;
}

.draggable-element {
  background: var(--accent);
  color: white;
  padding: 0.5rem 0.75rem;
  border-radius: 4px;
  cursor: grab;
  font-size: 0.8rem;
  font-weight: 500;
  transition: all 0.3s;
  user-select: none;
}

.draggable-element:hover {
  background: #3d8bff;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(77, 163, 255, 0.3);
}

.draggable-element:active {
  cursor: grabbing;
}

.dropped-element {
  position: absolute;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 0.5rem;
  font-size: 0.8rem;
  color: var(--fg);
  cursor: move;
  min-width: 60px;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.dropped-element:hover {
  border-color: var(--accent);
  box-shadow: 0 2px 8px rgba(77, 163, 255, 0.3);
}

.dropped-element .remove-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  width: 16px;
  height: 16px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 10px;
  cursor: pointer;
  display: none;
}

.dropped-element:hover .remove-btn {
  display: flex;
  align-items: center;
  justify-content: center;
}

.barcode-element {
  border: 2px solid var(--accent);
  background: white;
  color: black;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.25rem;
  min-width: 80px;
}

.barcode-bars {
  font-family: 'Courier New', monospace;
  font-size: 8px;
  line-height: 1;
  margin: 2px 0;
  letter-spacing: 0;
}

.barcode-numbers {
  font-size: 6px;
  font-family: 'Courier New', monospace;
  margin-top: 1px;
}

/* Image Upload Styles */
.image-upload-area {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.uploaded-images {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.uploaded-image-item {
  position: relative;
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow: hidden;
  background: var(--card);
}

.uploaded-image-item img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  display: block;
}

.uploaded-image-item .remove-image {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 16px;
  height: 16px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.image-element {
  background: var(--success) !important;
}

.custom-image-preview {
  max-width: 50px;
  max-height: 30px;
  object-fit: contain;
  border-radius: 2px;
}

.form-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.btn {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--fg);
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s;
  font-weight: 500;
}

.btn:hover {
  background: var(--hover);
  border-color: var(--accent);
}

.btn-primary {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

.btn-primary:hover {
  background: #3d8bff;
  box-shadow: 0 2px 8px rgba(77, 163, 255, 0.3);
}

.btn-success {
  background: var(--success);
  color: white;
  border-color: var(--success);
}

.btn-success:hover {
  background: #16a34a;
  box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
}

@media (max-width: 768px) {
  .template-editor {
    grid-template-columns: 1fr;
    gap: 0.5rem;
    height: auto;
  }
  
  .editor-left, .editor-right {
    padding: 0.75rem;
    max-height: 50vh;
  }
  
  .form-row {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .checkbox-group {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .template-preview {
    min-height: 150px;
    max-height: 250px;
    padding: 0.5rem;
  }
  
  .drag-drop-area {
    min-height: 200px;
    max-height: 300px;
    padding: 1rem;
  }
  
  .modal-content {
    width: 95%;
    max-height: 95vh;
    margin: 1% auto;
  }
  
  .modal-body {
    padding: 1rem;
  }
}
</style>

<script>
// Drag & Drop Template Editor Enhancement
let droppedElements = [];
let draggedElement = null;

// Enhanced updateTemplatePreview with scaling
function enhancedUpdateTemplatePreview() {
  const width = parseInt(document.getElementById('templateWidth')?.value) || 50;
  const height = parseInt(document.getElementById('templateHeight')?.value) || 30;
  
  const preview = document.getElementById('templatePreview');
  if (!preview) return;
  
  // Preview alanÄ±nÄ±n gerÃ§ek boyutlarÄ±nÄ± al
  const previewRect = preview.getBoundingClientRect();
  const maxWidth = previewRect.width - 32; // Padding iÃ§in margin
  const maxHeight = previewRect.height - 32;
  
  // mm to px dÃ¶nÃ¼ÅŸÃ¼mÃ¼ (1mm = ~3.78px)
  const widthPx = width * 3.78;
  const heightPx = height * 3.78;
  
  // Ã–lÃ§ekleme hesapla - preview alanÄ±na gÃ¶re dinamik
  const scaleX = maxWidth / widthPx;
  const scaleY = maxHeight / heightPx;
  const scale = Math.min(scaleX, scaleY, 1);
  
  const container = document.createElement('div');
  container.style.cssText = `
    width: ${width}mm; 
    height: ${height}mm; 
    border: 2px solid var(--accent); 
    background: white; 
    color: black;
    position: relative;
    overflow: hidden;
    transform: scale(${scale});
    margin: auto;
  `;
  
  if (droppedElements.length === 0) {
    container.innerHTML = `
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                  color: #999; text-align: center; font-size: 12px;">
        Elementleri sÃ¼rÃ¼kleyip bÄ±rakÄ±n
      </div>
    `;
  } else {
    droppedElements.forEach(element => {
      const elemDiv = document.createElement('div');
      elemDiv.style.cssText = `
        position: absolute;
        left: ${element.x}px;
        top: ${element.y}px;
        font-size: 10px;
        padding: 2px 4px;
        background: rgba(77, 163, 255, 0.1);
        border: 1px solid var(--accent);
        border-radius: 2px;
      `;
      
      if (element.type === 'package_barcode') {
        const barcodeNumber = document.getElementById('samplePackageBarcode')?.value || '1234567890123';
        elemDiv.innerHTML = `
          <div style="font-family: 'Courier New', monospace; font-size: 8px; line-height: 1; margin: 2px 0; text-align: center;">
            ||||| |||| | || |||| ||||| |
          </div>
          <div style="font-size: 6px; font-family: 'Courier New', monospace; margin-top: 1px; text-align: center;">
            ${barcodeNumber}
          </div>
        `;
      } else if (element.type === 'custom_image' && element.imageData) {
        elemDiv.innerHTML = `<img src="${element.imageData}" class="custom-image-preview">`;
      } else {
        elemDiv.textContent = getElementSampleData(element.type);
      }
      
      container.appendChild(elemDiv);
    });
  }
  
  preview.innerHTML = '';
  preview.appendChild(container);
  
  if (scale < 1) {
    const scaleInfo = document.createElement('div');
    scaleInfo.style.cssText = `
      position: absolute; 
      bottom: 5px; 
      right: 5px; 
      font-size: 10px; 
      color: var(--muted);
      background: var(--bg);
      padding: 2px 4px;
      border-radius: 2px;
    `;
    scaleInfo.textContent = `${Math.round(scale * 100)}%`;
    preview.appendChild(scaleInfo);
  }
}

function getElementSampleData(type) {
  const sampleData = {
    package_sku: document.getElementById('samplePackageSKU')?.value || 'PK-SAMPLE-001',
    package_name: document.getElementById('samplePackageName')?.value || 'Ã–rnek Paket',
    package_barcode: document.getElementById('samplePackageBarcode')?.value || '1234567890123',
    main_product: document.getElementById('sampleMainProduct')?.value || 'Ã–rnek Ana ÃœrÃ¼n',
    package_quantity: document.getElementById('samplePackageQuantity')?.value || '5 adet',
    package_content: document.getElementById('samplePackageContent')?.value || 'Standart paket',
    package_dimensions: document.getElementById('samplePackageDimensions')?.value || '50x30x20cm',
    package_weight: document.getElementById('samplePackageWeight')?.value || '2.5kg',
    shelf_location: document.getElementById('sampleShelfLocation')?.value || 'A1-01-359',
    date: new Date().toLocaleDateString('tr-TR'),
    custom_image: 'Ã–zel Resim'
  };
  return sampleData[type] || type.toUpperCase();
}

// Drag & Drop Event Listeners
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    const dragDropArea = document.getElementById('dragDropArea');
    if (!dragDropArea) return;
    
    // Image upload handling
    const imageUpload = document.getElementById('imageUpload');
    if (imageUpload) {
      imageUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const imageData = e.target.result;
            addUploadedImage(file.name, imageData);
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Draggable elements
    document.querySelectorAll('.draggable-element').forEach(element => {
      element.addEventListener('dragstart', function(e) {
        const dragData = { type: this.dataset.type, text: this.textContent };
        if (this.dataset.imageData) {
          dragData.imageData = this.dataset.imageData;
        }
        draggedElement = dragData;
        e.dataTransfer.effectAllowed = 'copy';
      });
    });
    
    // Drop area events
    dragDropArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    
    dragDropArea.addEventListener('dragleave', function(e) {
      if (!this.contains(e.relatedTarget)) {
        this.classList.remove('dragover');
      }
    });
    
    dragDropArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      
      if (draggedElement) {
        const rect = this.getBoundingClientRect();
        const x = e.clientX - rect.left - 32;
        const y = e.clientY - rect.top - 16;
        
        const elementId = Date.now();
        const droppedElement = {
          id: elementId,
          type: draggedElement.type,
          x: Math.max(0, x),
          y: Math.max(0, y),
          imageData: draggedElement.imageData || null
        };
        
        droppedElements.push(droppedElement);
        createDroppedElement(droppedElement);
        enhancedUpdateTemplatePreview();
        draggedElement = null;
      }
    });
    
    // Template boyutu deÄŸiÅŸtiÄŸinde Ã¶nizlemeyi gÃ¼ncelle
    const widthInput = document.getElementById('templateWidth');
    const heightInput = document.getElementById('templateHeight');
    if (widthInput) widthInput.addEventListener('input', enhancedUpdateTemplatePreview);
    if (heightInput) heightInput.addEventListener('input', enhancedUpdateTemplatePreview);
    
    // Pencere boyutu deÄŸiÅŸtiÄŸinde Ã¶nizlemeyi yeniden hesapla
    window.addEventListener('resize', function() {
      clearTimeout(this.resizeTimeout);
      this.resizeTimeout = setTimeout(enhancedUpdateTemplatePreview, 150);
    });
    
    // Override original function
    if (window.updateTemplatePreview) {
      window.updateTemplatePreview = enhancedUpdateTemplatePreview;
    }
  }, 500);
});

function createDroppedElement(element) {
  const div = document.createElement('div');
  div.className = 'dropped-element';
  div.dataset.id = element.id;
  div.style.left = element.x + 'px';
  div.style.top = element.y + 'px';
  
  if (element.type === 'package_barcode') {
    div.classList.add('barcode-element');
    const barcodeNumber = document.getElementById('samplePackageBarcode')?.value || '1234567890123';
    div.innerHTML = `
      <div class="barcode-bars">||||| |||| | || |||| ||||| |</div>
      <div class="barcode-numbers">${barcodeNumber}</div>
      <button class="remove-btn">&times;</button>
    `;
  } else if (element.type === 'custom_image' && element.imageData) {
    div.innerHTML = `
      <img src="${element.imageData}" style="max-width: 40px; max-height: 30px; object-fit: contain;">
      <button class="remove-btn">&times;</button>
    `;
  } else {
    div.textContent = getElementSampleData(element.type);
    div.innerHTML += '<button class="remove-btn">&times;</button>';
  }
  
  // Make draggable within drop area
  div.addEventListener('mousedown', function(e) {
    if (e.target.classList.contains('remove-btn')) return;
    
    let isMoving = false;
    const startX = e.clientX - div.offsetLeft;
    const startY = e.clientY - div.offsetTop;
    
    function onMouseMove(e) {
      isMoving = true;
      const newX = e.clientX - startX;
      const newY = e.clientY - startY;
      
      div.style.left = Math.max(0, newX) + 'px';
      div.style.top = Math.max(0, newY) + 'px';
      
      const dataElement = droppedElements.find(el => el.id === element.id);
      if (dataElement) {
        dataElement.x = Math.max(0, newX);
        dataElement.y = Math.max(0, newY);
      }
    }
    
    function onMouseUp() {
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
      if (isMoving) enhancedUpdateTemplatePreview();
    }
    
    document.addEventListener('mousemove', onMouseMove);
    document.addEventListener('mouseup', onMouseUp);
  });
  
  // Remove button
  div.querySelector('.remove-btn').addEventListener('click', function(e) {
    e.stopPropagation();
    droppedElements = droppedElements.filter(el => el.id !== element.id);
    div.remove();
    enhancedUpdateTemplatePreview();
  });
  
  document.getElementById('dragDropArea').appendChild(div);
}

// Image upload functions
function addUploadedImage(fileName, imageData) {
  const uploadedImagesContainer = document.getElementById('uploadedImages');
  const imageElement = document.querySelector('.image-element');
  
  // Show the draggable image element
  if (imageElement) {
    imageElement.style.display = 'inline-block';
    imageElement.dataset.imageData = imageData;
    imageElement.textContent = `ğŸ–¼ï¸ ${fileName.substring(0, 10)}${fileName.length > 10 ? '...' : ''}`;
  }
  
  // Create preview
  const imageItem = document.createElement('div');
  imageItem.className = 'uploaded-image-item';
  imageItem.innerHTML = `
    <img src="${imageData}" alt="${fileName}">
    <button class="remove-image" onclick="removeUploadedImage(this, '${fileName}')">&times;</button>
  `;
  
  uploadedImagesContainer.appendChild(imageItem);
}

function removeUploadedImage(button, fileName) {
  // Remove preview
  button.closest('.uploaded-image-item').remove();
  
  // Check if no more images, hide draggable element
  const uploadedImagesContainer = document.getElementById('uploadedImages');
  const imageElement = document.querySelector('.image-element');
  
  if (uploadedImagesContainer.children.length === 0 && imageElement) {
    imageElement.style.display = 'none';
    imageElement.removeAttribute('data-image-data');
    imageElement.textContent = 'ğŸ–¼ï¸ Ã–zel Resim';
  }
}

// Paket verilerini gerÃ§ek API'den Ã§ekme fonksiyonu
function getPackageDataForProduct(productId, packageId) {
  // Bu fonksiyon seÃ§ili Ã¼rÃ¼nÃ¼n paket bilgilerini API'den Ã§eker
  return fetch(`/api/products/${productId}/packages/${packageId}`)
    .then(r => r.json())
    .then(packageData => {
      return {
        package_sku: packageData.sku || packageData.package_number || 'PK-' + packageData.id,
        package_name: packageData.package_name || packageData.package_name_tr,
        package_barcode: packageData.barcode || '',
        main_product: packageData.product_name || 'Ana ÃœrÃ¼n',
        package_quantity: packageData.quantity + ' adet' || '1 adet',
        package_content: packageData.package_content || packageData.package_content_tr || '',
        package_dimensions: `${packageData.length_cm}x${packageData.width_cm}x${packageData.height_cm}cm` || '',
        package_weight: packageData.weight_kg + 'kg' || '',
        shelf_location: packageData.shelf_location || packageData.shelf_name || '',
        date: new Date().toLocaleDateString('tr-TR')
      };
    });
}

// Global deÄŸiÅŸkenler ve script baÅŸlatÄ±cÄ±
let currentFilteredProducts = null; // Global deÄŸiÅŸken

// DEBUG
console.log('ğŸ“ Script yÃ¼klendi, deÄŸiÅŸkenler kontrol ediliyor...');
console.log('- products:', typeof products);
console.log('- filteredProducts:', typeof filteredProducts);
console.log('- API:', typeof API);

// DOM hazÄ±r olduÄŸunda Ã¼rÃ¼nleri yÃ¼kle
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOM hazÄ±r, Ã¼rÃ¼nler yÃ¼kleniyor...');
    refresh();
  });
} else {
  console.log('âœ… DOM zaten hazÄ±r, hemen yÃ¼kle');
  setTimeout(() => refresh(), 100); // KÄ±sa bir gecikme ile
}
</script>

</body>
</html>
