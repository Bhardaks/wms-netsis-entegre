<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Sipari≈üler</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/auth.js"></script>
  <style>
    /* Global mobile overflow fix */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    
    *, *:before, *:after {
      box-sizing: border-box;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
    }
    .tab-btn {
      background: none;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      font-weight: 500;
    }
    .tab-btn:hover {
      background-color: #f5f5f5;
    }
    .tab-btn.active {
      border-bottom-color: #007bff;
      color: #007bff;
    }
    .table-container {
      overflow-x: auto;
    }
    
    /* Desktop table optimizations */
    @media (min-width: 769px) {
      table {
        table-layout: fixed;
        width: 100%;
      }
      
      th:nth-child(1), td:nth-child(1) { width: 12%; } /* Sipari≈ü No */
      th:nth-child(2), td:nth-child(2) { width: 20%; } /* M√º≈üteri */
      th:nth-child(3), td:nth-child(3) { width: 12%; } /* Durum */
      th:nth-child(4), td:nth-child(4) { width: 25%; } /* Kalemler */
      th:nth-child(5), td:nth-child(5) { width: 15%; } /* Tarih */
      th:nth-child(6), td:nth-child(6) { width: 16%; } /* ƒ∞≈ülem */
      
      .action-btn {
        width: 100%;
        max-width: none;
      }
    }
    
    /* Mobile optimizations - clean card layout */
    @media (max-width: 768px) {
      /* Site header mobile fixes */
      header {
        padding: 12px 16px;
        flex-wrap: nowrap;
      }
      
      header h1 {
        font-size: 18px;
        margin: 0;
        flex-shrink: 0;
      }
      
      header nav {
        display: none;
      }
      
      /* COMPLETE FILTER OVERRIDE FOR MOBILE */
      .filters-mobile {
        display: block !important;
        width: 100% !important;
        margin: 0 0 20px 0 !important;
        padding: 0 !important;
        background: none !important;
        border: none !important;
        flex: none !important;
        gap: 0 !important;
        flex-direction: column !important;
        align-items: stretch !important;
        justify-content: flex-start !important;
        flex-wrap: nowrap !important;
      }
      
      .filters-mobile * {
        float: none !important;
        position: static !important;
        transform: none !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        left: auto !important;
        right: auto !important;
        top: auto !important;
        bottom: auto !important;
      }
      
      .filters-mobile input,
      .filters-mobile select,
      .filters-mobile button {
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        margin: 0 0 12px 0 !important;
        padding: 12px 16px !important;
        font-size: 16px !important;
        border: 2px solid #ddd !important;
        border-radius: 8px !important;
        background: #0e1a30 !important;
        color: var(--fg) !important;
        box-sizing: border-box !important;
        flex: none !important;
        position: relative !important;
        clear: both !important;
      }
      
      .filters-mobile input:focus,
      .filters-mobile select:focus {
        border-color: var(--accent) !important;
        outline: none !important;
      }
      /* Reset everything for mobile */
      .table-container {
        overflow: visible;
        margin: 0;
        padding: 0;
      }
      
      table {
        display: none !important;
      }
      
      /* Mobile card layout */
      .mobile-orders {
        display: block !important;
      }
      
      .order-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        margin-bottom: 16px;
        padding: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .order-number {
        font-size: 16px;
        font-weight: bold;
        color: var(--accent);
      }
      
      .order-status {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
      }
      
      .order-info {
        margin-bottom: 12px;
      }
      
      .info-row {
        display: flex;
        margin-bottom: 8px;
        align-items: flex-start;
      }
      
      .info-label {
        font-weight: 600;
        color: var(--muted);
        min-width: 70px;
        font-size: 13px;
      }
      
      .info-value {
        flex: 1;
        font-size: 14px;
        line-height: 1.3;
      }
      
      .order-items-mobile {
        background: var(--hover);
        border-radius: 6px;
        padding: 8px;
        margin: 8px 0;
        font-size: 13px;
        line-height: 1.4;
      }
      
      .mobile-action-btn {
        width: 100%;
        padding: 12px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 8px;
      }
      
      .btn-primary-mobile {
        background: var(--accent);
        color: white;
      }
      
      .btn-warning-mobile {
        background: #ffc107;
        color: #000;
      }
      
      .btn-success-mobile {
        background: var(--success);
        color: white;
      }
      
      .btn-disabled-mobile {
        background: var(--muted);
        color: var(--fg);
        opacity: 0.6;
        cursor: not-allowed;
      }
      
      .btn-danger-mobile {
        background: var(--danger);
        color: white;
      }
      
      /* Header and filters mobile optimization */
      .order-header-section {
        flex-direction: column !important;
        gap: 12px !important;
        align-items: stretch !important;
      }
      
      .header-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }
      
      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      
      
      /* Tab navigation improvements */
      .tabs {
        margin-bottom: 16px;
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
      
      .tab-btn {
        min-width: 80px;
        padding: 8px 16px;
        font-size: 13px;
        flex-shrink: 0;
      }
      
      /* Main layout adjustments */
      main {
        padding: 8px !important;
        margin: 0 !important;
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      .card {
        margin: 0 0 16px 0 !important;
        padding: 16px !important;
        border-radius: 12px;
      }
      
      /* Hide desktop table on mobile */
      .desktop-table {
        display: none !important;
      }
    }
    
    /* Desktop - hide mobile cards */
    @media (min-width: 769px) {
      .mobile-orders {
        display: none !important;
      }
      
      .desktop-table {
        display: table !important;
      }
      
      /* Reset mobile header styles for desktop */
      .order-header-section {
        flex-direction: row !important;
        align-items: center !important;
      }
      
      .header-title-row {
        flex: 1;
        justify-content: space-between;
      }
      
      .filters-mobile {
        display: flex !important;
        flex-direction: row !important;
        gap: 12px !important;
        align-items: center;
        margin-bottom: 16px !important;
      }
      
      .filters-mobile input {
        flex: 1 !important;
        min-width: 200px !important;
        width: auto !important;
        margin-bottom: 0 !important;
        padding: 8px !important;
        background: #0e1a30 !important;
      }
      
      .filters-mobile select {
        width: auto !important;
        flex: none !important;
        margin-bottom: 0 !important;
        padding: 8px !important;
        background: #0e1a30 !important;
      }
    }
    
    /* General action button styles */
    .action-btn {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--accent);
      color: white;
      text-align: center;
      max-width: 150px;
      box-sizing: border-box;
    }
    
    .action-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--muted);
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    .status-open { background: #e3f2fd; color: #1976d2; }
    .status-approved { background: #fff3e0; color: #f57c00; }
    .status-fulfilled { background: #e8f5e8; color: #4caf50; }
    .status-cancelled { background: #ffebee; color: #f44336; }
    .status-partially-fulfilled { background: #ffeaa7; color: #d63031; }
    .status-new { background: #e8f5e8; color: #2e7d32; }
    .order-items {
      max-width: 250px;
      font-size: 12px;
      color: #666;
    }
    .order-date {
      font-size: 12px;
      color: #666;
    }
    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 4px;
    }
    .btn-pick {
      background: #4caf50;
      color: white;
    }
    .btn-pick:hover {
      background: #45a049;
    }
    .btn-pick:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .fulfillment-status {
      font-size: 11px;
      color: #666;
      margin-top: 2px;
    }
  </style>
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS Y√∂netim Sistemi</h1>
    <span class="header-subtitle">Sipari≈ü Y√∂netimi</span>
  </div>
  <div class="header-actions">
    <a href="/add-order.html" class="action-btn" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
      <span class="btn-icon">‚ûï</span>
      <span class="btn-text">Yeni Sipari≈ü</span>
    </a>
    <a href="/index.html" class="home-btn">
      <span class="home-icon">üè†</span>
      <span class="home-text">Ana Sayfa</span>
    </a>
  </div>
</header>

<main class="grid" style="max-width:1200px;margin:auto;padding:16px">
  <section class="card">
    <div class="flex order-header-section" style="justify-content:space-between;align-items:center;margin-bottom:16px">
      <div class="header-title-row">
        <h2>Sipari≈üler</h2>
        <div class="header-actions">
          <span class="badge" id="syncOrdersOut"></span>
        </div>
      </div>
    </div>

    <!-- Filtre ve Arama -->
    <div class="filters-mobile">
      <input type="text" id="searchInput" placeholder="Sipari≈ü no veya m√º≈üteri adƒ± ara...">
      <select id="statusFilter">
        <option value="all">T√ºm Durumlar</option>
        <option value="open" selected>A√ßƒ±k</option>
        <option value="approved">Onaylanmƒ±≈ü</option>
        <option value="fulfilled">Tamamlanmƒ±≈ü</option>
        <option value="cancelled">ƒ∞ptal Edilmi≈ü</option>
      </select>
    </div>

    <!-- Sekmeler -->
    <div class="tabs" style="margin-bottom:16px">
      <button class="tab-btn active" data-tab="ongoing">Devam Eden Sipari≈üler (<span id="ongoingCount">0</span>)</button>
      <button class="tab-btn" data-tab="completed">Tamamlanan (<span id="completedCount">0</span>)</button>
    </div>

    <!-- Sipari≈ü Tablosu - Desktop -->
    <div class="table-container desktop-table">
      <table id="ordTable">
        <thead>
          <tr>
            <th>Sipari≈ü No</th>
            <th>M√º≈üteri</th>
            <th>Durum</th>
            <th>Kalemler</th>
            <th>Tarih</th>
            <th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <!-- Sipari≈ü Cards - Mobile -->
    <div class="mobile-orders" style="display: none;">
      <div id="mobileOrderList"></div>
    </div>
  </section>
</main>

<script type="module">
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

const API = {
  listOrders: () => {
    console.log('üåê Fetching /api/orders...');
    return fetch('/api/orders').then(r => {
      console.log('üì° Response status:', r.status);
      return r.json();
    }).catch(error => {
      console.error('üö® API Error:', error);
      throw error;
    });
  },
  getOrder: (id) => fetch('/api/orders/' + id).then(r => r.json()),
  createPick: (order_id) => fetch('/api/picks', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ order_id })
  }).then(r => r.json()),
  syncNetsisData: () => fetch('/api/netsis/sync/products', { method: 'POST' }).then(r => r.json()),
};

// Global state
let allOrders = [];
let netsisOrders = [];
let currentTab = 'ongoing';
let searchTerm = '';
let statusFilter = 'open';

// M√º≈üteri adƒ±nƒ± temizleme fonksiyonu
function cleanCustomerName(customerName) {
  if (!customerName || customerName === '-') return 'Bilinmeyen M√º≈üteri';
  
  const customerNameMapping = {};
  
  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (uuidPattern.test(customerName)) {
    const realName = customerNameMapping[customerName.toLowerCase()];
    if (realName) return realName;
    return customerName; // UUID'yi olduƒüu gibi d√∂nd√ºr, otomatik d√∂n√º≈ü√ºm yok
  }
  
  return customerName;
}

// Durum bazƒ±nda sipari≈üleri kategorize et
function categorizeOrder(order) {
  if (order.status === 'cancelled' || order.fulfillment_status === 'CANCELLED') {
    return 'cancelled';
  }
  
  if (order.fulfillment_status === 'FULFILLED' || order.status === 'fulfilled') {
    return 'completed';
  }
  
  return 'ongoing';
}

// Netsis sipari≈ülerini y√ºkle
async function loadNetsisOrders() {
  try {
    const response = await fetch('/api/netsis/orders?status=new');
    if (!response.ok) throw new Error('Netsis sipari≈üleri y√ºklenemedi');
    const data = await response.json();
    
    netsisOrders = (data.orders || []).map(order => ({
      ...order,
      created_date: new Date(order.sync_tarihi),
      total_display: parseFloat(order.toplam_tutar || 0).toFixed(2)
    }));
    
    console.log('Loaded Netsis orders:', netsisOrders.length);
    return netsisOrders;
  } catch (error) {
    console.error('Error loading Netsis orders:', error);
    netsisOrders = [];
    return [];
  }
}


// Sipari≈üleri y√ºkle - Sadece WMS veritabanƒ±ndan
async function loadOrders() {
  try {
    console.log('üîÑ Loading orders from API...');
    // WMS API'sinden t√ºm sipari≈üleri y√ºkle
    const wmsResponse = await API.listOrders();
    console.log('üì¶ Orders loaded:', wmsResponse?.length || 0, 'orders');
    allOrders = wmsResponse || [];
    
    // Netsis sipari≈ülerini y√ºkle (≈üimdilik bo≈ü)
    netsisOrders = [];
    
    updateCounts();
    filterAndDisplayOrders();
    console.log('‚úÖ Orders display updated');
  } catch (error) {
    console.error('‚ùå Error loading orders:', error);
    // Error durumunda bo≈ü dizi g√∂ster
    allOrders = [];
    updateCounts();
    filterAndDisplayOrders();
  }
}

// Saya√ß g√ºncellemeleri - Sadece WMS sipari≈üleri
function updateCounts() {
  const ongoingCount = allOrders.filter(o => categorizeOrder(o) === 'ongoing').length;
  const completedCount = allOrders.filter(o => categorizeOrder(o) === 'completed').length;
  
  $('#ongoingCount').textContent = ongoingCount;
  $('#completedCount').textContent = completedCount;
}

// Sipari≈üleri filtrele ve g√∂ster - Sadece WMS sipari≈üleri
function filterAndDisplayOrders() {
  let filteredOrders = [];
  
  if (currentTab === 'ongoing') {
    filteredOrders = allOrders.filter(o => categorizeOrder(o) === 'ongoing');
  } else if (currentTab === 'completed') {
    filteredOrders = allOrders.filter(o => categorizeOrder(o) === 'completed');
  } else {
    // Varsayƒ±lan: Devam eden sipari≈üler
    filteredOrders = allOrders.filter(o => categorizeOrder(o) === 'ongoing');
  }
  
  // Durum filtresi - Tamamlanan sekmesinde durum filtresini uygulama, √ß√ºnk√º tamamlanan sipari≈ülerin 
  // status'√º 'open' olabilir ama fulfillment_status'√º 'FULFILLED' olabilir
  if (statusFilter !== 'all' && currentTab !== 'completed') {
    filteredOrders = filteredOrders.filter(o => o.status === statusFilter);
  }
  
  // Arama filtresi
  if (searchTerm.trim()) {
    const term = searchTerm.toLowerCase().trim();
    filteredOrders = filteredOrders.filter(o => {
      const customerName = o.customer_name || o.customer_code || '';
      return o.order_number.toLowerCase().includes(term) ||
             cleanCustomerName(customerName).toLowerCase().includes(term);
    });
  }
  
  displayOrders(filteredOrders);
}

// Sipari≈üleri tabloda g√∂ster
function displayOrders(orders) {
  const tbody = $('#ordTable tbody');
  
  if (orders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666">Sipari≈ü bulunamadƒ±</td></tr>';
    return;
  }
  
  // Sipari≈ü numarasƒ±na g√∂re b√ºy√ºkten k√º√ß√ºƒüe sƒ±rala
  const sortedOrders = [...orders].sort((a, b) => {
    const orderA = parseInt(a.order_number) || 0;
    const orderB = parseInt(b.order_number) || 0;
    return orderB - orderA; // B√ºy√ºkten k√º√ß√ºƒüe
  });
  
  // Desktop table rendering
  tbody.innerHTML = sortedOrders.map(o => {
    const items = o.items || [];
    const count = items.length;
    
    let itemDetails = '';
    if (count === 0) {
      itemDetails = '<span style="color:#999;font-style:italic;">Sipari≈ü kalemleri y√ºkleniyor...</span>';
    } else {
      itemDetails = items.map(item => {
        // √úr√ºn adƒ± - √∂nce product_name, sonra sku, sonra varsayƒ±lan
        const productName = (item.product_name || item.sku || item.product_sku || '√úr√ºn adƒ± yok');
        const displayName = productName.length > 30 
          ? productName.substring(0, 30) + '...'
          : productName;
        
        // Renk durumu - Products tablosundan gelen ger√ßek renk bilgisi
        let colorInfo = '';
        if (item.product_color && item.product_color.trim()) {
          const color = item.product_color.trim();
          let bgColor = '#666'; // Default
          
          // Renk kodlarƒ±
          if (color.toUpperCase().includes('BEYAZ') || color.toUpperCase().includes('WHITE')) {
            bgColor = '#f8f9fa'; colorInfo = ` <span style="color:#000;background:${bgColor};padding:2px 6px;border-radius:3px;font-size:10px;border:1px solid #ccc;">${color}</span>`;
          } else if (color.toUpperCase().includes('Sƒ∞YAH') || color.toUpperCase().includes('BLACK')) {
            bgColor = '#000'; colorInfo = ` <span style="color:#fff;background:${bgColor};padding:2px 6px;border-radius:3px;font-size:10px;">${color}</span>`;
          } else if (color.toUpperCase().includes('KAHVE') || color.toUpperCase().includes('BROWN')) {
            bgColor = '#8B4513'; colorInfo = ` <span style="color:#fff;background:${bgColor};padding:2px 6px;border-radius:3px;font-size:10px;">${color}</span>`;
          } else if (color.toUpperCase().includes('GRƒ∞') || color.toUpperCase().includes('GRAY')) {
            bgColor = '#666'; colorInfo = ` <span style="color:#fff;background:${bgColor};padding:2px 6px;border-radius:3px;font-size:10px;">${color}</span>`;
          } else if (color.toUpperCase().includes('ANTRASIT') || color.toUpperCase().includes('ANTHRACITE')) {
            bgColor = '#654321'; colorInfo = ` <span style="color:#fff;background:${bgColor};padding:2px 6px;border-radius:3px;font-size:10px;">${color}</span>`;
          } else {
            // Diƒüer renkler i√ßin varsayƒ±lan stil
            colorInfo = ` <span style="color:#fff;background:#666;padding:2px 6px;border-radius:3px;font-size:10px;">${color}</span>`;
          }
        }
        
        // Miktar kontrol√º
        const quantity = item.quantity || item.miktar || 1;
        
        return `‚Ä¢ ${displayName}${colorInfo} x${quantity}`;
      }).slice(0, 3).join('<br>') + (items.length > 3 ? '<br>+ ' + (items.length - 3) + ' kalem daha...' : '');
    }
    
    const rawCustomerName = cleanCustomerName(o.customer_name);
    const displayCustomerName = rawCustomerName && rawCustomerName.length > 25 
      ? rawCustomerName.substring(0, 25) + '...'
      : rawCustomerName;
    
    // Durum class ve text belirleme
    let statusClass, statusText;
    
    if (o.fulfillment_status === 'PARTIALLY_FULFILLED') {
      statusClass = 'status-partially-fulfilled';
      statusText = 'Kƒ±smen Kar≈üƒ±landƒ±';
    } else if (o.fulfillment_status === 'FULFILLED') {
      statusClass = 'status-fulfilled';
      statusText = 'Tamamlanmƒ±≈ü';
    } else {
      statusClass = `status-${o.status}`;
      statusText = {
        'open': 'A√ßƒ±k',
        'approved': 'Onaylanmƒ±≈ü',
        'fulfilled': 'Tamamlanmƒ±≈ü',
        'cancelled': 'ƒ∞ptal Edilmi≈ü'
      }[o.status] || o.status;
    }
    
    // Tarih formatlamasƒ± - T√ºrkiye saati
    const orderDate = new Date(o.created_at).toLocaleDateString('tr-TR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    // Pick butonu mantƒ±ƒüƒ±
    let pickBtn;
    
    // ƒ∞ptal edilmi≈ü sipari≈üler i√ßin √∂zel durum
    if (o.category === 'cancelled') {
      pickBtn = `<button class="action-btn btn-cancelled" disabled style="background:#dc3545;color:white;">‚ùå ƒ∞ptal</button>`;
    } else if (o.source === 'external' || o.source === 'external_sync') {
      // Harici sipari≈üler i√ßin √∂zel buton
      const isFullyFulfilled = o.fulfillment_status === 'FULFILLED' || o.status === 'fulfilled';
      
      if (isFullyFulfilled) {
        // Tamamlanmƒ±≈ü harici sipari≈üler i√ßin irsaliye butonu ekle
        const hasDispatchNote = o.netsis_delivery_note_id;
        if (hasDispatchNote) {
          pickBtn = `<button class="action-btn btn-pick" disabled title="ƒ∞rsaliye olu≈üturuldu: ${hasDispatchNote}" style="background:#28a745;color:white;">üìã ƒ∞rsaliye (${hasDispatchNote})</button>`;
        } else {
          pickBtn = `<button class="action-btn btn-dispatch" data-dispatch="${o.id}" title="Netsis'te irsaliye olu≈ütur" style="background:#007bff;color:white;">üìã ƒ∞rsaliye Olu≈ütur</button>`;
        }
      } else {
        pickBtn = `<button class="action-btn btn-pick btn-external" data-external-pick="${o.id}" title="Harici sipari≈ü toplamaya ba≈üla" style="background:#28a745;color:white;">üì¶ Harici Topla</button>`;
      }
    } else if (o.pick_status === 'partial') {
      // Kƒ±smi toplandƒ± - devam et butonu
      pickBtn = `<button class="action-btn btn-pick btn-partial" data-pick="${o.pick_id}" style="background:#ffc107;color:#000;" title="Toplama i≈ülemine devam et">‚è≥ Devam</button>`;
    } else if (o.pick_status === 'active') {
      // Aktif pick var - devam et
      pickBtn = `<button class="action-btn btn-pick btn-active" data-pick="${o.pick_id}" title="Toplama i≈ülemine devam et">‚ñ∂Ô∏è Devam</button>`;
    } else {
      // Normal durum kontrol√º - kƒ±smen kar≈üƒ±lanmƒ±≈ü sipari≈üler de toplanabilir olmalƒ±
      const isFullyFulfilled = o.fulfillment_status === 'FULFILLED' || o.status === 'fulfilled';
      
      if (isFullyFulfilled) {
        // Tamamlanmƒ±≈ü sipari≈üler i√ßin irsaliye butonu
        const hasDispatchNote = o.netsis_delivery_note_id;
        if (hasDispatchNote) {
          pickBtn = `<button class="action-btn btn-pick" disabled title="ƒ∞rsaliye olu≈üturuldu: ${hasDispatchNote}" style="background:#28a745;color:white;">üìã ƒ∞rsaliye (${hasDispatchNote})</button>`;
        } else {
          pickBtn = `<button class="action-btn btn-dispatch" data-dispatch="${o.id}" title="Netsis'te irsaliye olu≈ütur" style="background:#007bff;color:white;">üìã ƒ∞rsaliye Olu≈ütur</button>`;
        }
      } else {
        // A√ßƒ±k sipari≈üler, kƒ±smen kar≈üƒ±lanmƒ±≈ü veya kar≈üƒ±lanmamƒ±≈ü sipari≈üler tolanabilir
        if (o.fulfillment_status === 'PARTIALLY_FULFILLED') {
          // Kƒ±smen kar≈üƒ±lanmƒ±≈ü sipari≈üler
          if (o.pick_id) {
            // Mevcut pick var - devam et
            pickBtn = `<button class="action-btn btn-pick btn-partial" data-pick="${o.pick_id}" style="background:#ffc107;color:#000;" title="Toplama i≈ülemine devam et">‚è≥ Devam</button>`;
          } else {
            // Pick yok - yeni pick olu≈üturup devam et (otomatik)
            pickBtn = `<button class="action-btn btn-pick btn-partial-new" data-pick="${o.id}" style="background:#ffc107;color:#000;" title="Toplama i≈ülemine devam et">‚è≥ Devam</button>`;
          }
        } else {
          // Kar≈üƒ±lanmamƒ±≈ü sipari≈üler i√ßin toplama ba≈ülat
          pickBtn = `<button class="action-btn btn-pick" data-pick="${o.id}" title="Sipari≈ü toplamaya ba≈üla">üì¶ Topla</button>`;
        }
      }
    }
    
    // Teslimat durumu bilgisini kaldƒ±rdƒ±k - artƒ±k gerekli deƒüil
    
    return `<tr>
      <td data-label="Sipari≈ü No"><strong>#${o.order_number}</strong></td>
      <td data-label="M√º≈üteri">${displayCustomerName}</td>
      <td data-label="Durum"><span class="status-badge ${statusClass}">${statusText}</span></td>
      <td data-label="Kalemler"><div class="order-items">${count} kalem<br>${itemDetails}</div></td>
      <td data-label="Tarih"><div class="order-date">${orderDate}</div></td>
      <td data-label="ƒ∞≈ülem">${pickBtn}</td>
    </tr>`;
  }).join('');
  
  // Mobile card rendering
  const mobileOrderList = document.getElementById('mobileOrderList');
  if (mobileOrderList) {
    mobileOrderList.innerHTML = sortedOrders.map(o => {
      const items = o.items || [];
      const count = items.length;
      
      let itemDetails = '';
      if (count === 0) {
        itemDetails = 'Sipari≈ü kalemleri y√ºkleniyor...';
      } else {
        itemDetails = items.map(item => {
          // √úr√ºn adƒ± - √∂nce product_name, sonra sku, sonra varsayƒ±lan
          const productName = (item.product_name || item.sku || item.product_sku || '√úr√ºn adƒ± yok');
          const displayName = productName.length > 40 
            ? productName.substring(0, 40) + '...'
            : productName;
            
          // Renk durumu - Products tablosundan gelen ger√ßek renk bilgisi - mobil i√ßin
          let colorInfo = '';
          if (item.product_color && item.product_color.trim()) {
            colorInfo = ` (${item.product_color.trim()})`;
          }
          
          // Miktar kontrol√º
          const quantity = item.quantity || item.miktar || 1;
          
          return `‚Ä¢ ${displayName}${colorInfo} x${quantity}`;
        }).slice(0, 2).join('\n') + (items.length > 2 ? '\n+ ' + (items.length - 2) + ' kalem daha...' : '');
      }
      
      const rawCustomerName = cleanCustomerName(o.customer_name);
      const displayCustomerName = rawCustomerName && rawCustomerName.length > 30 
        ? rawCustomerName.substring(0, 30) + '...'
        : rawCustomerName;
      
      // Status badge for mobile
      let statusClass, statusText;
      if (o.fulfillment_status === 'PARTIALLY_FULFILLED') {
        statusClass = 'btn-warning-mobile';
        statusText = 'Kƒ±smen Kar≈üƒ±landƒ±';
      } else if (o.fulfillment_status === 'FULFILLED') {
        statusClass = 'btn-success-mobile';
        statusText = 'Tamamlanmƒ±≈ü';
      } else {
        statusClass = 'btn-primary-mobile';
        statusText = {
          'open': 'A√ßƒ±k',
          'approved': 'Onaylanmƒ±≈ü',
          'fulfilled': 'Tamamlanmƒ±≈ü',
          'cancelled': 'ƒ∞ptal Edilmi≈ü'
        }[o.status] || o.status;
      }
      
      // Date formatting - T√ºrkiye saati
      const orderDate = new Date(o.created_at).toLocaleDateString('tr-TR', {
        day: '2-digit',
        month: '2-digit', 
        year: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      // Mobile action button
      let mobileBtn, btnClass = 'mobile-action-btn';
      if (o.category === 'cancelled') {
        btnClass += ' btn-danger-mobile';
        mobileBtn = `<button class="${btnClass}" disabled>‚ùå ƒ∞ptal Edildi</button>`;
      } else if (o.source === 'external' || o.source === 'external_sync') {
        // Harici sipari≈üler i√ßin mobil buton
        const isFullyFulfilled = o.fulfillment_status === 'FULFILLED' || o.status === 'fulfilled';
        if (isFullyFulfilled) {
          // Tamamlanmƒ±≈ü harici sipari≈üler i√ßin irsaliye butonu
          const hasDispatchNote = o.netsis_delivery_note_id;
          if (hasDispatchNote) {
            btnClass += ' btn-success-mobile';
            mobileBtn = `<button class="${btnClass}" disabled>üìã ƒ∞rsaliye (${hasDispatchNote})</button>`;
          } else {
            btnClass += ' btn-primary-mobile';
            mobileBtn = `<button class="${btnClass}" data-dispatch="${o.id}">üìã ƒ∞rsaliye Olu≈ütur</button>`;
          }
        } else {
          btnClass += ' btn-success-mobile';
          mobileBtn = `<button class="${btnClass}" data-external-pick="${o.id}">üì¶ Harici Topla</button>`;
        }
      } else if (o.pick_status === 'partial') {
        btnClass += ' btn-warning-mobile';
        mobileBtn = `<button class="${btnClass}" data-pick="${o.pick_id}">‚è≥ Devam Et</button>`;
      } else if (o.pick_status === 'active') {
        btnClass += ' btn-warning-mobile';
        mobileBtn = `<button class="${btnClass}" data-pick="${o.pick_id}">‚ñ∂Ô∏è Devam Et</button>`;
      } else {
        const isFullyFulfilled = o.fulfillment_status === 'FULFILLED' || o.status === 'fulfilled';
        if (isFullyFulfilled) {
          // Tamamlanmƒ±≈ü sipari≈üler i√ßin irsaliye butonu
          const hasDispatchNote = o.netsis_delivery_note_id;
          if (hasDispatchNote) {
            btnClass += ' btn-success-mobile';
            mobileBtn = `<button class="${btnClass}" disabled>üìã ƒ∞rsaliye (${hasDispatchNote})</button>`;
          } else {
            btnClass += ' btn-primary-mobile';
            mobileBtn = `<button class="${btnClass}" data-dispatch="${o.id}">üìã ƒ∞rsaliye Olu≈ütur</button>`;
          }
        } else {
          if (o.fulfillment_status === 'PARTIALLY_FULFILLED') {
            btnClass += ' btn-warning-mobile';
            mobileBtn = o.pick_id 
              ? `<button class="${btnClass}" data-pick="${o.pick_id}">‚è≥ Devam Et</button>`
              : `<button class="${btnClass}" data-pick="${o.id}">‚è≥ Devam Et</button>`;
          } else {
            btnClass += ' btn-primary-mobile';
            mobileBtn = `<button class="${btnClass}" data-pick="${o.id}">üì¶ Toplamaya Ba≈üla</button>`;
          }
        }
      }
      
      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-number">#${o.order_number}</div>
            <div class="order-status ${statusClass.replace('mobile', 'badge')}">${statusText}</div>
          </div>
          
          <div class="order-info">
            <div class="info-row">
              <div class="info-label">M√º≈üteri:</div>
              <div class="info-value"><strong>${displayCustomerName}</strong></div>
            </div>
            <div class="info-row">
              <div class="info-label">Tarih:</div>
              <div class="info-value">${orderDate}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Kalemler:</div>
              <div class="info-value">${count} kalem</div>
            </div>
          </div>
          
          <div class="order-items-mobile">
            ${itemDetails}
          </div>
          
          ${mobileBtn}
        </div>
      `;
    }).join('');
  }
}

// Netsis sipari≈ülerini g√∂ster
function displayNetsisOrders(orders) {
  const tbody = $('#ordTable tbody');
  const mobileContainer = $('#mobileOrderList');
  
  if (orders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666">Netsis sipari≈üi bulunamadƒ±</td></tr>';
    if (mobileContainer) mobileContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Netsis sipari≈üi bulunamadƒ±</div>';
    return;
  }
  
  // Desktop table
  tbody.innerHTML = orders.map(o => {
    const orderDate = new Date(o.sync_tarihi).toLocaleDateString('tr-TR');
    const totalAmount = parseFloat(o.toplam_tutar || 0).toFixed(2);
    
    // Cari ismi √∂ncelikli g√∂sterim - cariIsmi varsa onu, yoksa cari_kodu g√∂ster
    const customerDisplay = o.cariIsmi || o.cari_ismi || o.cari_kodu || 'N/A';
    const customerDisplayShort = customerDisplay.length > 25 
      ? customerDisplay.substring(0, 25) + '...'
      : customerDisplay;
    
    return `
      <tr>
        <td><strong>${o.siparis_no}</strong></td>
        <td>${customerDisplayShort}</td>
        <td><span class="status-badge status-new">Yeni</span></td>
        <td>-</td>
        <td>${orderDate}</td>
        <td>
          <button class="action-btn" data-netsis-id="${o.id}">
            üìã Detay
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Mobile cards
  if (mobileContainer) {
    mobileContainer.innerHTML = orders.map(o => {
      const orderDate = new Date(o.sync_tarihi).toLocaleDateString('tr-TR');
      const totalAmount = parseFloat(o.toplam_tutar || 0).toFixed(2);
      
      // Mobile i√ßin de cari ismi √∂ncelikli g√∂sterim
      const customerDisplay = o.cariIsmi || o.cari_ismi || o.cari_kodu || 'N/A';
      const customerDisplayMobile = customerDisplay.length > 30 
        ? customerDisplay.substring(0, 30) + '...'
        : customerDisplay;
      
      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-number">#${o.siparis_no}</div>
            <div class="order-status status-new">Yeni</div>
          </div>
          
          <div class="order-info">
            <div class="info-row">
              <div class="info-label">M√º≈üteri:</div>
              <div class="info-value"><strong>${customerDisplayMobile}</strong></div>
            </div>
            <div class="info-row">
              <div class="info-label">Tarih:</div>
              <div class="info-value">${orderDate}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Tutar:</div>
              <div class="info-value">${totalAmount} ‚Ç∫</div>
            </div>
            <div class="info-row">
              <div class="info-label">Satƒ±r Sayƒ±sƒ±:</div>
              <div class="info-value">${o.line_count || 0} kalem</div>
            </div>
          </div>
          
          <button class="mobile-action-btn btn-primary-mobile" data-netsis-id="${o.id}">
            üìã Detaylarƒ± G√∂r√ºnt√ºle
          </button>
        </div>
      `;
    }).join('');
  }
}

// Harici sipari≈üleri g√∂ster
function displayExternalOrders(orders) {
  const tbody = $('#ordTable tbody');
  const mobileContainer = $('#mobileOrderList');
  
  if (orders.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#666">Harici sipari≈ü bulunamadƒ±</td></tr>';
    if (mobileContainer) mobileContainer.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Harici sipari≈ü bulunamadƒ±</div>';
    return;
  }
  
  // Desktop table
  tbody.innerHTML = orders.map(o => {
    const orderDate = new Date(o.order_date).toLocaleDateString('tr-TR');
    const totalAmount = parseFloat(o.total_amount || 0).toFixed(2);
    const itemCount = o.items ? o.items.length : 0;
    const itemDetails = o.items ? o.items.slice(0, 3).map(item => 
      `‚Ä¢ ${item.stokKodu} x${item.miktar}`
    ).join('<br>') + (o.items.length > 3 ? '<br>...' : '') : 'Kalem yok';
    
    // Harici sipari≈üler i√ßin de cari ismi √∂ncelikli g√∂sterim
    const customerDisplay = o.customer_name || o.cariIsmi || o.cari_ismi || o.customer_code || 'N/A';
    const customerDisplayShort = customerDisplay.length > 25 
      ? customerDisplay.substring(0, 25) + '...'
      : customerDisplay;
    
    return `
      <tr>
        <td><strong>#${o.order_number}</strong></td>
        <td>${customerDisplayShort}</td>
        <td><span class="status-badge status-open">Harici</span></td>
        <td><div class="order-items">${itemCount} kalem<br>${itemDetails}</div></td>
        <td>${orderDate}</td>
        <td>
          <button class="action-btn" data-external-id="${o.id}">
            üìã Detay
          </button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Mobile cards
  if (mobileContainer) {
    mobileContainer.innerHTML = orders.map(o => {
      const orderDate = new Date(o.order_date).toLocaleDateString('tr-TR');
      const totalAmount = parseFloat(o.total_amount || 0).toFixed(2);
      const itemCount = o.items ? o.items.length : 0;
      
      // Mobile harici sipari≈üler i√ßin de cari ismi √∂ncelikli g√∂sterim
      const customerDisplay = o.customer_name || o.cariIsmi || o.cari_ismi || o.customer_code || 'N/A';
      const customerDisplayMobile = customerDisplay.length > 30 
        ? customerDisplay.substring(0, 30) + '...'
        : customerDisplay;
      
      return `
        <div class="order-card">
          <div class="order-header">
            <div class="order-number">#${o.order_number}</div>
            <div class="order-status status-open">Harici</div>
          </div>
          
          <div class="order-info">
            <div class="info-row">
              <div class="info-label">M√º≈üteri:</div>
              <div class="info-value"><strong>${customerDisplayMobile}</strong></div>
            </div>
            <div class="info-row">
              <div class="info-label">Tarih:</div>
              <div class="info-value">${orderDate}</div>
            </div>
            <div class="info-row">
              <div class="info-label">Tutar:</div>
              <div class="info-value">${totalAmount} ‚Ç∫</div>
            </div>
            <div class="info-row">
              <div class="info-label">Kalemler:</div>
              <div class="info-value">${itemCount} kalem</div>
            </div>
          </div>
          
          <button class="mobile-action-btn btn-primary-mobile" data-external-id="${o.id}">
            üìã Detaylarƒ± G√∂r√ºnt√ºle
          </button>
        </div>
      `;
    }).join('');
  }
}

// Event listeners
document.body.addEventListener('click', async (e) => {
  
  // Sekme deƒüi≈ütirme
  if (e.target.classList.contains('tab-btn')) {
    $$('.tab-btn').forEach(btn => btn.classList.remove('active'));
    e.target.classList.add('active');
    currentTab = e.target.dataset.tab;
    filterAndDisplayOrders();
  }
  
  
  // ƒ∞rsaliye olu≈üturma
  const dispatchValue = e.target.getAttribute('data-dispatch');
  if (dispatchValue) {
    e.target.disabled = true;
    const originalText = e.target.textContent;
    e.target.textContent = 'ƒ∞rsaliye olu≈üturuluyor...';
    
    try {
      console.log('Creating dispatch note for order:', dispatchValue);
      
      const response = await fetch(`/api/orders/${dispatchValue}/convert-to-dispatch`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (result.success) {
        alert(`ƒ∞rsaliye ba≈üarƒ±yla olu≈üturuldu!\n\nSipari≈ü No: ${result.order_number}\nƒ∞rsaliye ID: ${result.delivery_note_id}`);
        // Sayfayƒ± yenile
        await loadOrders();
      } else {
        alert(`ƒ∞rsaliye olu≈üturulamadƒ±:\n${result.error}\n${result.message || ''}`);
      }
    } catch (error) {
      console.error('Dispatch note creation error:', error);
      alert('ƒ∞rsaliye olu≈üturma hatasƒ±: ' + error.message);
    } finally {
      e.target.disabled = false;
      e.target.textContent = originalText;
    }
  }
  
  // Toplama ba≈ülatma
  const pickValue = e.target.getAttribute('data-pick');
  if (pickValue) {
    e.target.disabled = true;
    const originalText = e.target.textContent;
    e.target.textContent = 'Y√ºkleniyor...';
    
    try {
      // Eƒüer buton partial, active ya da partial-new ise
      if (e.target.classList.contains('btn-partial')) {
        // Mevcut pick ID var - direkt devam et
        console.log('Continuing existing pick:', pickValue);
        location.href = '/pick.html?pick=' + pickValue;
      } else if (e.target.classList.contains('btn-active')) {
        // Aktif pick var - direkt devam et
        console.log('Continuing active pick:', pickValue);
        location.href = '/pick.html?pick=' + pickValue;
      } else if (e.target.classList.contains('btn-partial-new')) {
        // Kƒ±smen kar≈üƒ±lanmƒ±≈ü ama pick yok - yeni pick olu≈ütur
        console.log('Creating new pick for partially fulfilled order:', pickValue);
        const r = await API.createPick(parseInt(pickValue, 10));
        if (r.error) { 
          alert('Pick olu≈üturma hatasƒ±: ' + r.error); 
        } else { 
          console.log('Pick olu≈üturuldu:', r);
          location.href = '/pick.html?pick=' + r.id; 
        }
      } else {
        // Yeni pick olu≈ütur
        const r = await API.createPick(parseInt(pickValue, 10));
        if (r.error) { 
          alert('Pick olu≈üturma hatasƒ±: ' + r.error); 
        } else { 
          console.log('Pick olu≈üturuldu:', r);
          location.href = '/pick.html?pick=' + r.id; 
        }
      }
    } finally {
      e.target.disabled = false;
      e.target.textContent = originalText;
    }
  }
  
  // External pick ba≈ülatma (Harici Topla butonu)
  const externalPickValue = e.target.getAttribute('data-external-pick');
  if (externalPickValue) {
    console.log('Starting external pick for order:', externalPickValue);
    // Direkt pick sayfasƒ±na y√∂nlendir - external pick i√ßin √∂zel parametre
    location.href = '/pick.html?external=' + externalPickValue;
  }
});

// Arama input
$('#searchInput').addEventListener('input', (e) => {
  searchTerm = e.target.value;
  filterAndDisplayOrders();
});

// Durum filtresi
$('#statusFilter').addEventListener('change', (e) => {
  statusFilter = e.target.value;
  filterAndDisplayOrders();
});

// External API sync fonksiyonu
async function syncExternalOrders() {
  try {
    console.log('üîÑ Checking external API for new orders...');
    const response = await fetch('/api/sync/external-orders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      const result = await response.json();
      if (result.imported > 0) {
        console.log(`‚úÖ ${result.imported} new orders imported from external API`);
        // Yeni sipari≈üler varsa liste yenile
        await loadOrders();
        
        // Bildirim g√∂ster
        const syncBadge = document.getElementById('syncOrdersOut');
        if (syncBadge) {
          syncBadge.textContent = `${result.imported} yeni sipari≈ü`;
          syncBadge.style.background = '#28a745';
          syncBadge.style.color = 'white';
          syncBadge.style.padding = '4px 8px';
          syncBadge.style.borderRadius = '12px';
          syncBadge.style.fontSize = '12px';
          
          // 5 saniye sonra bildirim kaybolsun
          setTimeout(() => {
            syncBadge.textContent = '';
            syncBadge.style.background = '';
            syncBadge.style.color = '';
            syncBadge.style.padding = '';
            syncBadge.style.borderRadius = '';
          }, 5000);
        }
      } else {
        console.log('‚ÑπÔ∏è No new orders found in external API');
      }
    }
  } catch (error) {
    console.error('External sync error:', error);
  }
}

// Load orders
await loadOrders();

// External API'den yeni sipari≈üleri kontrol et - sayfa y√ºklendiƒüinde
await syncExternalOrders();

// Check for refresh flag from URL parameters
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('refresh') === 'true') {
  console.log('üîÑ Refresh flag detected - force reloading orders...');
  // Remove refresh parameter from URL
  const newUrl = window.location.pathname;
  window.history.replaceState({}, document.title, newUrl);
  
  // Force reload orders after a short delay to ensure any backend processing is complete
  setTimeout(() => {
    console.log('üîÑ Force reloading orders after completion...');
    loadOrders();
  }, 1000);
}

// Otomatik yenileme - her 30 saniyede bir (WMS sipari≈üleri + External sync)
setInterval(async () => {
  console.log('üîÑ Auto-refreshing orders and checking external API...');
  await syncExternalOrders(); // √ñnce external API kontrol et
  await loadOrders(); // Sonra WMS sipari≈ülerini yenile
}, 30000);

// Sayfa odaklandƒ±ƒüƒ±nda yenile (hem WMS hem external)
document.addEventListener('visibilitychange', async () => {
  if (!document.hidden) {
    console.log('üëÅÔ∏è Page became visible - refreshing orders and checking external API');
    await syncExternalOrders();
    await loadOrders();
  }
});
</script>
</body>
</html>