<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <style>
    /* Netsis Connection Styles */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .status-indicator {
      font-size: 16px;
      font-weight: bold;
    }
    
    .status-indicator.online {
      color: #28a745;
    }
    
    .status-indicator.offline {
      color: #dc3545;
    }
    
    .test-result {
      margin-top: 12px;
      padding: 12px;
      border-radius: 6px;
      font-weight: 500;
    }
    
    .test-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .test-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .test-result.hidden {
      display: none;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .btn-primary, .btn-success {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #007bff;
      color: white;
    }
    
    .btn-primary:hover {
      background: #0056b3;
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      opacity: 0.9;
    }
    
    .btn-primary:disabled, .btn-success:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
  <script src="/assets/js/auth-new.js"></script>
</head>
<body>
<header>
  <div class="header-brand">
    <a href="/index.html" class="home-link">
      <h1>WMS YÃ¶netim Sistemi</h1>
    </a>
    <span class="header-subtitle">Admin Panel - KullanÄ±cÄ± YÃ¶netimi</span>
  </div>
  <div class="header-actions">
    <a href="/index.html" class="btn-home">
      <span class="btn-icon">ğŸ </span>
      <span class="btn-text">Ana Sayfa</span>
    </a>
  </div>
</header>

<main class="container">
  <!-- Admin Sekmeler -->
  <section class="tabs-container">
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('users')">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</button>
      <button class="tab-btn" onclick="switchTab('permissions')">ğŸ” Rol Ä°zinleri</button>
      <button class="tab-btn" onclick="switchTab('system')">ğŸ–¥ï¸ Sistem Bilgileri</button>
    </div>
  </section>

  <!-- KullanÄ±cÄ± YÃ¶netimi Tab -->
  <div id="usersTab" class="tab-content active">
  <!-- KullanÄ±cÄ± Ä°statistikleri -->
  <section class="stats-grid">
    <div class="stat-card">
      <h3>Toplam KullanÄ±cÄ±</h3>
      <div class="stat-number" id="totalUsers">-</div>
      <div class="stat-label">KullanÄ±cÄ±</div>
    </div>
    <div class="stat-card">
      <h3>Aktif KullanÄ±cÄ±lar</h3>
      <div class="stat-number" id="activeUsers">-</div>
      <div class="stat-label">Aktif</div>
    </div>
    <div class="stat-card">
      <h3>YÃ¶neticiler</h3>
      <div class="stat-number" id="adminUsers">-</div>
      <div class="stat-label">Admin</div>
    </div>
    <div class="stat-card">
      <h3>Son GiriÅŸ</h3>
      <div class="stat-number" id="recentLogins">-</div>
      <div class="stat-label">24 Saat</div>
    </div>
  </section>

  <!-- Netsis BaÄŸlantÄ± AyarlarÄ± -->
  <section class="card">
    <h2>ğŸ”— Netsis API BaÄŸlantÄ± AyarlarÄ±</h2>
    <div class="connection-status" id="netsisStatus">
      <span class="status-indicator offline">â—</span>
      <span class="status-text">BaÄŸlantÄ± durumu kontrol ediliyor...</span>
    </div>
    
    <div class="form-grid">
      <div class="form-group">
        <label for="netsisUrl">Netsis API URL</label>
        <input type="text" id="netsisUrl" placeholder="http://IP:PORT" />
        <small>Ã–rnek: http://192.168.1.100:7070 veya https://netsis.domain.com:7070</small>
      </div>
      <div class="form-group">
        <label for="netsisUsername">Netsis KullanÄ±cÄ±</label>
        <input type="text" id="netsisUsername" placeholder="NETSIS" />
      </div>
      <div class="form-group">
        <label for="netsisPassword">Netsis Åifre</label>
        <input type="password" id="netsisPassword" placeholder="***" />
      </div>
      <div class="form-group">
        <label for="netsisDbName">VeritabanÄ± AdÄ±</label>
        <input type="text" id="netsisDbName" placeholder="DBNAME" />
      </div>
    </div>
    
    <div class="form-actions">
      <button type="button" id="testNetsisConnection" class="btn-primary">
        ğŸ§ª BaÄŸlantÄ±yÄ± Test Et
      </button>
      <button type="button" id="saveNetsisConfig" class="btn-success">
        ğŸ’¾ AyarlarÄ± Kaydet
      </button>
      <button type="button" id="testNetsisOrders" class="btn-warning">
        ğŸ“‹ SipariÅŸ Verilerini Test Et
      </button>
    </div>
    
    <div id="netsisTestResult" class="test-result hidden"></div>
  </section>

  <!-- KullanÄ±cÄ± OluÅŸturma -->
  <section class="card">
    <h2>ğŸ†• Yeni KullanÄ±cÄ± Ekle</h2>
    <form id="createUserForm" class="user-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="newUsername">KullanÄ±cÄ± AdÄ±</label>
          <input type="text" id="newUsername" required placeholder="KullanÄ±cÄ± adÄ±" />
        </div>
        <div class="form-group">
          <label for="newPassword">Åifre</label>
          <input type="password" id="newPassword" required placeholder="Åifre" />
        </div>
        <div class="form-group">
          <label for="newRole">Rol</label>
          <select id="newRole" required>
            <option value="">Rol SeÃ§in</option>
            <option value="admin">YÃ¶netici</option>
            <option value="operator">OperatÃ¶r</option>
            <option value="service">Servis Teknisyeni</option>
          </select>
        </div>
        <div class="form-group">
          <label for="newFullName">Ad Soyad</label>
          <input type="text" id="newFullName" placeholder="Ad Soyad" />
        </div>
        <div class="form-group">
          <label for="newEmail">E-posta</label>
          <input type="email" id="newEmail" placeholder="E-posta adresi" />
        </div>
        <div class="form-group">
          <button type="submit" class="btn-primary">KullanÄ±cÄ± Ekle</button>
        </div>
      </div>
    </form>
  </section>

  <!-- KullanÄ±cÄ± Listesi -->
  <section class="card">
    <div class="card-header">
      <h2>ğŸ‘¥ KullanÄ±cÄ± Listesi</h2>
      <button id="refreshUsers" class="btn-secondary">
        <span class="btn-icon">ğŸ”„</span>
        Yenile
      </button>
    </div>
    
    <div class="table-container">
      <table id="usersTable" class="data-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>KullanÄ±cÄ± AdÄ±</th>
            <th>Ad Soyad</th>
            <th>Rol</th>
            <th>E-posta</th>
            <th>Durum</th>
            <th>OluÅŸturma</th>
            <th>Son GiriÅŸ</th>
            <th>Ä°ÅŸlemler</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr>
            <td colspan="9" class="loading">YÃ¼kleniyor...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
  </div>

  <!-- Rol Ä°zinleri Tab -->
  <div id="permissionsTab" class="tab-content">
    <section class="card">
      <h2>ğŸ” Rol Ä°zinleri HÄ±zlÄ± GÃ¶rÃ¼nÃ¼m</h2>
      <div class="permissions-overview" id="permissionsOverview">
        <div class="loading">YÃ¼kleniyor...</div>
      </div>
      <div class="permissions-actions">
        <a href="/role-management.html" class="btn-primary">
          <span class="btn-icon">âš™ï¸</span>
          DetaylÄ± Rol YÃ¶netimi
        </a>
      </div>
    </section>

    <section class="card">
      <h2>ğŸ“Š Ä°zin Ä°statistikleri</h2>
      <div class="permission-stats" id="permissionStats">
        <div class="loading">YÃ¼kleniyor...</div>
      </div>
    </section>
  </div>

  <!-- Sistem Bilgileri Tab -->
  <div id="systemTab" class="tab-content">
    <section class="card">
      <h2>ğŸ–¥ï¸ Sistem Bilgileri</h2>
      <div class="system-info">
        <div class="info-grid">
          <div class="info-item">
            <strong>Server Durumu:</strong>
            <span id="serverStatus" class="status-badge">-</span>
          </div>
          <div class="info-item">
            <strong>Database:</strong>
            <span id="dbStatus" class="status-badge">-</span>
          </div>
          <div class="info-item">
            <strong>Session Store:</strong>
            <span id="sessionStatus" class="status-badge">-</span>
          </div>
          <div class="info-item">
            <strong>Uptime:</strong>
            <span id="uptime">-</span>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<style>
/* Tabs */
.tabs-container {
  margin-bottom: 24px;
}

.tabs {
  display: flex;
  gap: 4px;
  border-bottom: 2px solid var(--border);
  margin-bottom: 24px;
}

.tab-btn {
  background: transparent;
  border: none;
  padding: 12px 20px;
  color: var(--muted);
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px 8px 0 0;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.tab-btn:hover {
  background: var(--hover);
  color: var(--fg);
}

.tab-btn.active {
  background: var(--card);
  color: var(--accent);
  border: 1px solid var(--border);
  border-bottom: none;
  margin-bottom: -2px;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.permissions-overview {
  margin-bottom: 20px;
}

.permissions-actions {
  display: flex;
  justify-content: center;
  padding: 20px 0;
}

.permissions-grid-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}

.role-overview-card {
  background: var(--hover);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
}

.role-overview-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.role-overview-title {
  font-weight: 600;
  color: var(--fg);
  font-size: 16px;
}

.permission-count-badge {
  background: var(--accent);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.permission-tags-overview {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.permission-tag-overview {
  background: var(--border);
  color: var(--muted);
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 500;
}

.permission-tag-overview.enabled {
  background: var(--success);
  color: white;
}

.permission-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.stat-item {
  background: var(--hover);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
}

.stat-item-value {
  font-size: 24px;
  font-weight: 600;
  color: var(--accent);
  margin-bottom: 4px;
}

.stat-item-label {
  color: var(--muted);
  font-size: 14px;
}

.user-form {
  margin-bottom: 20px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  align-items: end;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  margin-bottom: 4px;
  font-weight: 500;
  color: var(--fg);
  font-size: 14px;
}

.form-group input, .form-group select {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--card);
  color: var(--fg);
  font-size: 14px;
}

.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(77, 163, 255, 0.2);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.btn-secondary {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--hover);
  color: var(--fg);
  border: 1px solid var(--border);
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s ease;
}

.btn-secondary:hover {
  background: var(--border);
}

.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.status-active {
  background: var(--success);
  color: white;
}

.status-inactive {
  background: var(--danger);
  color: white;
}

.system-info {
  margin-top: 16px;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.info-item {
  padding: 12px;
  background: var(--hover);
  border-radius: 8px;
  border: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.role-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
  text-transform: uppercase;
}

.role-admin { background: #dc2626; color: white; }
.role-operator { background: #0ea5e9; color: white; }
.role-service { background: #059669; color: white; }

.action-btn {
  padding: 4px 8px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  margin: 0 2px;
}

.btn-deactivate {
  background: var(--warning);
  color: white;
}

.btn-activate {
  background: var(--success);
  color: white;
}

.btn-delete {
  background: var(--danger);
  color: white;
}

/* Header navigation styles */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 2rem;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}

.home-link {
  text-decoration: none;
  color: inherit;
  transition: opacity 0.2s ease;
}

.home-link:hover {
  opacity: 0.8;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn-home {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: var(--accent);
  color: white;
  text-decoration: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.btn-home:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

.btn-home .btn-icon {
  font-size: 16px;
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .info-grid {
    grid-template-columns: 1fr;
  }
  
  header {
    padding: 1rem;
    flex-direction: column;
    gap: 12px;
  }
  
  .btn-home .btn-text {
    display: none;
  }
}
</style>

<script>
const API = {
  users: () => fetch('/api/users', { credentials: 'include' }).then(r => r.json()),
  createUser: (userData) => fetch('/api/users', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    credentials: 'include',
    body: JSON.stringify(userData)
  }).then(r => r.json()),
  health: () => fetch('/api/health').then(r => r.json()),
  rolePermissions: () => fetch('/api/role-permissions', { credentials: 'include' }).then(r => r.json()),
  permissionTypes: () => fetch('/api/permission-types', { credentials: 'include' }).then(r => r.json())
};

// Tab switching
function switchTab(tabName) {
  // Remove active class from all tabs and buttons
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // Add active class to selected tab and button
  document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`${tabName}Tab`).classList.add('active');
  
  // Load tab-specific content
  if (tabName === 'permissions') {
    loadPermissionsOverview();
  } else if (tabName === 'system') {
    loadSystemStatus();
  }
}

// KullanÄ±cÄ±larÄ± yÃ¼kle
async function loadUsers() {
  try {
    const users = await API.users();
    
    // Ä°statistikleri gÃ¼ncelle
    document.getElementById('totalUsers').textContent = users.length;
    document.getElementById('activeUsers').textContent = users.filter(u => u.active).length;
    document.getElementById('adminUsers').textContent = users.filter(u => u.role === 'admin').length;
    
    // Son 24 saatteki giriÅŸleri say
    const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
    const recentLogins = users.filter(u => 
      u.last_login && new Date(u.last_login) > oneDayAgo
    ).length;
    document.getElementById('recentLogins').textContent = recentLogins;
    
    // Tabloyu doldur
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = users.map(user => `
      <tr>
        <td>${user.id}</td>
        <td><strong>${user.username}</strong></td>
        <td>${user.full_name || '-'}</td>
        <td><span class="role-badge role-${user.role}">${getRoleDisplayName(user.role)}</span></td>
        <td>${user.email || '-'}</td>
        <td>
          <span class="status-badge ${user.active ? 'status-active' : 'status-inactive'}">
            ${user.active ? 'Aktif' : 'Pasif'}
          </span>
        </td>
        <td>${formatDate(user.created_at)}</td>
        <td>${user.last_login ? formatDate(user.last_login) : 'HiÃ§'}</td>
        <td>
          <button class="action-btn ${user.active ? 'btn-deactivate' : 'btn-activate'}" 
                  onclick="toggleUserStatus(${user.id}, ${user.active})">
            ${user.active ? 'PasifleÅŸtir' : 'AktifleÅŸtir'}
          </button>
          ${user.username !== 'admin' ? `
            <button class="action-btn btn-delete" onclick="deleteUser(${user.id}, '${user.username}')">
              Sil
            </button>
          ` : ''}
        </td>
      </tr>
    `).join('');
    
  } catch (error) {
    console.error('Users load error:', error);
    document.getElementById('usersTableBody').innerHTML = `
      <tr><td colspan="9" class="error">KullanÄ±cÄ±lar yÃ¼klenemedi: ${error.message}</td></tr>
    `;
  }
}

// Ä°zin Ã¶zetini yÃ¼kle
async function loadPermissionsOverview() {
  try {
    const [permissionsResult, typesResult] = await Promise.all([
      API.rolePermissions(),
      API.permissionTypes()
    ]);
    
    if (permissionsResult.success && typesResult.success) {
      displayPermissionsOverview(permissionsResult.permissions, typesResult.permissionTypes);
      displayPermissionStats(permissionsResult.permissions, typesResult.permissionTypes);
    }
  } catch (error) {
    console.error('Permissions overview load error:', error);
    document.getElementById('permissionsOverview').innerHTML = 
      '<div class="error">Ä°zin Ã¶zeti yÃ¼klenemedi</div>';
  }
}

// Ä°zin Ã¶zetini gÃ¶ster
function displayPermissionsOverview(allPermissions, permissionTypes) {
  const overviewDiv = document.getElementById('permissionsOverview');
  
  const roles = Object.keys(allPermissions);
  
  overviewDiv.innerHTML = `
    <div class="permissions-grid-overview">
      ${roles.map(role => {
        const permissions = allPermissions[role];
        const enabledCount = Object.values(permissions).filter(Boolean).length;
        
        return `
          <div class="role-overview-card">
            <div class="role-overview-header">
              <span class="role-overview-title">${getRoleDisplayName(role)}</span>
              <span class="permission-count-badge">${enabledCount}</span>
            </div>
            <div class="permission-tags-overview">
              ${Object.entries(permissions).map(([permission, enabled]) => `
                <span class="permission-tag-overview ${enabled ? 'enabled' : ''}">${permission}</span>
              `).join('')}
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// Ä°zin istatistiklerini gÃ¶ster
function displayPermissionStats(allPermissions, permissionTypes) {
  const statsDiv = document.getElementById('permissionStats');
  
  const roles = Object.keys(allPermissions);
  const totalPermissions = new Set();
  const roleStats = {};
  
  // Ä°statistikleri hesapla
  roles.forEach(role => {
    const permissions = allPermissions[role];
    const enabledPermissions = Object.entries(permissions).filter(([key, enabled]) => enabled);
    
    roleStats[role] = {
      total: Object.keys(permissions).length,
      enabled: enabledPermissions.length,
      disabled: Object.keys(permissions).length - enabledPermissions.length
    };
    
    Object.keys(permissions).forEach(perm => totalPermissions.add(perm));
  });
  
  const totalUniquePermissions = totalPermissions.size;
  const totalEnabledAcrossRoles = roles.reduce((sum, role) => 
    sum + roleStats[role].enabled, 0);
  
  statsDiv.innerHTML = `
    <div class="permission-stats-grid">
      <div class="stat-item">
        <div class="stat-item-value">${totalUniquePermissions}</div>
        <div class="stat-item-label">Toplam Ä°zin TÃ¼rÃ¼</div>
      </div>
      <div class="stat-item">
        <div class="stat-item-value">${totalEnabledAcrossRoles}</div>
        <div class="stat-item-label">Aktif Ä°zin SayÄ±sÄ±</div>
      </div>
      <div class="stat-item">
        <div class="stat-item-value">${roles.length}</div>
        <div class="stat-item-label">Toplam Rol</div>
      </div>
      <div class="stat-item">
        <div class="stat-item-value">${Math.round((totalEnabledAcrossRoles / (roles.length * totalUniquePermissions)) * 100)}%</div>
        <div class="stat-item-label">Ä°zin KullanÄ±m OranÄ±</div>
      </div>
    </div>
  `;
}

// Sistem durumunu yÃ¼kle
async function loadSystemStatus() {
  try {
    const health = await API.health();
    document.getElementById('serverStatus').textContent = health.status === 'ok' ? 'âœ… Ã‡alÄ±ÅŸÄ±yor' : 'âŒ Hata';
    document.getElementById('dbStatus').textContent = 'âœ… BaÄŸlÄ±';
    document.getElementById('sessionStatus').textContent = 'âœ… Aktif';
    document.getElementById('uptime').textContent = '< 24 saat';
  } catch (error) {
    document.getElementById('serverStatus').textContent = 'âŒ EriÅŸilemez';
  }
}

// Yeni kullanÄ±cÄ± oluÅŸtur
document.getElementById('createUserForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const userData = {
    username: document.getElementById('newUsername').value.trim(),
    password: document.getElementById('newPassword').value,
    role: document.getElementById('newRole').value,
    full_name: document.getElementById('newFullName').value.trim(),
    email: document.getElementById('newEmail').value.trim()
  };
  
  if (!userData.username || !userData.password || !userData.role) {
    alert('KullanÄ±cÄ± adÄ±, ÅŸifre ve rol alanlarÄ± zorunludur.');
    return;
  }
  
  try {
    const result = await API.createUser(userData);
    
    if (result.success) {
      alert('KullanÄ±cÄ± baÅŸarÄ±yla oluÅŸturuldu!');
      document.getElementById('createUserForm').reset();
      await loadUsers();
    } else {
      alert(`Hata: ${result.message}`);
    }
  } catch (error) {
    alert(`KullanÄ±cÄ± oluÅŸturma hatasÄ±: ${error.message}`);
  }
});

// KullanÄ±cÄ± durumu deÄŸiÅŸtir
async function toggleUserStatus(userId, currentStatus) {
  // Bu Ã¶zellik henÃ¼z backend'de yok, gelecekte eklenebilir
  alert('Bu Ã¶zellik yakÄ±nda eklenecek.');
}

// KullanÄ±cÄ± sil
async function deleteUser(userId, username) {
  if (confirm(`${username} kullanÄ±cÄ±sÄ±nÄ± silmek istediÄŸinizden emin misiniz?`)) {
    // Bu Ã¶zellik henÃ¼z backend'de yok, gelecekte eklenebilir
    alert('Bu Ã¶zellik yakÄ±nda eklenecek.');
  }
}

// Yenile butonu
document.getElementById('refreshUsers').addEventListener('click', loadUsers);

// Netsis Configuration Functions
async function loadNetsisConfig() {
  try {
    const response = await fetch('/api/netsis/config');
    if (response.ok) {
      const config = await response.json();
      document.getElementById('netsisUrl').value = config.url || '';
      document.getElementById('netsisUsername').value = config.username || '';
      document.getElementById('netsisDbName').value = config.dbName || '';
      
      // Test connection on load
      testNetsisConnection();
    }
  } catch (error) {
    console.error('Netsis config yÃ¼klenemedi:', error);
  }
}

async function testNetsisConnection() {
  const testBtn = document.getElementById('testNetsisConnection');
  const resultDiv = document.getElementById('netsisTestResult');
  const statusDiv = document.getElementById('netsisStatus');
  
  testBtn.disabled = true;
  testBtn.textContent = 'ğŸ”„ Test ediliyor...';
  
  try {
    const response = await fetch('/api/netsis/test-connection', { method: 'POST' });
    const result = await response.json();
    
    resultDiv.className = 'test-result ' + (result.success ? 'success' : 'error');
    resultDiv.textContent = result.message || result.error;
    resultDiv.classList.remove('hidden');
    
    // Update status indicator
    const indicator = statusDiv.querySelector('.status-indicator');
    const text = statusDiv.querySelector('.status-text');
    
    if (result.success) {
      indicator.className = 'status-indicator online';
      text.textContent = 'âœ… Netsis baÄŸlantÄ±sÄ± aktif';
    } else {
      indicator.className = 'status-indicator offline';  
      text.textContent = 'âŒ Netsis baÄŸlantÄ±sÄ± kapalÄ±';
    }
    
  } catch (error) {
    resultDiv.className = 'test-result error';
    resultDiv.textContent = 'BaÄŸlantÄ± testi baÅŸarÄ±sÄ±z: ' + error.message;
    resultDiv.classList.remove('hidden');
  } finally {
    testBtn.disabled = false;
    testBtn.textContent = 'ğŸ§ª BaÄŸlantÄ±yÄ± Test Et';
  }
}

async function saveNetsisConfig() {
  const saveBtn = document.getElementById('saveNetsisConfig');
  const resultDiv = document.getElementById('netsisTestResult');
  
  const config = {
    url: document.getElementById('netsisUrl').value.trim(),
    username: document.getElementById('netsisUsername').value.trim(),
    password: document.getElementById('netsisPassword').value,
    dbName: document.getElementById('netsisDbName').value.trim()
  };
  
  if (!config.url || !config.username || !config.dbName) {
    alert('URL, kullanÄ±cÄ± adÄ± ve veritabanÄ± adÄ± gerekli!');
    return;
  }
  
  saveBtn.disabled = true;
  saveBtn.textContent = 'ğŸ’¾ Kaydediliyor...';
  
  try {
    const response = await fetch('/api/netsis/config', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(config)
    });
    
    const result = await response.json();
    
    if (response.ok) {
      resultDiv.className = 'test-result success';
      resultDiv.textContent = 'âœ… Ayarlar kaydedildi! BaÄŸlantÄ± test ediliyor...';
      resultDiv.classList.remove('hidden');
      
      // Clear password field after save
      document.getElementById('netsisPassword').value = '';
      
      // Auto test connection
      setTimeout(testNetsisConnection, 1000);
    } else {
      resultDiv.className = 'test-result error';
      resultDiv.textContent = 'âŒ ' + result.error;
      resultDiv.classList.remove('hidden');
    }
    
  } catch (error) {
    resultDiv.className = 'test-result error';
    resultDiv.textContent = 'Kaydetme baÅŸarÄ±sÄ±z: ' + error.message;
    resultDiv.classList.remove('hidden');
  } finally {
    saveBtn.disabled = false;
    saveBtn.textContent = 'ğŸ’¾ AyarlarÄ± Kaydet';
  }
}

// Test Netsis Orders
async function testNetsisOrders() {
  const testBtn = document.getElementById('testNetsisOrders');
  const resultDiv = document.getElementById('netsisTestResult');
  
  testBtn.disabled = true;
  testBtn.textContent = 'ğŸ”„ Test ediliyor...';
  
  try {
    const response = await fetch('/api/netsis/orders?limit=5');
    const result = await response.json();
    
    if (response.ok && result) {
      resultDiv.className = 'test-result success';
      const orderCount = result.Data ? result.Data.length : (Array.isArray(result) ? result.length : 0);
      resultDiv.innerHTML = `
        <strong>âœ… Netsis sipariÅŸleri baÅŸarÄ±yla alÄ±ndÄ±!</strong><br>
        Bulunan sipariÅŸ sayÄ±sÄ±: ${orderCount}<br>
        <details style="margin-top: 8px;">
          <summary>Ã–rnek Veri (JSON)</summary>
          <pre style="background: #f5f5f5; padding: 8px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 11px;">${JSON.stringify(result, null, 2)}</pre>
        </details>
      `;
      resultDiv.classList.remove('hidden');
    } else {
      resultDiv.className = 'test-result error';
      resultDiv.textContent = 'âŒ ' + (result.error || result.details || 'Bilinmeyen hata');
      resultDiv.classList.remove('hidden');
    }
  } catch (error) {
    resultDiv.className = 'test-result error';
    resultDiv.textContent = 'âŒ ' + error.message;
    resultDiv.classList.remove('hidden');
  } finally {
    testBtn.disabled = false;
    testBtn.textContent = 'ğŸ“‹ SipariÅŸ Verilerini Test Et';
  }
}

// Netsis event listeners
document.getElementById('testNetsisConnection').addEventListener('click', testNetsisConnection);
document.getElementById('saveNetsisConfig').addEventListener('click', saveNetsisConfig);
document.getElementById('testNetsisOrders').addEventListener('click', testNetsisOrders);

// Utility functions
function getRoleDisplayName(role) {
  const roleNames = {
    admin: 'YÃ¶netici',
    operator: 'OperatÃ¶r',
    service: 'Servis Teknisyeni'
  };
  return roleNames[role] || role;
}

function formatDate(dateString) {
  if (!dateString) return '-';
  const date = new Date(dateString);
  return date.toLocaleDateString('tr-TR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', async () => {
  // Auth kontrolÃ¼ zaten auth.js tarafÄ±ndan yapÄ±lacak
  // Sadece admin rolÃ¼ne sahip kullanÄ±cÄ±lar bu sayfayÄ± gÃ¶rebilir
  await loadUsers();
  await loadSystemStatus();
  await loadNetsisConfig();
});
</script>
</body>
</html>