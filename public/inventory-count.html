<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0" />
  <title>Depo SayÄ±m</title>
  <link rel="stylesheet" href="/assets/css/styles.css" />
  <link rel="stylesheet" href="/assets/css/zebra-terminal.css" />
</head>
<body>
<header>
  <div class="header-brand">
    <h1>WMS YÃ¶netim Sistemi</h1>
    <span class="header-subtitle">Depo SayÄ±m</span>
  </div>
  <div class="header-actions">
    <a href="/index.html" class="home-btn">
      <span class="home-icon">ğŸ </span>
      <span class="home-text">Ana Sayfa</span>
    </a>
  </div>
</header>

<main class="inventory-count">
  <!-- SayÄ±m TÃ¼rÃ¼ SeÃ§imi -->
  <section class="card count-type-selection">
    <h2>ğŸ“Š Depo SayÄ±m</h2>
    <div class="count-type-buttons">
      <button class="count-type-btn" data-type="full">
        <span class="btn-icon">ğŸ“‹</span>
        <span class="btn-text">Tam SayÄ±m</span>
        <small>TÃ¼m depoyu say</small>
      </button>
      <button class="count-type-btn" data-type="spot">
        <span class="btn-icon">ğŸ¯</span>
        <span class="btn-text">Nokta SayÄ±m</span>
        <small>Belirli Ã¼rÃ¼nleri say</small>
      </button>
      <button class="count-type-btn" data-type="shelf">
        <span class="btn-icon">ğŸ—ï¸</span>
        <span class="btn-text">Raf SayÄ±m</span>
        <small>Belirli raflarÄ± say</small>
      </button>
      <button class="count-type-btn" data-type="manual">
        <span class="btn-icon">ğŸ“±</span>
        <span class="btn-text">Manuel SayÄ±m</span>
        <small>Tek tek barkod okut</small>
      </button>
    </div>
  </section>

  <!-- SayÄ±m Formu -->
  <section class="card count-form" id="countForm" style="display: none;">
    <div class="form-header">
      <h3 id="countTitle">SayÄ±m BaÅŸlat</h3>
      <button class="btn-close" id="closeCountForm">âœ•</button>
    </div>
    
    <div id="fullCountSetup" class="count-setup" style="display: none;">
      <h4>Tam SayÄ±m AyarlarÄ±</h4>
      <div class="form-group">
        <label>SayÄ±m AdÄ±:</label>
        <input type="text" id="fullCountName" placeholder="Ã–rn: YÄ±llÄ±k SayÄ±m 2024" />
      </div>
      <div class="form-group">
        <label>AÃ§Ä±klama:</label>
        <textarea id="fullCountDescription" placeholder="SayÄ±m aÃ§Ä±klamasÄ±..." rows="3"></textarea>
      </div>
      <button class="action-btn" id="startFullCount">
        <span class="btn-icon">ğŸš€</span>
        <span class="btn-text">Tam SayÄ±m BaÅŸlat</span>
      </button>
    </div>

    <div id="spotCountSetup" class="count-setup" style="display: none;">
      <h4>Nokta SayÄ±m AyarlarÄ±</h4>
      <div class="form-group">
        <label>ÃœrÃ¼n/SKU SeÃ§:</label>
        <input type="text" id="spotCountProduct" placeholder="SKU veya Ã¼rÃ¼n adÄ± girin..." />
        <div id="productSuggestions" class="suggestions"></div>
      </div>
      <button class="action-btn" id="startSpotCount">
        <span class="btn-icon">ğŸ¯</span>
        <span class="btn-text">Nokta SayÄ±m BaÅŸlat</span>
      </button>
    </div>

    <div id="shelfCountSetup" class="count-setup" style="display: none;">
      <h4>Raf SayÄ±m AyarlarÄ±</h4>
      <div class="form-group">
        <label>Raf Kodu:</label>
        <input type="text" id="shelfCountLocation" placeholder="Raf kodunu girin..." />
      </div>
      <button class="action-btn" id="startShelfCount">
        <span class="btn-icon">ğŸ—ï¸</span>
        <span class="btn-text">Raf SayÄ±m BaÅŸlat</span>
      </button>
    </div>

    <div id="manualCountSetup" class="count-setup" style="display: none;">
      <h4>Manuel SayÄ±m AyarlarÄ±</h4>
      <div class="form-group">
        <label>SayÄ±m AdÄ±:</label>
        <input type="text" id="manualCountName" placeholder="Ã–rn: Serbest SayÄ±m" />
      </div>
      <div class="form-group">
        <label>AÃ§Ä±klama:</label>
        <textarea id="manualCountDescription" placeholder="Bu sayÄ±mda hangi Ã¼rÃ¼nleri sayacaksÄ±nÄ±z?" rows="2"></textarea>
      </div>
      <div class="manual-count-info">
        <p><strong>ğŸ“± Manuel SayÄ±m:</strong></p>
        <ul>
          <li>BoÅŸ sayÄ±m oluÅŸturulur</li>
          <li>Barkod okutarak Ã¼rÃ¼nleri tek tek eklersiniz</li>
          <li>Sadece okutulan Ã¼rÃ¼nler sayÄ±ma dahil olur</li>
        </ul>
      </div>
      <button class="action-btn" id="startManualCount">
        <span class="btn-icon">ğŸ“±</span>
        <span class="btn-text">Manuel SayÄ±m BaÅŸlat</span>
      </button>
    </div>
  </section>

  <!-- Aktif SayÄ±mlar -->
  <section class="card active-counts">
    <h2>Aktif SayÄ±mlar</h2>
    <div id="activeCountsList" class="counts-list">
      <div class="empty-state">
        <span class="empty-icon">ğŸ“Š</span>
        <p>HenÃ¼z aktif sayÄ±m bulunmuyor.</p>
        <small>YukarÄ±dan yeni sayÄ±m baÅŸlatabilirsiniz.</small>
      </div>
    </div>
  </section>

  <!-- SayÄ±m Ä°ÅŸlemi -->
  <section class="card count-process" id="countProcess" style="display: none;">
    <div class="process-header">
      <h3 id="processTitle">SayÄ±m Ä°ÅŸlemi</h3>
      <div class="process-info">
        <span id="processProgress">0/0</span>
        <span id="processType" class="process-badge"></span>
      </div>
    </div>

    <div class="scanner-section">
      <div class="scanner-input">
        <label>Barkod TarayÄ±cÄ±:</label>
        <input type="text" id="countScanner" placeholder="Barkod okutun..." autocomplete="off" />
        <div class="scanner-help">
          <small>ğŸ“± Barkod okutun veya manuel girin</small>
        </div>
      </div>

      <div class="current-scan" id="currentScan" style="display: none;">
        <div class="scan-info">
          <h4 id="scanProduct">ÃœrÃ¼n</h4>
          <p id="scanLocation">Lokasyon</p>
          <p id="scanPackage" style="display: none;">Paket No</p>
          <div class="scan-expected">
            <span>Beklenen: <strong id="expectedQty">0</strong></span>
          </div>
        </div>
        <div class="location-verification" id="locationVerification" style="display: none;">
          <label>Raf Lokasyonu Kontrol:</label>
          <input type="text" id="locationScanner" placeholder="Raf barkodunu okutun veya manuel girin..." autocomplete="off" />
          <div class="location-status" id="locationStatus"></div>
        </div>
        <div class="quantity-input">
          <label>SayÄ±lan Miktar - GiriÅŸ YÃ¶ntemi SeÃ§in:</label>
          
          <!-- GiriÅŸ modu seÃ§imi -->
          <div class="input-mode-selection">
            <button class="mode-btn active" id="numberModeBtn" data-mode="number">
              <span class="mode-icon">ğŸ”¢</span>
              <span class="mode-text">SayÄ± Gir</span>
            </button>
            <button class="mode-btn" id="scanModeBtn" data-mode="scan">
              <span class="mode-icon">ğŸ“±</span>
              <span class="mode-text">Tek Tek Okut</span>
            </button>
          </div>
          
          <!-- SayÄ± girme modu -->
          <div class="qty-input-section" id="numberInputSection">
            <div class="qty-controls">
              <button class="qty-btn" data-action="minus">-</button>
              <input type="number" id="countedQty" value="0" min="0" />
              <button class="qty-btn" data-action="plus">+</button>
            </div>
          </div>
          
          <!-- Tek tek okutma modu -->
          <div class="scan-input-section" id="scanInputSection" style="display: none;">
            <div class="scan-counter">
              <div class="scan-display">
                <span class="scan-count" id="scanCount">0</span>
                <span class="scan-label">Adet Okutuldu</span>
              </div>
              <input type="text" id="itemScanner" placeholder="ÃœrÃ¼n barkodunu okutun..." autocomplete="off" />
              <div class="scan-help">
                <small>ğŸ“± Her Ã¼rÃ¼nÃ¼ ayrÄ± ayrÄ± okutun</small>
              </div>
            </div>
          </div>
        </div>
        <div class="scan-actions">
          <button class="action-btn confirm-btn" id="confirmCount">
            <span class="btn-icon">âœ…</span>
            <span class="btn-text">Onayla</span>
          </button>
          <button class="action-btn skip-btn" id="skipCount">
            <span class="btn-icon">â­ï¸</span>
            <span class="btn-text">Atla</span>
          </button>
        </div>
      </div>
    </div>

    <div class="count-summary">
      <div class="summary-stats">
        <div class="summary-item">
          <span class="summary-label">SayÄ±lan:</span>
          <span class="summary-value" id="countedItems">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Fark:</span>
          <span class="summary-value" id="varianceItems">0</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Kalan:</span>
          <span class="summary-value" id="remainingItems">0</span>
        </div>
      </div>
      
      <!-- SayÄ±m Ã–nizleme -->
      <div class="count-preview">
        <div class="preview-header">
          <h4>ğŸ“‹ YapÄ±lan SayÄ±mlar</h4>
          <button class="preview-toggle" id="previewToggle">
            <span class="toggle-icon">ğŸ‘ï¸</span>
            <span class="toggle-text">Ã–nizleme</span>
          </button>
        </div>
        <div class="preview-content" id="previewContent" style="display: none;">
          <div class="preview-controls">
            <div class="preview-search">
              <input type="text" id="previewSearch" placeholder="ğŸ” SKU, Ã¼rÃ¼n adÄ± veya paket no ile ara..." />
            </div>
            <div class="preview-filters">
              <select id="previewFilter">
                <option value="all">TÃ¼mÃ¼</option>
                <option value="counted">SayÄ±lanlar</option>
                <option value="variance">Fark Olanlar</option>
                <option value="pending">Bekleyenler</option>
                <option value="skipped">Atlananlar</option>
              </select>
              <select id="previewSort">
                <option value="sku">SKU'ya GÃ¶re</option>
                <option value="location">Lokasyona GÃ¶re</option>
                <option value="status">Duruma GÃ¶re</option>
                <option value="variance">Farka GÃ¶re</option>
                <option value="product">ÃœrÃ¼n AdÄ±na GÃ¶re</option>
              </select>
            </div>
          </div>
          <div class="preview-list" id="previewList">
            <div class="empty-state">
              <span class="empty-icon">ğŸ“Š</span>
              <p>HenÃ¼z sayÄ±m yapÄ±lmadÄ±.</p>
            </div>
          </div>
        </div>
      </div>
      
      <button class="action-btn complete-btn" id="completeCount" style="display: none;">
        <span class="btn-icon">ğŸ</span>
        <span class="btn-text">SayÄ±mÄ± Tamamla</span>
      </button>
    </div>
  </section>

  <!-- SayÄ±m GeÃ§miÅŸi -->
  <section class="card count-history">
    <h2>SayÄ±m GeÃ§miÅŸi</h2>
    <div class="history-filters">
      <select id="historyFilter">
        <option value="all">TÃ¼mÃ¼</option>
        <option value="full">Tam SayÄ±m</option>
        <option value="spot">Nokta SayÄ±m</option>
        <option value="shelf">Raf SayÄ±m</option>
      </select>
      <input type="date" id="historyDate" />
    </div>
    <div id="countHistoryList" class="history-list">
      <div class="empty-state">
        <span class="empty-icon">ğŸ“‹</span>
        <p>HenÃ¼z sayÄ±m geÃ§miÅŸi bulunmuyor.</p>
      </div>
    </div>
  </section>
</main>

<!-- SayÄ±m Tamamlama ModalÄ± -->
<div class="modal" id="completeModal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>SayÄ±m TamamlandÄ±</h3>
    </div>
    <div class="modal-body">
      <div class="completion-summary">
        <div class="summary-row">
          <span>Toplam SayÄ±lan Kalem:</span>
          <strong id="finalCountedItems">0</strong>
        </div>
        <div class="summary-row">
          <span>SayÄ±lmayan Kalem:</span>
          <strong id="finalUncountedItems">0</strong>
        </div>
        <div class="summary-row">
          <span>Fark Bulunan Kalem:</span>
          <strong id="finalVarianceItems">0</strong>
        </div>
        <div class="summary-row">
          <span>Toplam Fark MiktarÄ±:</span>
          <strong id="finalVarianceQty">0</strong>
        </div>
      </div>
      <div class="variance-details" id="varianceDetails" style="display: none;">
        <h4>Fark DetaylarÄ±:</h4>
        <div id="varianceList" class="variance-list"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="action-btn" id="generateReport">
        <span class="btn-icon">ğŸ“„</span>
        <span class="btn-text">Rapor OluÅŸtur</span>
      </button>
      <button class="action-btn warning" id="fixVariances" style="display: none;">
        <span class="btn-icon">ğŸ”§</span>
        <span class="btn-text">FarklarÄ± DÃ¼zelt</span>
      </button>
      <button class="action-btn secondary" id="closeCompleteModal">
        <span class="btn-icon">âœ…</span>
        <span class="btn-text">Tamam</span>
      </button>
    </div>
  </div>
</div>

<!-- Lokasyon SeÃ§im ModalÄ± -->
<div class="modal" id="locationModal" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Raf SeÃ§imi</h3>
    </div>
    <div class="modal-body">
      <p id="locationModalText">Bu Ã¼rÃ¼n birden fazla rafta bulunmakta. Hangi rafÄ± saydÄ±ÄŸÄ±nÄ±zÄ±n raf kodunu girin:</p>
      <div class="location-selector">
        <div id="locationOptions" class="location-options"></div>
        <div class="location-scanner-input">
          <label>Raf Barkodu Okutun:</label>
          <input type="text" id="locationModalScanner" placeholder="Raf barkodunu okutun..." autocomplete="off" />
          <div class="location-scanner-status" id="locationScannerStatus"></div>
        </div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="action-btn secondary" id="cancelLocationModal">
        <span class="btn-icon">âœ•</span>
        <span class="btn-text">Ä°ptal</span>
      </button>
    </div>
  </div>
</div>

<script type="module">
const API = {
  counts: {
    create: (data) => fetch('/api/inventory-counts', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}).then(r => r.json()),
    list: () => fetch('/api/inventory-counts').then(r => r.json()),
    get: (id) => fetch(`/api/inventory-counts/${id}`).then(r => r.json()),
    complete: (id) => fetch(`/api/inventory-counts/${id}/complete`, {method: 'POST'}).then(r => r.json()),
    items: (countId) => fetch(`/api/inventory-counts/${countId}/items`).then(r => r.json()),
    addItem: (countId, data) => fetch(`/api/inventory-counts/${countId}/items`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}).then(r => r.json()),
    updateItem: (countId, itemId, data) => fetch(`/api/inventory-counts/${countId}/items/${itemId}`, {method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}).then(r => r.json()),
    scan: (countId, barcode) => fetch(`/api/inventory-counts/${countId}/scan`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({barcode})}).then(r => r.json())
  },
  products: () => fetch('/api/products').then(r => r.json()),
  locations: () => fetch('/api/locations').then(r => r.json())
};

let currentCount = null;
let currentCountItems = [];
let currentScanIndex = 0;
let pendingLocationItems = [];
let currentBarcode = null;

// SayÄ±m tÃ¼rÃ¼ seÃ§imi
document.querySelectorAll('.count-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const type = btn.dataset.type;
    showCountForm(type);
  });
});

function showCountForm(type) {
  document.getElementById('countForm').style.display = 'block';
  document.querySelectorAll('.count-setup').forEach(setup => setup.style.display = 'none');
  
  switch(type) {
    case 'full':
      document.getElementById('countTitle').textContent = 'Tam SayÄ±m';
      document.getElementById('fullCountSetup').style.display = 'block';
      break;
    case 'spot':
      document.getElementById('countTitle').textContent = 'Nokta SayÄ±m';
      document.getElementById('spotCountSetup').style.display = 'block';
      break;
    case 'shelf':
      document.getElementById('countTitle').textContent = 'Raf SayÄ±m';
      document.getElementById('shelfCountSetup').style.display = 'block';
      break;
    case 'manual':
      document.getElementById('countTitle').textContent = 'Manuel SayÄ±m';
      document.getElementById('manualCountSetup').style.display = 'block';
      break;
  }
}

// Form kapatma
document.getElementById('closeCountForm').addEventListener('click', () => {
  document.getElementById('countForm').style.display = 'none';
});

// Tam sayÄ±m baÅŸlatma
document.getElementById('startFullCount').addEventListener('click', async () => {
  const name = document.getElementById('fullCountName').value.trim();
  const description = document.getElementById('fullCountDescription').value.trim();
  
  if (!name) {
    alert('SayÄ±m adÄ± gerekli!');
    return;
  }

  try {
    const result = await API.counts.create({
      type: 'full',
      name: name,
      description: description
    });
    
    if (result.success && result.count) {
      startCountProcess(result.count);
    } else {
      throw new Error(result.error || 'SayÄ±m oluÅŸturulamadÄ±');
    }
  } catch (error) {
    alert('SayÄ±m baÅŸlatÄ±lamadÄ±: ' + error.message);
  }
});

// Nokta sayÄ±m baÅŸlatma
document.getElementById('startSpotCount').addEventListener('click', async () => {
  const productSearch = document.getElementById('spotCountProduct').value.trim();
  
  if (!productSearch) {
    alert('ÃœrÃ¼n seÃ§imi gerekli!');
    return;
  }

  try {
    const result = await API.counts.create({
      type: 'spot',
      name: `Nokta SayÄ±m - ${productSearch}`,
      product_filter: productSearch
    });
    
    if (result.success && result.count) {
      startCountProcess(result.count);
    } else {
      throw new Error(result.error || 'SayÄ±m oluÅŸturulamadÄ±');
    }
  } catch (error) {
    alert('SayÄ±m baÅŸlatÄ±lamadÄ±: ' + error.message);
  }
});

// Raf sayÄ±m baÅŸlatma
document.getElementById('startShelfCount').addEventListener('click', async () => {
  const shelfCode = document.getElementById('shelfCountLocation').value.trim();
  
  if (!shelfCode) {
    alert('Raf kodu gerekli!');
    return;
  }

  try {
    const result = await API.counts.create({
      type: 'shelf',
      name: `Raf SayÄ±m - ${shelfCode}`,
      shelf_filter: shelfCode
    });
    
    if (result.success && result.count) {
      startCountProcess(result.count);
    } else {
      throw new Error(result.error || 'SayÄ±m oluÅŸturulamadÄ±');
    }
  } catch (error) {
    alert('SayÄ±m baÅŸlatÄ±lamadÄ±: ' + error.message);
  }
});

// Manuel sayÄ±m baÅŸlatma
document.getElementById('startManualCount').addEventListener('click', async () => {
  const name = document.getElementById('manualCountName').value.trim();
  const description = document.getElementById('manualCountDescription').value.trim();
  
  if (!name) {
    alert('SayÄ±m adÄ± gerekli!');
    return;
  }

  try {
    const result = await API.counts.create({
      type: 'manual',
      name: name,
      description: description
    });
    
    if (result.success && result.count) {
      startCountProcess(result.count);
    } else {
      throw new Error(result.error || 'SayÄ±m oluÅŸturulamadÄ±');
    }
  } catch (error) {
    alert('SayÄ±m baÅŸlatÄ±lamadÄ±: ' + error.message);
  }
});

// SayÄ±m iÅŸlemini baÅŸlat
async function startCountProcess(count) {
  currentCount = count;
  currentScanIndex = 0;
  
  try {
    // SayÄ±m kalemlerini yÃ¼kle
    const itemsResponse = await API.counts.items(count.id);
    currentCountItems = itemsResponse.success ? itemsResponse.items : [];
    
    // UI'Ä± sayÄ±m moduna geÃ§
    document.getElementById('countForm').style.display = 'none';
    document.getElementById('countProcess').style.display = 'block';
    document.getElementById('processTitle').textContent = count.name;
    document.getElementById('processType').textContent = count.type.toUpperCase();
    
    updateProgress();
    
    // Scanner'Ä± aktif et
    document.getElementById('countScanner').focus();
  } catch (error) {
    console.error('SayÄ±m kalemleri yÃ¼klenemedi:', error);
    alert('SayÄ±m kalemleri yÃ¼klenirken hata oluÅŸtu: ' + error.message);
  }
}

// Ä°lerleme gÃ¼ncelleme
function updateProgress() {
  const counted = currentCountItems.filter(item => item && item.status === 'counted').length;
  const total = currentCountItems.length;
  const variance = currentCountItems.filter(item => item && item.variance !== 0).length;
  
  document.getElementById('processProgress').textContent = `${counted}/${total}`;
  document.getElementById('countedItems').textContent = counted;
  document.getElementById('varianceItems').textContent = variance;
  document.getElementById('remainingItems').textContent = total - counted;
  
  // Ã–nizleme listesini gÃ¼ncelle
  updatePreviewList();
  
  // SayÄ±m tamamlandÄ±ysa veya en az 1 Ã¼rÃ¼n sayÄ±ldÄ±ysa tamamlama butonunu gÃ¶ster
  if ((counted === total && total > 0) || counted > 0) {
    document.getElementById('completeCount').style.display = 'block';
    
    // KÄ±smi tamamlama iÃ§in buton metnini gÃ¼ncelle
    const completeBtn = document.getElementById('completeCount');
    if (counted === total) {
      completeBtn.innerHTML = '<span class="btn-icon">ğŸ</span><span class="btn-text">SayÄ±mÄ± Tamamla</span>';
    } else {
      completeBtn.innerHTML = '<span class="btn-icon">âš ï¸</span><span class="btn-text">KÄ±smi Tamamla (' + counted + '/' + total + ')</span>';
    }
  }
}

// Ã–nizleme listesini gÃ¼ncelle
function updatePreviewList() {
  const filter = document.getElementById('previewFilter')?.value || 'all';
  const sortBy = document.getElementById('previewSort')?.value || 'sku';
  const searchQuery = document.getElementById('previewSearch')?.value.toLowerCase().trim() || '';
  
  let filteredItems = [...currentCountItems];
  
  // Filtre uygula
  switch(filter) {
    case 'counted':
      filteredItems = filteredItems.filter(item => item.status === 'counted');
      break;
    case 'variance':
      filteredItems = filteredItems.filter(item => item.variance !== 0);
      break;
    case 'pending':
      filteredItems = filteredItems.filter(item => item.status === 'pending');
      break;
    case 'skipped':
      filteredItems = filteredItems.filter(item => item.status === 'skipped');
      break;
  }
  
  // Arama uygula
  if (searchQuery) {
    filteredItems = filteredItems.filter(item => 
      item.sku?.toLowerCase().includes(searchQuery) ||
      item.product_name?.toLowerCase().includes(searchQuery) ||
      item.package_barcode?.toLowerCase().includes(searchQuery) ||
      item.package_number?.toLowerCase().includes(searchQuery) ||
      item.location_code?.toLowerCase().includes(searchQuery)
    );
  }
  
  // SÄ±ralama uygula
  filteredItems.sort((a, b) => {
    switch(sortBy) {
      case 'sku':
        return (a.sku || '').localeCompare(b.sku || '');
      case 'location':
        return (a.location_code || '').localeCompare(b.location_code || '');
      case 'status':
        const statusOrder = { 'counted': 1, 'pending': 2, 'skipped': 3 };
        return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
      case 'variance':
        return Math.abs(b.variance || 0) - Math.abs(a.variance || 0);
      case 'product':
        return (a.product_name || '').localeCompare(b.product_name || '');
      default:
        return 0;
    }
  });
  
  const previewList = document.getElementById('previewList');
  if (!previewList) return;
  
  if (filteredItems.length === 0) {
    previewList.innerHTML = `
      <div class="empty-state">
        <span class="empty-icon">ğŸ“Š</span>
        <p>Bu filtrede Ã¶ÄŸe bulunmuyor.</p>
      </div>`;
    return;
  }
  
  const itemsHtml = filteredItems.map(item => {
    if (!item) return ''; // Skip undefined items
    const statusIcon = item.status === 'counted' ? 'âœ…' : 
                      item.status === 'skipped' ? 'â­ï¸' : 'â³';
    const varianceClass = item.variance > 0 ? 'positive' : 
                         item.variance < 0 ? 'negative' : '';
    
    return `
      <div class="preview-item ${item.status}">
        <div class="preview-info">
          <span class="preview-status">${statusIcon}</span>
          <div class="preview-details">
            <strong>${item.sku}</strong>
            <span class="preview-name">${item.product_name}</span>
            <span class="preview-location">ğŸ“ ${item.location_code}</span>
            ${item.package_number && item.package_number !== 'NO-PKG' ? 
              `<span class="preview-package">ğŸ“¦ ${item.package_number}</span>` : 
              ''
            }
          </div>
        </div>
        <div class="preview-counts">
          <span class="expected">Beklenen: ${item.expected_quantity}</span>
          ${item.status === 'counted' ? 
            `<span class="counted">SayÄ±lan: ${item.counted_quantity}</span>` : 
            '<span class="pending-text">Bekliyor</span>'
          }
          ${item.variance !== 0 ? 
            `<span class="variance ${varianceClass}">Fark: ${item.variance > 0 ? '+' : ''}${item.variance}</span>` : 
            ''
          }
        </div>
      </div>`;
  }).join('');
  
  previewList.innerHTML = itemsHtml;
}

// Ã–nizleme toggle
document.addEventListener('click', (e) => {
  if (e.target.closest('#previewToggle')) {
    const content = document.getElementById('previewContent');
    const isVisible = content.style.display !== 'none';
    
    content.style.display = isVisible ? 'none' : 'block';
    
    const toggleIcon = document.querySelector('.toggle-icon');
    const toggleText = document.querySelector('.toggle-text');
    
    if (isVisible) {
      toggleIcon.textContent = 'ğŸ‘ï¸';
      toggleText.textContent = 'Ã–nizleme';
    } else {
      toggleIcon.textContent = 'ğŸ‘ï¸â€ğŸ—¨ï¸';
      toggleText.textContent = 'Gizle';
      updatePreviewList();
    }
  }
});

// Ã–nizleme filtre ve sÄ±ralama
document.addEventListener('change', (e) => {
  if (e.target.id === 'previewFilter' || e.target.id === 'previewSort') {
    updatePreviewList();
  }
});

// Ã–nizleme arama
document.addEventListener('input', (e) => {
  if (e.target.id === 'previewSearch') {
    // Debounce iÃ§in timeout kullan
    clearTimeout(window.previewSearchTimeout);
    window.previewSearchTimeout = setTimeout(() => {
      updatePreviewList();
    }, 300);
  }
});

// Barkod scanner with debouncing
let barcodeTimeout;
document.getElementById('countScanner').addEventListener('input', async (e) => {
  let barcode = e.target.value.trim();
  
  // EÄŸer barkod HTML/JavaScript iÃ§eriyor ise temizle (corruption durumu)
  if (barcode.includes('Global input event') || barcode.includes('inventory-count.html') || barcode.length > 50) {
    console.log('Corrupted input detected, clearing field');
    e.target.value = '';
    return;
  }
  
  console.log('Scanner input event, barcode:', JSON.stringify(barcode));
  
  // Clear previous timeout
  clearTimeout(barcodeTimeout);
  
  if (barcode.length === 0) {
    return; // Empty input, do nothing
  }
  
  // For automatic barcode scanners (>= 6 characters), process immediately
  if (barcode.length >= 6) {
    // Clear timeout and process immediately for scanner input
    clearTimeout(barcodeTimeout);
    await processBarcodeInput(e.target, barcode);
  } else {
    // For manual input (< 6 characters), wait 1.5 seconds before processing
    barcodeTimeout = setTimeout(async () => {
      if (e.target.value.trim() === barcode) { // Only process if value hasn't changed
        await processBarcodeInput(e.target, barcode);
      }
    }, 1500);
  }
});

// Process barcode input
async function processBarcodeInput(inputElement, barcode) {
  if (currentCount.type === 'manual') {
    // Manuel sayÄ±m - mevcut listeden eÅŸleÅŸme veya yeni Ã¼rÃ¼n ekleme
    const matchedItem = currentCountItems.find(item => 
      item.barcode === barcode || 
      item.package_barcode === barcode
    );
    
    if (matchedItem) {
      inputElement.value = '';
      await processBarcodeScan(barcode);
    } else {
      inputElement.value = '';
      await addManualCountItem(barcode);
    }
  } else {
    // DiÄŸer sayÄ±m tÃ¼rleri - mevcut listeden eÅŸleÅŸme (full, spot, shelf)
    const matchedItem = currentCountItems.find(item => 
      item.barcode === barcode || 
      item.package_barcode === barcode
    );
    
    if (matchedItem) {
      inputElement.value = '';
      await processBarcodeScan(barcode);
    } else {
      // Barkod listede bulunamadÄ± - kullanÄ±cÄ±yÄ± bilgilendir
      alert(`Bu barkod (${barcode}) sayÄ±m listesinde bulunamadÄ±!`);
      inputElement.value = '';
    }
  }
}

// Barkod iÅŸleme
async function processBarcodeScan(barcode) {
  try {
    // SayÄ±m kalemlerinde barkodu ara - sayÄ±lmamÄ±ÅŸ olanlarÄ± bul
    const items = currentCountItems.filter(item => 
      (item.barcode === barcode || 
       item.package_barcode === barcode) &&
      item.status === 'pending'
    );
    
    if (items.length === 0) {
      // HiÃ§ bulunmadÄ± veya hepsi sayÄ±lmÄ±ÅŸ
      const allMatches = currentCountItems.filter(item => 
        item.barcode === barcode || 
        item.package_barcode === barcode
      );
      
      if (allMatches.length === 0) {
        alert('Bu barkod sayÄ±m listesinde bulunamadÄ±!');
      } else {
        // Zaten sayÄ±lan paket - ekstra sayÄ±m Ã¶ner
        const countedItem = allMatches.find(item => item.status === 'counted');
        if (countedItem) {
          const extraConfirm = confirm(
            `âš ï¸ EKSTRA PAKET BULUNDU!\n\n` +
            `Bu paket zaten sayÄ±ldÄ±:\n` +
            `ğŸ“¦ ${countedItem.product_name}\n` +
            `ğŸ“ ${countedItem.location_code}\n` +
            `âœ… SayÄ±lan: ${countedItem.counted_quantity}\n\n` +
            `Bu rafta ekstra paket mi buldunuz?\n` +
            `Ekstra sayÄ±m yapmak istiyorsanÄ±z "Tamam"a basÄ±n.`
          );
          
          if (extraConfirm) {
            showCurrentScan(countedItem, true); // Ekstra sayÄ±m iÃ§in tekrar aÃ§
          }
        } else {
          alert('Bu barkodun tÃ¼m lokasyonlarÄ± zaten sayÄ±ldÄ±!');
        }
      }
      return;
    }
    
    // Birden fazla lokasyon varsa raf seÃ§im modalÄ± aÃ§
    if (items.length > 1) {
      showLocationSelectionModal(items, barcode);
    } else {
      // Tek lokasyon
      showCurrentScan(items[0]);
    }
    
  } catch (error) {
    console.error('Barkod iÅŸleme hatasÄ±:', error);
    alert('Barkod iÅŸlenirken hata oluÅŸtu');
  }
}

// Mevcut tarama gÃ¶sterimi
function showCurrentScan(item, skipLocationCheck = false) {
  if (!item) {
    console.error('showCurrentScan: item is undefined');
    return;
  }
  document.getElementById('currentScan').style.display = 'block';
  document.getElementById('scanProduct').textContent = `${item.product_name || item.name || 'Unknown'} (${item.sku || 'No SKU'})`;
  document.getElementById('scanLocation').textContent = `Lokasyon: ${item.location_code || 'No Location'}`;
  
  // Package no bilgisini gÃ¶ster
  const packageElement = document.getElementById('scanPackage');
  if (item.package_number && item.package_number !== 'NO-PKG') {
    packageElement.textContent = `Paket No: ${item.package_number}`;
    packageElement.style.display = 'block';
  } else {
    packageElement.style.display = 'none';
  }
  
  document.getElementById('expectedQty').textContent = item.expected_quantity;
  document.getElementById('countedQty').value = item.expected_quantity;
  
  // SayaÃ§larÄ± sÄ±fÄ±rla
  window.currentScanCount = 0;
  document.getElementById('scanCount').textContent = '0';
  
  // GiriÅŸ modunu sayÄ± girme olarak baÅŸlat
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('numberModeBtn').classList.add('active');
  document.getElementById('numberInputSection').style.display = 'block';
  document.getElementById('scanInputSection').style.display = 'none';
  
  // Tam sayÄ±m iÃ§in lokasyon kontrolÃ¼ gÃ¶ster (modal'dan geldiyse atla)
  if (currentCount && currentCount.type === 'full' && !skipLocationCheck) {
    document.getElementById('locationVerification').style.display = 'block';
    document.getElementById('locationScanner').focus();
    window.locationVerified = false;
  } else {
    document.getElementById('locationVerification').style.display = 'none';
    document.getElementById('countedQty').focus();
    document.getElementById('countedQty').select();
    window.locationVerified = true;
  }
  
  // Mevcut item'Ä± sakla
  window.currentScanItem = item;
}

// GiriÅŸ modu deÄŸiÅŸtirme - delegated event
document.addEventListener('click', (e) => {
  if (e.target.closest('.mode-btn')) {
    const btn = e.target.closest('.mode-btn');
    
    // Mode butonlarÄ±nÄ± gÃ¼ncelle
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const mode = btn.dataset.mode;
    if (mode === 'number') {
      document.getElementById('numberInputSection').style.display = 'block';
      document.getElementById('scanInputSection').style.display = 'none';
    } else if (mode === 'scan') {
      document.getElementById('numberInputSection').style.display = 'none';
      document.getElementById('scanInputSection').style.display = 'block';
      document.getElementById('scanCount').textContent = '0';
      window.currentScanCount = 0;
      setTimeout(() => {
        document.getElementById('itemScanner')?.focus();
      }, 100);
    }
  }
});

// Miktar kontrolleri
document.querySelectorAll('.qty-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const input = document.getElementById('countedQty');
    const current = parseInt(input.value) || 0;
    const action = btn.dataset.action;
    
    if (action === 'plus') {
      input.value = current + 1;
    } else if (action === 'minus' && current > 0) {
      input.value = current - 1;
    }
  });
});

// Global input event listener - tÃ¼m input'larÄ± dinle
// REMOVED: Global input event listener that was causing input corruption

// itemScanner iÃ§in Ã¶zel event handler (tek tek okut modu - tÃ¼m sayÄ±m tÃ¼rleri)
document.getElementById('itemScanner').addEventListener('input', (e) => {
  const barcode = e.target.value.trim();
  const currentItem = window.currentScanItem;
  
  if (barcode.length > 0 && currentItem) {
    // ÃœrÃ¼n barkodu kontrol et - eÅŸleÅŸmede otomatik enter iÅŸlemi
    if (barcode === currentItem.barcode || 
        barcode === currentItem.package_barcode) {
      
      // SayacÄ± artÄ±r
      window.currentScanCount = (window.currentScanCount || 0) + 1;
      document.getElementById('scanCount').textContent = window.currentScanCount;
      
      // countedQty'yi gÃ¼ncelle
      document.getElementById('countedQty').value = window.currentScanCount;
      
      // Input'u temizle - otomatik enter iÅŸlemi
      e.target.value = '';
      
      // BaÅŸarÄ± efekti
      const scanDisplay = document.querySelector('.scan-display');
      if (scanDisplay) {
        scanDisplay.style.background = '#d4edda';
        setTimeout(() => {
          scanDisplay.style.background = '';
        }, 300);
      }
      
      // BaÅŸarÄ± sesi (opsiyonel)
      try {
        // Modern tarayÄ±cÄ±larda ses Ã§alabilir - kÄ±sa beep sesi
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        // Ses Ã§alÄ±namazsa normal devam et
      }
    } else {
      // YanlÄ±ÅŸ barkod - kÄ±rmÄ±zÄ± efekt
      const scanDisplay = document.querySelector('.scan-display');
      if (scanDisplay) {
        scanDisplay.style.background = '#f8d7da';
        setTimeout(() => {
          scanDisplay.style.background = '';
        }, 300);
      }
    }
    // EÅŸleÅŸmezse de input'u temizle
    // e.target.value = '';
  }
});

// GiriÅŸ modu deÄŸiÅŸtirme - delegated event
document.addEventListener('click', (e) => {
  if (e.target.closest('.mode-btn')) {
    const btn = e.target.closest('.mode-btn');
    
    // Mode butonlarÄ±nÄ± gÃ¼ncelle
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    const mode = btn.dataset.mode;
    if (mode === 'number') {
      document.getElementById('numberInputSection').style.display = 'block';
      document.getElementById('scanInputSection').style.display = 'none';
    } else if (mode === 'scan') {
      document.getElementById('numberInputSection').style.display = 'none';
      document.getElementById('scanInputSection').style.display = 'block';
      document.getElementById('scanCount').textContent = '0';
      window.currentScanCount = 0;
      setTimeout(() => {
        document.getElementById('itemScanner')?.focus();
      }, 100);
    }
  }
});

// Lokasyon scanner - otomatik eÅŸleÅŸme ve manuel giriÅŸ desteÄŸi dengan debouncing
let locationTimeout;
document.getElementById('locationScanner').addEventListener('input', async (e) => {
  const locationBarcode = e.target.value.trim();
  const item = window.currentScanItem;
  
  // Clear previous timeout
  clearTimeout(locationTimeout);
  
  if (locationBarcode.length === 0) {
    document.getElementById('locationStatus').innerHTML = '';
    window.locationVerified = false;
    return;
  }
  
  if (item) {
    // For automatic barcode scanners (>= 4 characters), process immediately
    if (locationBarcode.length >= 4) {
      processLocationInput(e.target, locationBarcode, item);
    } else {
      // For manual input (< 4 characters), wait 1 second before processing
      locationTimeout = setTimeout(() => {
        if (e.target.value.trim() === locationBarcode) { // Only process if value hasn't changed
          processLocationInput(e.target, locationBarcode, item);
        }
      }, 1000);
    }
  }
});

// Process location input
function processLocationInput(inputElement, locationBarcode, item) {
  // Lokasyon eÅŸleÅŸmesi kontrol et
  if (locationBarcode === item.location_code) {
    // DoÄŸru lokasyon - kalÄ±cÄ± baÅŸarÄ± mesajÄ±
    document.getElementById('locationStatus').innerHTML = '<span style="color: var(--success);">âœ… Lokasyon doÄŸru - Miktar giriÅŸi yapabilirsiniz</span>';
    window.locationVerified = true;
    
    // Sadece 4+ karakter ise (barkod okuyucu) otomatik temizle
    if (locationBarcode.length >= 4) {
      inputElement.value = '';
    }
    
    // Miktar giriÅŸine geÃ§
    setTimeout(() => {
      document.getElementById('countedQty').focus();
      document.getElementById('countedQty').select();
    }, 300);
  } else {
    // YanlÄ±ÅŸ lokasyon - manuel giriÅŸte hemen hata gÃ¶sterme, biraz bekle
    if (locationBarcode.length >= 4) {
      document.getElementById('locationStatus').innerHTML = '<span style="color: var(--danger);">âŒ YanlÄ±ÅŸ lokasyon! Beklenen: ' + item.location_code + '</span>';
    } else {
      // KÄ±sa giriÅŸlerde hata gÃ¶sterme, kullanÄ±cÄ± henÃ¼z yazmaya devam ediyor olabilir
      document.getElementById('locationStatus').innerHTML = '<span style="color: var(--warning);">ğŸ” Beklenen: ' + item.location_code + '</span>';
    }
    window.locationVerified = false;
  }
}

// Lokasyon scanner iÃ§in Enter tuÅŸu desteÄŸi  
document.getElementById('locationScanner').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const locationBarcode = e.target.value.trim();
    const item = window.currentScanItem;
    
    if (locationBarcode.length > 0 && item && locationBarcode === item.location_code) {
      // DoÄŸru lokasyon girildiyse otomatik iÅŸlem
      document.getElementById('locationStatus').innerHTML = '<span style="color: var(--success);">âœ… Lokasyon doÄŸru - Miktar giriÅŸi yapabilirsiniz</span>';
      window.locationVerified = true;
      e.target.value = '';
      
      setTimeout(() => {
        document.getElementById('countedQty').focus();
        document.getElementById('countedQty').select();
      }, 300);
    }
  }
});

// SayÄ±m onaylama
document.getElementById('confirmCount').addEventListener('click', async () => {
  const countedQty = parseInt(document.getElementById('countedQty').value) || 0;
  const item = window.currentScanItem;
  
  if (!item) return;
  
  // Tam sayÄ±mda lokasyon kontrolÃ¼
  if (currentCount && currentCount.type === 'full' && !window.locationVerified) {
    alert('Ã–nce raf lokasyonunu doÄŸrulamalÄ±sÄ±nÄ±z!');
    document.getElementById('locationScanner').focus();
    return;
  }
  
  try {
    await API.counts.updateItem(currentCount.id, item.id, {
      counted_quantity: countedQty,
      status: 'counted'
    });
    
    // Local item'Ä± gÃ¼ncelle
    const itemIndex = currentCountItems.findIndex(i => i.id === item.id);
    if (itemIndex >= 0) {
      currentCountItems[itemIndex] = {
        ...currentCountItems[itemIndex],
        counted_quantity: countedQty,
        variance: countedQty - item.expected_quantity,
        status: 'counted'
      };
    }
    
    // UI'Ä± temizle ve gÃ¼ncelÂ­le
    document.getElementById('currentScan').style.display = 'none';
    document.getElementById('locationStatus').innerHTML = '';
    window.locationVerified = false;
    updateProgress();
    document.getElementById('countScanner').focus();
    
  } catch (error) {
    alert('SayÄ±m kaydedilemedi: ' + error.message);
  }
});

// SayÄ±m atlama
document.getElementById('skipCount').addEventListener('click', () => {
  document.getElementById('currentScan').style.display = 'none';
  document.getElementById('locationStatus').innerHTML = '';
  window.locationVerified = false;
  document.getElementById('countScanner').focus();
});

// SayÄ±m tamamlama
document.getElementById('completeCount').addEventListener('click', async () => {
  const counted = currentCountItems.filter(item => item.status === 'counted').length;
  const total = currentCountItems.length;
  
  // KÄ±smi tamamlama onayÄ±
  if (counted < total) {
    const remaining = total - counted;
    const confirm = window.confirm(
      `SayÄ±m henÃ¼z tamamlanmadÄ±!\n\n` +
      `SayÄ±lan: ${counted}/${total}\n` +
      `Kalan: ${remaining} Ã¼rÃ¼n\n\n` +
      `KÄ±smi olarak tamamlamak istediÄŸinizden emin misiniz?\n` +
      `SayÄ±lmayan Ã¼rÃ¼nler raporda "SAYILMADI" olarak gÃ¶rÃ¼necek.`
    );
    
    if (!confirm) return;
  }
  
  try {
    const result = await API.counts.complete(currentCount.id);
    showCompletionModal(result);
    
  } catch (error) {
    alert('SayÄ±m tamamlanamadÄ±: ' + error.message);
  }
});

// Tamamlama modalÄ±nÄ± gÃ¶ster
function showCompletionModal(result) {
  document.getElementById('finalCountedItems').textContent = result.summary.counted_items;
  document.getElementById('finalUncountedItems').textContent = result.summary.uncounted_items || 0;
  document.getElementById('finalVarianceItems').textContent = result.summary.variance_items;
  document.getElementById('finalVarianceQty').textContent = result.summary.total_variance;
  
  // Fark detaylarÄ± ve dÃ¼zeltme butonu
  if (result.variances && result.variances.length > 0) {
    document.getElementById('varianceDetails').style.display = 'block';
    document.getElementById('fixVariances').style.display = 'block';
    
    const varianceHtml = result.variances.map(v => `
      <div class="variance-item">
        <span class="variance-product">${v.product_name}</span>
        <span class="variance-location">${v.location_code}</span>
        <span class="variance-diff ${v.variance > 0 ? 'positive' : 'negative'}">
          ${v.variance > 0 ? '+' : ''}${v.variance}
        </span>
      </div>
    `).join('');
    document.getElementById('varianceList').innerHTML = varianceHtml;
    
    // Global deÄŸiÅŸkende fark verilerini sakla
    window.currentVariances = result.variances;
  } else {
    document.getElementById('fixVariances').style.display = 'none';
  }
  
  document.getElementById('completeModal').style.display = 'flex';
}

// Modal kapatma
document.getElementById('closeCompleteModal').addEventListener('click', () => {
  document.getElementById('completeModal').style.display = 'none';
  // SayÄ±m iÅŸlemini kapat ve ana sayfaya dÃ¶n
  document.getElementById('countProcess').style.display = 'none';
  loadActiveCounts();
  loadCountHistory();
});

// Rapor oluÅŸturma
document.getElementById('generateReport').addEventListener('click', async () => {
  try {
    window.open(`/api/inventory-counts/${currentCount.id}/report`, '_blank');
  } catch (error) {
    alert('Rapor oluÅŸturulamadÄ±: ' + error.message);
  }
});

// ÃœrÃ¼n Ã¶neriler (nokta sayÄ±m iÃ§in)
let productSuggestionsTimeout;
document.getElementById('spotCountProduct').addEventListener('input', (e) => {
  clearTimeout(productSuggestionsTimeout);
  const query = e.target.value.trim();
  
  if (query.length < 2) {
    document.getElementById('productSuggestions').innerHTML = '';
    return;
  }
  
  productSuggestionsTimeout = setTimeout(async () => {
    try {
      const products = await API.products();
      const filtered = products.filter(p => 
        p.sku.toLowerCase().includes(query.toLowerCase()) ||
        p.name.toLowerCase().includes(query.toLowerCase())
      ).slice(0, 5);
      
      const suggestionsHtml = filtered.map(p => `
        <div class="suggestion-item" data-sku="${p.sku}">
          <strong>${p.sku}</strong> - ${p.name}
        </div>
      `).join('');
      
      document.getElementById('productSuggestions').innerHTML = suggestionsHtml;
      
      // Ã–neri tÄ±klama
      document.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', () => {
          document.getElementById('spotCountProduct').value = item.dataset.sku;
          document.getElementById('productSuggestions').innerHTML = '';
        });
      });
    } catch (error) {
      console.error('ÃœrÃ¼n Ã¶nerileri yÃ¼klenemedi:', error);
    }
  }, 300);
});

// Aktif sayÄ±mlarÄ± yÃ¼kle
async function loadActiveCounts() {
  try {
    const response = await API.counts.list();
    const counts = response.success ? response.counts : [];
    const activeCounts = counts.filter(c => c.status === 'active');
    
    if (activeCounts.length === 0) {
      document.getElementById('activeCountsList').innerHTML = `
        <div class="empty-state">
          <span class="empty-icon">ğŸ“Š</span>
          <p>HenÃ¼z aktif sayÄ±m bulunmuyor.</p>
          <small>YukarÄ±dan yeni sayÄ±m baÅŸlatabilirsiniz.</small>
        </div>`;
      return;
    }
    
    const countsHtml = activeCounts.map(count => `
      <div class="count-item">
        <div class="count-info">
          <h4>${count.name}</h4>
          <p>${count.description || ''}</p>
          <div class="count-meta">
            <span class="count-type">${count.type.toUpperCase()}</span>
            <span class="count-date">${new Date(count.created_date).toLocaleDateString('tr-TR')}</span>
          </div>
        </div>
        <div class="count-actions">
          <button class="action-btn small" data-count-id="${count.id}">
            <span class="btn-icon">â–¶ï¸</span>
            <span class="btn-text">Devam Et</span>
          </button>
        </div>
      </div>
    `).join('');
    
    document.getElementById('activeCountsList').innerHTML = countsHtml;
    
    // Event listener'larÄ± ekle
    document.querySelectorAll('[data-count-id]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const countId = e.target.closest('[data-count-id]').dataset.countId;
        continueCount(parseInt(countId));
      });
    });
    
  } catch (error) {
    console.error('Aktif sayÄ±mlar yÃ¼klenemedi:', error);
  }
}

// SayÄ±m geÃ§miÅŸini yÃ¼kle
async function loadCountHistory() {
  try {
    const response = await API.counts.list();
    const counts = response.success ? response.counts : [];
    const completedCounts = counts.filter(c => c.status === 'completed');
    
    if (completedCounts.length === 0) {
      document.getElementById('countHistoryList').innerHTML = `
        <div class="empty-state">
          <span class="empty-icon">ğŸ“‹</span>
          <p>HenÃ¼z sayÄ±m geÃ§miÅŸi bulunmuyor.</p>
        </div>`;
      return;
    }
    
    const historyHtml = completedCounts.map(count => `
      <div class="history-item">
        <div class="history-info">
          <h4>${count.name}</h4>
          <div class="history-meta">
            <span class="history-type">${count.type.toUpperCase()}</span>
            <span class="history-date">${new Date(count.completed_date).toLocaleDateString('tr-TR')}</span>
          </div>
          <div class="history-stats">
            <span>SayÄ±lan: ${count.counted_items || 0}</span>
            <span>Fark: ${count.variance_items || 0}</span>
          </div>
        </div>
        <div class="history-actions">
          <button class="action-btn small" data-report-id="${count.id}">
            <span class="btn-icon">ğŸ“„</span>
            <span class="btn-text">Rapor</span>
          </button>
        </div>
      </div>
    `).join('');
    
    document.getElementById('countHistoryList').innerHTML = historyHtml;
    
    // Event listener'larÄ± ekle
    document.querySelectorAll('[data-report-id]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const reportId = e.target.closest('[data-report-id]').dataset.reportId;
        downloadReport(parseInt(reportId));
      });
    });
    
  } catch (error) {
    console.error('SayÄ±m geÃ§miÅŸi yÃ¼klenemedi:', error);
  }
}

// SayÄ±ma devam etme
async function continueCount(countId) {
  try {
    const count = await API.counts.get(countId);
    startCountProcess(count);
  } catch (error) {
    alert('SayÄ±m yÃ¼klenemedi: ' + error.message);
  }
}

// Rapor indirme
function downloadReport(countId) {
  window.open(`/api/inventory-counts/${countId}/report`, '_blank');
}

// Mobile navigation toggle (if exists)
const mobileNavToggle = document.getElementById('mobileNavToggle');
if (mobileNavToggle) {
  mobileNavToggle.addEventListener('click', () => {
    const menu = document.getElementById('mobileNavMenu');
    if (menu) menu.classList.toggle('show');
  });
}

// Close mobile menu when clicking outside (if exists)
const mobileNav = document.getElementById('mobileNav');
const mobileNavMenu = document.getElementById('mobileNavMenu');
if (mobileNav && mobileNavMenu) {
  document.addEventListener('click', (e) => {
    if (!mobileNav.contains(e.target)) {
      mobileNavMenu.classList.remove('show');
    }
  });
}

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', () => {
  loadActiveCounts();
  loadCountHistory();
});

// Lokasyon seÃ§im modalÄ±
function showLocationSelectionModal(items, barcode) {
  pendingLocationItems = items;
  currentBarcode = barcode;
  
  const optionsHtml = items.map((item, index) => `
    <div class="location-option">
      <strong>${item.location_code}</strong> - ${item.expected_quantity} adet
    </div>
  `).join('');
  
  document.getElementById('locationOptions').innerHTML = optionsHtml;
  document.getElementById('locationModalText').textContent = 
    `Bu Ã¼rÃ¼n ${items.length} farklÄ± rafta bulunmakta. Hangi rafÄ± saydÄ±ÄŸÄ±nÄ±zÄ±n raf kodunu girin:`;
  
  document.getElementById('locationModal').style.display = 'flex';
  document.getElementById('locationModalScanner').focus();
}

// Lokasyon modal scanner with debouncing
let modalLocationTimeout;
document.getElementById('locationModalScanner').addEventListener('input', (e) => {
  const shelfBarcode = e.target.value.trim();
  
  // Clear previous timeout
  clearTimeout(modalLocationTimeout);
  
  if (shelfBarcode.length === 0) {
    document.getElementById('locationScannerStatus').innerHTML = '';
    return;
  }
  
  // For automatic barcode scanners (>= 4 characters), process immediately
  if (shelfBarcode.length >= 4) {
    processModalLocationInput(e.target, shelfBarcode);
  } else {
    // For manual input (< 4 characters), wait 1 second before processing
    modalLocationTimeout = setTimeout(() => {
      if (e.target.value.trim() === shelfBarcode) { // Only process if value hasn't changed
        processModalLocationInput(e.target, shelfBarcode);
      }
    }, 1000);
  }
});

// Process modal location input
function processModalLocationInput(inputElement, shelfBarcode) {
  // EÅŸleÅŸen lokasyonu bul
  const matchedItem = pendingLocationItems.find(item => 
    item.location_code === shelfBarcode
  );
  
  if (matchedItem) {
    // DoÄŸru raf bulundu
    document.getElementById('locationScannerStatus').innerHTML = 
      '<span style="color: var(--success);">âœ… Raf bulundu: ' + matchedItem.location_code + '</span>';
    
    inputElement.value = '';
    
    // Modal'Ä± kapat ve sayÄ±ma baÅŸla
    setTimeout(() => {
      document.getElementById('locationModal').style.display = 'none';
      showCurrentScan(matchedItem, true); // true = modaldan geldi, lokasyon kontrolÃ¼ atla
    }, 500);
  } else {
    // YanlÄ±ÅŸ raf - manuel giriÅŸte daha nazik yaklaÅŸÄ±m
    if (shelfBarcode.length >= 4) {
      const validLocations = pendingLocationItems.map(item => item.location_code).join(', ');
      document.getElementById('locationScannerStatus').innerHTML = 
        '<span style="color: var(--danger);">âŒ GeÃ§ersiz raf! GeÃ§erli raflar: ' + validLocations + '</span>';
    } else {
      // KÄ±sa giriÅŸlerde sadece yÃ¶nlendirici mesaj gÃ¶ster
      const validLocations = pendingLocationItems.map(item => item.location_code).join(', ');
      document.getElementById('locationScannerStatus').innerHTML = 
        '<span style="color: var(--warning);">ğŸ” GeÃ§erli raflar: ' + validLocations + '</span>';
    }
  }
}

// Lokasyon modal kapatma
document.getElementById('cancelLocationModal').addEventListener('click', () => {
  document.getElementById('locationModal').style.display = 'none';
  document.getElementById('locationScannerStatus').innerHTML = '';
  document.getElementById('countScanner').focus();
});

// Manuel sayÄ±m iÃ§in Ã¼rÃ¼n ekleme
async function addManualCountItem(barcode) {
  console.log('addManualCountItem called with barcode:', barcode);
  try {
    const result = await API.counts.scan(currentCount.id, barcode);
    
    if (result.success && result.items && result.items.length > 0) {
      // Yeni Ã¼rÃ¼n eklendi - listeye ekle
      result.items.forEach(item => currentCountItems.push(item));
      updateProgress();
      
      // Ä°lk eklenen Ã¼rÃ¼nÃ¼ gÃ¶ster
      const firstItem = result.items[0];
      showCurrentScan(firstItem, true); // Manuel sayÄ±mda lokasyon kontrolÃ¼ yok
      
      // BaÅŸarÄ± mesajÄ±
      const scannerHelp = document.querySelector('.scanner-help small');
      const originalText = scannerHelp.textContent;
      scannerHelp.innerHTML = '<span style="color: var(--success);">âœ… ÃœrÃ¼n eklendi: ' + firstItem.product_name + '</span>';
      
      setTimeout(() => {
        scannerHelp.textContent = originalText;
      }, 2000);
    } else {
      alert(result.error || 'ÃœrÃ¼n eklenemedi');
    }
  } catch (error) {
    console.error('Manuel sayÄ±m ekleme hatasÄ±:', error);
    alert('ÃœrÃ¼n eklenirken hata oluÅŸtu');
  }
}

// GeÃ§miÅŸ filtreler
document.getElementById('historyFilter').addEventListener('change', loadCountHistory);
document.getElementById('historyDate').addEventListener('change', loadCountHistory);

// FarklarÄ± dÃ¼zeltme butonu
document.getElementById('fixVariances').addEventListener('click', () => {
  if (window.currentVariances && window.currentVariances.length > 0) {
    // Fark verilerini encode ederek Stock Management'a yÃ¶nlendir
    const varianceData = encodeURIComponent(JSON.stringify(window.currentVariances));
    const stockUrl = `/stock-management.html?mode=variance&data=${varianceData}`;
    window.location.href = stockUrl;
  }
});
</script>

<style>
.inventory-count {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  gap: 20px;
  display: flex;
  flex-direction: column;
}

.count-type-selection {
  text-align: center;
}

.count-type-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.count-type-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30px 20px;
  border: 2px solid #e1e5e9;
  border-radius: 12px;
  background: white;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
}

.count-type-btn:hover {
  border-color: #007bff;
  background: #f8f9fa;
  transform: translateY(-2px);
}

.count-type-btn .btn-icon {
  font-size: 2.5rem;
  margin-bottom: 10px;
}

.count-type-btn .btn-text {
  font-size: 1.2rem;
  font-weight: 600;
  color: #1a1a1a;
  margin-bottom: 5px;
}

.count-type-btn small {
  color: #333333;
  font-size: 0.9rem;
}

.count-form {
  border: 2px solid #007bff;
}

.form-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e1e5e9;
}

.btn-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #6c757d;
  padding: 5px;
}

.count-setup h4 {
  color: #1a1a1a;
  margin-bottom: 20px;
}

.suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 0 0 8px 8px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
}

.suggestion-item {
  padding: 10px 15px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
}

.suggestion-item:hover {
  background: #f8f9fa;
}

.count-process {
  border: 2px solid #28a745;
}

.process-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #e1e5e9;
}

.process-info {
  display: flex;
  gap: 15px;
  align-items: center;
}

.process-badge {
  background: #007bff;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
}

.scanner-section {
  margin-bottom: 30px;
}

.scanner-input {
  margin-bottom: 20px;
}

.scanner-input input {
  width: 100%;
  padding: 15px;
  font-size: 1.1rem;
  border: 2px solid #28a745;
  border-radius: 8px;
  text-align: center;
}

.scanner-help {
  text-align: center;
  margin-top: 8px;
}

.current-scan {
  background: var(--card);
  border: 2px solid var(--accent);
  border-radius: 12px;
  padding: 20px;
}

.scan-info h4 {
  color: #1a1a1a;
  margin-bottom: 5px;
}

.scan-info p {
  color: #333333;
  margin-bottom: 15px;
}

.scan-expected {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 10px;
  border-radius: 6px;
  margin-bottom: 20px;
  color: var(--fg);
}

.qty-controls {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 10px 0;
}

.qty-btn {
  width: 40px;
  height: 40px;
  border: 1px solid #ddd;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1.2rem;
  font-weight: bold;
}

.qty-controls input {
  width: 80px;
  text-align: center;
  padding: 10px;
  font-size: 1.1rem;
  border: 2px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--fg);
}

.scan-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}

.confirm-btn {
  background: #28a745;
}

.skip-btn {
  background: #6c757d;
}

.count-summary {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 20px;
  border-radius: 12px;
  margin-top: 20px;
}

.summary-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.summary-item {
  text-align: center;
  padding: 15px;
  background: var(--bg);
  border-radius: 8px;
  border: 1px solid var(--border);
}

.summary-label {
  display: block;
  font-size: 0.9rem;
  color: #333333;
  margin-bottom: 5px;
}

.summary-value {
  display: block;
  font-size: 1.5rem;
  font-weight: bold;
  color: #1a1a1a;
}

.complete-btn {
  width: 100%;
  background: #dc3545;
  font-size: 1.1rem;
  padding: 15px;
}

.counts-list, .history-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.count-item, .history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: var(--card);
  border-radius: 12px;
  border: 1px solid var(--border);
}

.count-info h4, .history-info h4 {
  color: #1a1a1a;
  margin-bottom: 5px;
}

.count-meta, .history-meta {
  display: flex;
  gap: 15px;
  margin: 10px 0;
}

.count-type, .history-type {
  background: #007bff;
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8rem;
}

.count-date, .history-date {
  color: #444444;
  font-size: 0.9rem;
}

.history-stats {
  display: flex;
  gap: 15px;
  font-size: 0.9rem;
  color: #333333;
}

.history-filters {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
}

.history-filters select,
.history-filters input {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.modal-header h3 {
  color: #1a1a1a;
  margin-bottom: 20px;
  text-align: center;
}

.completion-summary {
  margin-bottom: 20px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #f0f0f0;
}

.variance-details {
  margin: 20px 0;
}

.variance-list {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
}

.variance-item {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 15px;
  padding: 10px 15px;
  border-bottom: 1px solid var(--border);
  align-items: center;
  color: var(--fg);
}

.variance-diff.positive {
  color: var(--success);
  font-weight: bold;
}

.variance-diff.negative {
  color: var(--danger);
  font-weight: bold;
}

.location-verification {
  background: var(--card);
  border: 2px solid var(--warning);
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
  color: var(--fg);
}

.location-verification label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #2c2c2c;
}

.location-verification input {
  width: 100%;
  padding: 12px;
  font-size: 1.1rem;
  border: 2px solid var(--warning);
  border-radius: 6px;
  text-align: center;
  background: var(--bg);
  color: var(--fg);
}

.location-status {
  margin-top: 10px;
  font-weight: 600;
  text-align: center;
}

/* Projeye uygun dark theme renkleri */
.card h2, .card h3, .card h4 {
  color: var(--fg) !important;
}

.form-group label {
  color: var(--fg) !important;
  font-weight: 600;
}

.process-header h3 {
  color: var(--fg) !important;
}

.scanner-input label {
  color: var(--fg) !important;
  font-weight: 600;
}

.quantity-input label {
  color: var(--fg) !important;
  font-weight: 600;
}

/* Lokasyon seÃ§im modalÄ± stilleri */
.location-options {
  display: grid;
  gap: 10px;
  margin-bottom: 20px;
}

.location-option {
  padding: 15px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--fg);
  text-align: center;
}

.location-scanner-input {
  margin-top: 20px;
}

.location-scanner-input label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: var(--fg);
}

.location-scanner-input input {
  width: 100%;
  padding: 12px;
  font-size: 1.1rem;
  border: 2px solid var(--accent);
  border-radius: 6px;
  text-align: center;
  background: var(--bg);
  color: var(--fg);
}

.location-scanner-status {
  margin-top: 10px;
  font-weight: 600;
  text-align: center;
}

.manual-count-info {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 15px;
  margin: 15px 0;
}

.manual-count-info p {
  color: var(--fg);
  margin-bottom: 10px;
}

.manual-count-info ul {
  color: var(--muted);
  font-size: 0.9rem;
  margin: 0;
  padding-left: 20px;
}

.manual-count-info li {
  margin: 5px 0;
}

/* GiriÅŸ modu seÃ§imi */
.input-mode-selection {
  display: flex;
  gap: 10px;
  margin: 15px 0;
  justify-content: center;
}

.mode-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 16px;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  background: var(--card);
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--fg);
  min-width: 90px;
}

.mode-btn:hover {
  border-color: var(--accent);
}

.mode-btn.active {
  border-color: var(--accent);
  background: var(--accent);
  color: white;
}

.mode-icon {
  font-size: 1.2rem;
  margin-bottom: 4px;
}

.mode-text {
  font-size: 0.85rem;
  font-weight: 600;
}

/* Tek tek okutma bÃ¶lÃ¼mÃ¼ */
.scan-input-section {
  margin-top: 15px;
}

.scan-counter {
  text-align: center;
}

.scan-display {
  background: var(--card);
  border: 2px solid var(--accent);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  transition: background 0.3s ease;
}

.scan-count {
  display: block;
  font-size: 2rem;
  font-weight: bold;
  color: var(--accent);
  margin-bottom: 5px;
}

.scan-label {
  display: block;
  font-size: 0.9rem;
  color: var(--muted);
  font-weight: 600;
}

.scan-counter input {
  width: 100%;
  padding: 15px;
  font-size: 1.1rem;
  border: 2px solid var(--accent);
  border-radius: 8px;
  text-align: center;
  background: var(--bg);
  color: var(--fg);
  margin-bottom: 10px;
}

.qty-input-section {
  margin-top: 15px;
}

/* SayÄ±m Ã¶nizleme stilleri */
.count-preview {
  margin: 20px 0;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--card);
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  border-bottom: 1px solid var(--border);
}

.preview-header h4 {
  margin: 0;
  color: var(--fg);
}

.preview-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 15px;
  border: 1px solid var(--accent);
  border-radius: 6px;
  background: var(--bg);
  color: var(--accent);
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.preview-toggle:hover {
  background: var(--accent);
  color: white;
}

.preview-content {
  padding: 15px;
}

.preview-controls {
  margin-bottom: 15px;
}

.preview-search {
  margin-bottom: 15px;
}

.preview-search input {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--fg);
  font-size: 1rem;
}

.preview-search input:focus {
  border-color: var(--accent);
  outline: none;
}

.preview-filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.preview-filters select {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--fg);
  flex: 1;
  min-width: 140px;
}

.preview-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
}

.preview-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 15px;
  border-bottom: 1px solid var(--border);
}

.preview-item:last-child {
  border-bottom: none;
}

.preview-item.counted {
  background: rgba(40, 167, 69, 0.1);
}

.preview-item.pending {
  background: rgba(255, 193, 7, 0.1);
}

.preview-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.preview-status {
  font-size: 1.1rem;
}

.preview-details {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.preview-details strong {
  color: var(--fg);
  font-size: 0.95rem;
}

.preview-name {
  color: var(--muted);
  font-size: 0.85rem;
}

.preview-location {
  color: var(--muted);
  font-size: 0.8rem;
}

.preview-package {
  color: var(--accent);
  font-size: 0.8rem;
  font-weight: 600;
}

.preview-counts {
  display: flex;
  flex-direction: column;
  gap: 3px;
  text-align: right;
  font-size: 0.85rem;
}

.expected {
  color: var(--muted);
}

.counted {
  color: var(--success);
  font-weight: 600;
}

.pending-text {
  color: var(--warning);
  font-style: italic;
}

.variance.positive {
  color: var(--success);
  font-weight: bold;
}

.variance.negative {
  color: var(--danger);
  font-weight: bold;
}

.count-type-btn .btn-text {
  color: var(--fg) !important;
}

.count-type-btn small {
  color: var(--muted) !important;
}

.count-setup h4 {
  color: var(--fg) !important;
}

.scan-info h4 {
  color: var(--fg) !important;
}

.scan-info p {
  color: var(--muted) !important;
}

.summary-label {
  color: var(--muted) !important;
}

.summary-value {
  color: var(--fg) !important;
}

.count-info h4, .history-info h4 {
  color: var(--fg) !important;
}

.count-date, .history-date {
  color: var(--muted) !important;
}

.history-stats {
  color: var(--muted) !important;
}

.modal-header h3 {
  color: var(--fg) !important;
}

.location-verification label {
  color: var(--fg) !important;
}

.modal-actions {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 30px;
}

.action-btn.warning {
  background: #ff6b35;
  color: white;
}

.action-btn.warning:hover {
  background: #e55722;
}

@media (max-width: 768px) {
  .count-type-buttons {
    grid-template-columns: 1fr;
  }
  
  .count-item, .history-item {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .scan-actions {
    flex-direction: column;
  }
  
  .modal-actions {
    flex-direction: column;
  }
}
</style>
</body>
</html>